C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE ACTIVITYFUNCTIONS
OBJECT MODULE PLACED IN ..\OBJ\ActivityFunctions.obj
COMPILER INVOKED BY: D:\Keil4\C51\BIN\C51.EXE ..\CODE\ActivityFunctions.c LARGE OBJECTADVANCED OPTIMIZE(9,SIZE) BROWSE O
                    -RDER NOAREGS INCDIR(..\HARDWARE\ds1302;..\HARDWARE\ds18b20;..\HARDWARE\lcd;..\HARDWARE\RX8010;..\HARDWARE\sht21;..\HARDW
                    -ARE\sht31;..\HARDWARE\w25x;..\SYSTEM\delay;..\SYSTEM\stc_eeprom;..\SYSTEM;..\CODE) DEBUG PRINT(.\ActivityFunctions.lst) 
                    -TABS(2) OBJECT(..\OBJ\ActivityFunctions.obj)

line level    source

   1          /* VHB15AÊª»¯Æ÷*/ 
   2          
   3          #include "all.h"
   4          
   5          //2019.03.29
   6          sfr P4M0 = 0xB4; 
   7          sfr P4M1 = 0xB3;
   8          sfr P4SW = 0xBB;
   9          sfr WDT_CONTR = 0xC1;
  10          sbit EA  = (uint8_t)0xA8^(uint8_t)7;
  11          sbit EX1 = (uint8_t)0xA8^(uint8_t)2;
  12          sbit ET0 = (uint8_t)0xA8^(uint8_t)1;
  13          sfr P1M0 = 0x92; 
  14          sfr P1M1 = 0x91;
  15          //sbit P10 = (uint8_t)0x90^(uint8_t)0;
  16          sbit P10 = (uint8_t)0x90;
  17          sbit P12 = (uint8_t)0x90^(uint8_t)2;
  18          sbit P13 = (uint8_t)0x90^(uint8_t)3;
  19          sbit P17 = (uint8_t)0x90^(uint8_t)7;
  20          //sbit P20 = (uint8_t)0xA0^(uint8_t)0;
  21          sbit P20 = (uint8_t)0xA0;
  22          sbit P21 = (uint8_t)0xA0^(uint8_t)1;
  23          sbit P22 = (uint8_t)0xA0^(uint8_t)2;
  24          sbit P27 = (uint8_t)0xA0^(uint8_t)7;
  25          sfr P2M0 = 0x96;
  26          sfr P2M1 = 0x95;
  27          sbit P32 = (uint8_t)0xB0^(uint8_t)2;
  28          sbit P34 = (uint8_t)0xB0^(uint8_t)4;
  29          sbit P35 = (uint8_t)0xB0^(uint8_t)5;
  30          sbit P36 = (uint8_t)0xB0^(uint8_t)6;
  31          sbit P37 = (uint8_t)0xB0^(uint8_t)7;
  32          sfr P3M0 = 0xB2;
  33          sfr P3M1 = 0xB1; 
  34          //sbit P40 = (uint8_t)0xC0^(uint8_t)0;
  35          sbit P40 = (uint8_t)0xC0;
  36          sbit P43 = (uint8_t)0xC0^(uint8_t)3;
  37          sbit TI  = (uint8_t)0x98^(uint8_t)1;
  38          //sbit RI  = (uint8_t)0x98^(uint8_t)0;
  39          sbit RI  = (uint8_t)0x98;
  40          sbit TR0 = (uint8_t)0x88^(uint8_t)4;
  41          sbit IT1 = (uint8_t)0x88^(uint8_t)2;
  42          
  43          static void  Interrupt_EXT1(void);
  44          static void  Interrupt_Time0(void);
  45          static void  Serial (void);   //´®¿ÚÖÐ¶Ï
  46          
  47          
  48          //static enum  //heating wire mode
  49          //{ 
  50          //  Wire_Sel_Double = 0,  //double heating wire
  51          //  Wire_Sel_In_Only,     //INSP Only heating wire
  52          //  Wire_Sel_None       //Whithout heating wire
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 2   

  53          //}Wire_Mode_Sel; 
  54          static WIRE_MODE_SEL Wire_Mode_Sel=Wire_Sel_Double;
  55              
  56          //´íÎó¼ì²âºÍ±¨¾¯Ïà¹Ø±äÁ¿  
  57          uint8_t  ERR_Kind=0;//´íÎóµÄÖÖÀà//0´«¸ÐÆ÷/1¸ßÎÂ/2µÍÎÂ/3µÍÊª/4ÎÞË®/5»¼Õß´«¸ÐÆ÷/6³öÆø¿Ú´«¸ÐÆ÷/7¼ÓÈÈÅÌ´«¸ÐÆ÷ 
             -  
  58          uint8_t Wire_Mode_Mismatch ; //»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä   
  59          static uint8_t JRP_Sensor_Err=0;
  60          static uint8_t CQK_Sensor_Err=0;
  61          static uint8_t RTD_Sensor_Err=0;
  62          static uint8_t SHIDU_Sensor_Err=0;    
  63              
  64          uint8_t AlarmSoundPauseStatus = 0;//±¨¾¯ÉùÒôÔÝÍ£ 0-Õý³£±¨¾¯ 1-±¨¾¯ÉùÒôÔÝÍ£(½ö±¨¾¯Ê±ÓÐÐ§)
  65          uint8_t AlarmInfoIndex = 0;//
  66                    
  67          static uint8_t    HiTemp_Count=0;   //¸ßÎÂ¶È´ÎÊý
  68          static uint8_t    LoTemp_Count=0;     //µÍÎÂ¶È´ÎÊý
  69          static uint8_t    LoTemp_CQK_Count=0;//³öÆø¿ÚµÍÎÂ¶È´ÎÊý
  70          static uint8_t    LoHumity_Count=0;  //µÍÊª¶È´ÎÊý
  71          
  72          uint8_t No_HeatSensor_Times=0;//¼ÓÈÈÅÌÎÂ¶È´«¸ÐÆ÷ÎÞÏìÓ¦´ÎÊý
  73          static uint16_t  No_CQKSensor_Times=0;//³öÆø¿ÚÎÂ¶È´«¸ÐÆ÷ÎÞÏìÓ¦´ÎÊý
  74          static uint16_t  CQKSensor_Hithen800_Times=0;//³¬¹ý80¶È
  75          static uint16_t  JRP_Sensor_Temp_No_Change_Times=0;// ¼ÓÈÈÅÌÎÂ¶ÈÍêÈ«²»±äµÄ´ÎÊý2014-07-03
  76          static uint16_t  CQK_Sensor_Temp_No_Change_Times=0;// ³öÆø¿ÚÎÂ¶ÈÍêÈ«²»±äµÄ´ÎÊý    
  77          static uint8_t ERR_RT_Temp_Times=0;//»¼ÕßÎÂ¶È³¬¹ý80¶È
  78          static uint8_t No_ReadData_SHIDU_Times=0;//»¼Õß¶ËÎÂ¶ÈÎÞÏìÓ¦´ÎÊý
  79          static uint16_t  RT_Temp_Not_Updated_10mS = 0;//Á¬ÐøÎ´²ÉÑùµ½Êý¾ÝµÄÊ±¼ä
  80          static uint8_t No_ReadData_Temp_Times=0;//³öÆø¿ÚÎÂ¶ÈÎÞÏìÓ¦´ÎÊý
  81          static uint16_t  Nochange_Times=0;//»¼Õß¶ËÎÂÊª¶ÈÍêÈ«²»±äµÄ´ÎÊý
  82          
  83          uint8_t RT_Temp_Reach_Set_Cnt = 0;//ÈËÌåÎÂ¶È´ïµ½Éè¶¨ÎÂ¶È-1.5
  84          uint8_t CQK_Temp_Reach_Set_Cnt = 0;//³öÆø¿ÚÎÂ¶È´ïµ½30
  85          
  86          uint8_t show_str[23]; 
  87          
  88          static uint8_t   Work_Day=0;
  89          static uint8_t   Work_Hour=0;
  90          static uint8_t   Work_Min=0;
  91          static uint8_t   Work_Sec=0;
  92          
  93          //´æ´¢Ïà¹Ø
  94          struct stc_data_flash data_flash;//
  95          static uint16_t  Run_Count;
  96          uint8_t    SaveData[16];
  97                                              
  98          //´®¿ÚÏà¹Ø±äÁ¿                                    
  99          //static bit Buff_Full_flag;    
 100          static uint8_t   Rec_Count=0;
 101          //static BYTE    Rec_Buff[21];          //½ÓÊÕµ½µÄÖ¸ÁîREAD0001[CR]-READ0200[CR];
 102                                              //Ò»ÌõÖ¸Áî¿É½ÓÊÕ256ÌõÊý¾Ý                                   
 103          static uint16_t   Tick_20ms=0;
 104          uint8_t defalut_mode = Load_User_Pre_MODE;  //Ô¤ÉèÄ£Ê½Ñ¡Ôñ
 105          
 106          //ÊµÊ±²ÎÊý
 107          INT             RT_Temp=0;            //ÈËÌå¶ËÎÂ¶È
 108          INT             JEP_Temp=280;           //¼ÓÈÈÅÌÎÂ¶È
 109          LONG              CQK_Temp=280;           //³öÆø¿ÚÎÂ¶È
 110          static uint16_t     RT_SHIDU=0;             //ÈËÌå¶ËÊª¶È
 111          static uint16_t     CONTROL_RT_SHIDU=550;     //¿ØÖÆ¼ÓÈÈµÄÊª¶È
 112          uint16_t     Diplay_RTtemp = 0;
 113          
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 3   

 114          //Éè¶¨²ÎÊý    
 115          uint8_t         Work_Mode = Invasive_Mode; //Ä¬ÈÏ1ÎªÓÐ´´Ä£Ê½ £¬0ÎªÎÞ´´Ä£Ê½£¬2£¬¼òÒ×Ä£Ê½(ÎÞ·¢ÈÈË¿)       
 116          INT                   Set_RT_Temp=390;         //ÈËÌå¶ËÎÂ¶ÈÉè¶¨Öµ       
 117          uint16_t          Set_RT_WCTemp=340;       //ÈËÌåÎÞ´´ÎÂ¶È
 118          uint16_t          Set_RT_YCTemp=390;       //ÈËÌåÓÐ´´ÎÂ¶È
 119          uint16_t          Set_CQK_Temp=370;        //³öÆø¿ÚÎÂ¶È
 120          uint16_t          Set_CQK_WCTemp=310;      //ÈËÌåÎÞ´´ÎÂ¶È
 121          uint16_t          Set_CQK_YCTemp=370;      //ÈËÌåÓÐ´´ÎÂ¶È
 122          uint8_t         In_Exp_Ratio=4;  //InºÍExp¼ÓÈÈ·½Ê½µÄ±ÈÀý  //1-1:1 2-1:1.1 3-1:1.2 4-1:1.3 5-1:1.4 6-1:1.5
 123          
 124          //¼ÓÈÈÅÌÇý¶¯ºÍ¼ì²â
 125          uint16_t          HP_CNT_Int = 0;//¼ÓÈÈÅÌÖÐ¶Ï¼ì²â¼ÆÊý
 126          uint16_t          HP_CNT_Int_End_Rem = 0;//8S½áÊøÊ±¼ÓÈÈÅÌÖÐ¶Ï¼ì²â¼ÆÊý
 127          uint8_t         WireIn_State=0;      //¼ÓÈÈÏßIn×´Ì¬ 1-ÓÐ 0-ÎÞ
 128          uint8_t         WireOut_State=0;     //¼ÓÈÈÏßOut×´Ì¬    1-ÓÐ 0-ÎÞ
 129          uint8_t         HeaterPlate_State = 0; //¼ÓÈÈÅÌ×´Ì¬ 1-ÓÐ 0-ÎÞ
 130          
 131          uint8_t         Micro_Temp_Val=0;   //¼ÓÈÈÅÌ×î´óÎª201;×îÐ¡Îª0,1±íÊ¾10ms¼ÓÈÈÊ±¼ä
 132          uint16_t          Micro_Temp_In=0;    //½øÆøÖ§
 133          uint16_t          Micro_Temp_Out=0;   //³öÆøÖ§
 134          
 135          //¿ØÖÆ²ÎÊý
 136          static uint16_t   Aim_SHIDU=900;  //Ä¿±êÊª¶È 
 137          static INT    JEP_Temp_Aim=400;           //¼ÓÈÈÅÌÄ¿±êÎÂ¶È
 138          static uint16_t Wire_Warm_Up_Sec;    //µ±<=300Ê±ÏÞÖÆ·¢ÈÈË¿×î´ó¼ÓÈÈ¹¦ÂÊ
 139          static uint16_t Plate_Warm_Up_Sec;   //µ±<=600Ê±ÏÞÖÆ·¢ÈÈÅÌ×î´ó¼ÓÈÈ¹¦ÂÊ
 140          static uint16_t Humidity_No_Change_Sec;//Êª¶È²»¸Ä±äµÄ¼ÆÊý£¬µ±´óÓÚ600Ê±¿ÉÄÜÌ½Í·Ê§Ð§£¬Êª¶È¿ØÖÆÊ§Ð§
 141          static uint16_t Low_Power_Mode_Flag = 0;//µÍ¹¦ÂÊÄ£Ê½Ê¹ÄÜ±êÖ¾
 142          
 143          uint8_t     Test_Mode_Dis_Jrp_Ctl=0; //´Ó²âÊÔÄ£Ê½½øÈëÕý³£Ä£Ê½¼´ÏÔÊ¾ËùÓÐ¹¤×÷Êý¾Ý 
 144          static uint8_t     Micro_Adj_Mode_Test;  //¼ÓÈÈµÄÄ£Ê½²âÊÔ
 145          uint16_t      Working_Normal=0;//Õý³£¹¤×÷¶ÁÊý£¬Ã¿Ãë¼Ó1£¬¹ÊÕÏÖØÖÃ£¬¸Ä±äÉèÖÃÒ²ÖØÖÃ
 146          
 147          static struct 
 148          {
 149            INT Uk; //×ÜµÄ¿ØÖÆÁ¿
 150          //  int Uk1;//ÉÏ´ÎµÄ×Ü¿ØÖÆÁ¿
 151            INT Sum_error;//Îó²î×ÜÁ¿
 152            INT Ek;//µ±Ç°µÄÎó²îÁ¿
 153            INT Ek1;//Ç°Ò»´ÎµÄÎó²îÁ¿
 154            INT Ek2;//Ç°¶þ´ÎµÄÎó²îÁ¿       
 155          }Controler_temp,Controler_temp2,Controler_temp3;//¶¨ÒåÒ»¸öÎÂ¶ÈControler½á¹¹
 156          
 157          //static CONTROLLER_TEMP Controler_temp;
 158          //static CONTROLLER_TEMP Controler_temp2;
 159          //static CONTROLLER_TEMP Controler_temp3;
 160          
 161          
 162           //Ãë    ·Ö    Ê±    ÈÕ    ÔÂ  ÐÇÆÚ    Äê
 163          static BYTE   NowTime[7]= {0x00, 0x00, 0xB2, 0x01, 0x01, 0x05, 0x12};
 164          
 165          //uint8_t Alarm_time_det_10mS_cnt = 0;
 166          
 167          //================================================== 
 168          
 169          static void Store_Data(void);           //´æ·ÅÊý¾Ý
 170          static void Get_RunCount(void);         //´æ·ÅÊý¾Ý
 171          //static void Init_Erase_Flash_Data(void);//³õÊ¼»¯Ê±²Á³ýÍâ²¿FLASHÊý¾Ý
 172          //static void Init_port(void); //³õÊ¼»¯¶Ë¿Ú×´Ì¬£¬ÏÔÊ¾°æ±¾ºÅ£¬¶ÁÈ¡Êý¾Ý£¬ÆÁÄ»²âÊÔ£¬W25XÇåÊý¾Ý
 173          // void Main_Init(void);  //µÃµ½´æ·ÅÊý¾ÝµÄÌõÊý,»­¹¤×÷´°¿Ú,Ê¹ÄÜä¸Á÷³äµç,RTC¼ì²â,ÆäËü±äÁ¿³õÊ¼»¯
 174          static void Write_Default_Setting_to_flash(void); //°ÑÄ¬ÈÏ³ö³§Éè¶¨Ð´ÈëFLASH
 175          //static void LCD_Show_Verion(void);//ÏÔÊ¾°æ±¾ºÅ
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 4   

 176          static void PatientTemp_NoneHeatWire_Adj(void);//ÎÞ»ØÂ··¢ÈÈË¿Ê±µÄ»¼Õß¶ËÎÂ¶Èµ÷½Ú
 177          static void Controler_Calc(void); //ControlerËã·¨
 178          static void HeatPlateTemp_Aim_Controler_Calc(void); //¼ÓÈÈÅÌÄ¿±êÎÂ¶ÈControlerËã·¨---
 179          static void HeatPlate_Controler_Calc(void);//¼ÓÈÈÅÌµÄControlerËã·¨---
 180          
 181          
 182          static void  Clear_bit(uint8_t* Value,INT bit_num) 
 183          {
 184   1        uint8_t* pV=Value;
 185   1        (*pV) =(*pV)& ( ~ ( (uint16_t)1 << (uint16_t)(bit_num) ) );
 186   1      }
 187          static void  Set_bit(uint8_t* Value,INT bit_num)
 188          {
 189   1        uint8_t* pV=Value;
 190   1        (*pV) =(*pV)| ( (uint16_t)1 << (uint16_t)(bit_num) );
 191   1      }
 192          
 193          uint8_t  Bit_is_one(uint8_t Value,INT bit_num)
 194          {
 195   1        return ( (Value) & ((uint16_t)1<< (uint16_t)(bit_num) ) );
 196   1      }
 197          
 198          
 199          
 200          static void  Interrupt_EXT1(void)  interrupt 2  //Íâ²¿ÖÐ¶ÏEXT1
 201          {
 202   1        HP_CNT_Int++; 
 203   1      }
 204          
 205          static void  Interrupt_Time0(void)  interrupt 1  using  2  //10msÖÐ¶ÏÒ»´Î //22.1184M
 206          {   
 207   1        Timer_T0_INT_Main();
 208   1        Tick_20ms++;
 209   1      }
 210          
 211          static void  Serial (void) interrupt 4 using 1    //´®¿ÚÖÐ¶Ï
 212          {
 213   1        if(RI)
 214   1        {
 215   2          EUSART_Receive_ISR();
 216   2      
 217   2          RI = 0;
 218   2        }
 219   1      
 220   1        if(TI)
 221   1        {     
 222   2          EUSART_Transmit_ISR();
 223   2          TI = 0;
 224   2        }
 225   1      }
 226          
 227          
 228          
 229          static UART_RECSTATE UART_RecState=UART_REC_STATE_READY;
 230          
 231          //static enum
 232          //{
 233          //  UART_REC_STATE_READY = 0, //×¼±¸½ÓÊÕ,³õÊ¼»¯¼ÆÊý,  1
 234          //  UART_REC_STATE_HEADER_DET,//¼ì²âÃüÁîÍ· "NEUNIT=1," ¹²9¸ö×Ö·û 
 235          //  UART_REC_STATE_DATA_TAIL_DET,//½ÓÊÕÃüÁî(×î¶à9¸ö×Ö·û)£¬¼ì²âÃüÁîÎ²"\CR"¹²3¸ö×Ö·û 
 236          //  UART_REC_STATE_DONE //½ÓÊÕÕýÈ·Íê³É
 237          //}UART_RecState = UART_REC_STATE_READY;
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 5   

 238          
 239          
 240          static uint8_t   UART_Rec_Buf[20];//½ÓÊÕ»º³åÇø 
 241           
 242          static void UART_RecBuf_Clear_Fun(void)  //Çå¿Õ»º³åÇø
 243          {
 244   1        INT i;
 245   1      
 246   1        for(i=0;i<=19;i++)
 247   1        {
 248   2          UART_Rec_Buf[i] = 0;        
 249   2        } 
 250   1      }
 251          
 252          //½ÓÊÕÊý¾Ý
 253          //static uint8_t   DataToPc[8];
 254          void UART_RecData_Func(void)
 255          {
 256   1        static uint8_t   UART_Rec_Cnt = 0;//½ÓÊÕÊý¾ÝÊýÁ¿ 
 257   1        //    static uint8_t UART_Len = 0;//½ÓÊÕµÄÊý¾Ý³¤¶È
 258   1        uint8_t   i;
 259   1        uint8_t   uart_data;    
 260   1        UINT32   Adress;
 261   1        //    uint16_t    sum;
 262   1        
 263   1        while(EUSART_DataReady!=(uint8_t)0)//»º³åÇøÓÐÊý¾Ý
 264   1        {
 265   2          uart_data = EUSART_Read(); //´Ó»º³åÇø¶ÁÒ»¸öÊý¾Ý
 266   2          
 267   2          if(Work_State == UI_STATE_DATAREADER_MODE)
 268   2          {
 269   3            UART_Rec_Cnt++;//ÊýÁ¿Ôö¼Ó
 270   3            if(UART_RecState == UART_REC_STATE_READY)//¿ªÊ¼
 271   3            {
 272   4              UART_RecState = UART_REC_STATE_HEADER_DET;           
 273   4              UART_RecBuf_Clear_Fun();//Çå¿Õ»º³åÇø
 274   4              UART_Rec_Buf[0] = uart_data;//³õÊ¼½ÓÊÕ
 275   4              UART_Rec_Cnt = (uint8_t)1; //ÊýÁ¿
 276   4              //EUSART_Write('A');
 277   4            }
 278   3            else if(UART_RecState == UART_REC_STATE_HEADER_DET)//¼ì²â½ÓÊÕÍ·
 279   3            {//×¢Òâ:×îÖÕ8¸ö×Ö½Ú´æ·ÅµÄË³ÐòÊÇÏÈÊÕµ½µÄÔÚ×îµÍÎ»£¬Àý:ÊÕµ½µÄÊÇAXXLOGET£¬´æ·ÅµÄÊÇTEGOLXXA
 280   4              UART_Rec_Buf[UART_Rec_Cnt-1] = uart_data;//´ÓµÍ×Ö½ÚÍù¸ß×Ö½Ú´æ·Å
 281   4              if(UART_Rec_Cnt>=(uint8_t)3)//½ÓÊÕµ½3¸öÊý¾Ý RD 13
 282   4              {
 283   5                if((UART_Rec_Buf[0] == (uint8_t)'R')//Í·±êÖ¾ÅÐ¶Ï
 284   5                  &&(UART_Rec_Buf[1] == (uint8_t)'D'))
 285   5                {
 286   6              //              EUSART_Write_Str("HEAR_OK",7);
 287   6                  UART_RecState = UART_REC_STATE_DATA_TAIL_DET;//±êÖ¾OK£¬½ÓÊÕÊý¾Ý
 288   6                  UART_RecBuf_Clear_Fun();//Çå¿Õ»º³åÇø  
 289   6                  UART_Rec_Cnt = (uint8_t)0; //ÊýÁ¿
 290   6                }
 291   5                else
 292   5                {
 293   6                  UART_Rec_Cnt--;//ÍùµÍÎ»ÒÆ
 294   6                  for(i=0;i<=(uint8_t)18;i++) //Êý¾ÝÍùµÍÎ»ÒÆÒ»Î»
 295   6                  {
 296   7                     UART_Rec_Buf[i] = UART_Rec_Buf[i+1];        
 297   7                  }//×¢Òâ:×îÖÕ8¸ö×Ö½Ú´æ·ÅµÄË³ÐòÊÇÏÈÊÕµ½µÄÔÚ×îµÍÎ»£¬Àý:ÊÕµ½µÄÊÇAXXLOGET£¬´æ·ÅµÄÊÇTEGOLXXA              
             - 
 298   6                }
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 6   

 299   5              } 
 300   4            }
 301   3            else if(UART_RecState == UART_REC_STATE_DATA_TAIL_DET)//¼ì²âÊý¾ÝºÍ½áÎ²
 302   3            {
 303   4              UART_Rec_Buf[UART_Rec_Cnt-1] = uart_data;//´ÓµÍ×Ö½ÚÍù¸ß×Ö½Ú´æ·Å
 304   4      
 305   4              if(UART_Rec_Cnt>=(uint8_t)2)//×î¶à´æ·Å15¸öÊý¾Ý
 306   4              { 
 307   5                UART_RecState = UART_REC_STATE_DONE;//½ÓÊÕÍê³É        
 308   5              }
 309   4            }
 310   3            else
 311   3            {
 312   4              //do nothing
 313   4            }
 314   3              
 315   3            if(UART_RecState == UART_REC_STATE_DONE)//¼ì²âµ½Î²±êÖ¾
 316   3            {
 317   4              UART_RecState = UART_REC_STATE_READY; //×¼±¸ÏÂÒ»´Î¼ì²â
 318   4              
 319   4              Adress=UART_Rec_Buf[0];
 320   4              Adress=(Adress<<8)+UART_Rec_Buf[1]-1;
 321   4              Adress=(Adress<<4)+0x2000;
 322   4              SPI_Read_nBytes(Adress,16,&SaveData[0]);
 323   4              EUSART_Write_Str(&SaveData[0],16);//·¢ËÍ16¸ö×Ö½Ú¸øPC
 324   4            }           
 325   3          }
 326   2        }
 327   1      }
 328          
 329          void HeaterWireModeDetFunc(void)
 330          {
 331   1        if(Wire_Mode_Sel == Wire_Sel_Double)//Ë«Ö§¼ÓÈÈ»ØÂ·µ«Êµ¼ÊÎ´¼ì²âµ½IN»òOUT          
 332   1        {
 333   2          if((WireIn_State == (uint8_t)0)||(WireOut_State == (uint8_t)0)) 
 334   2          {
 335   3            Wire_Mode_Mismatch = (uint8_t)1;//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä±êÖ¾
 336   3          }
 337   2          else
 338   2          {
 339   3            Wire_Mode_Mismatch = (uint8_t)0;//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä±êÖ¾
 340   3          }
 341   2        } 
 342   1        else if(Wire_Mode_Sel == Wire_Sel_In_Only)  //µ¥Ö§¼ÓÈÈ»ØÂ·µ«Êµ¼ÊÎ´¼ì²âµ½IN»ò¼ì²âµ½ÓÐOUT    
 343   1        {
 344   2          if((WireIn_State == (uint8_t)0)||(WireOut_State > (uint8_t)0))  
 345   2          {
 346   3            Wire_Mode_Mismatch = (uint8_t)1;//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä±êÖ¾
 347   3          }
 348   2          else
 349   2          {
 350   3            Wire_Mode_Mismatch = (uint8_t)0;//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä±êÖ¾
 351   3          }
 352   2        }
 353   1        else if(Wire_Mode_Sel == Wire_Sel_None) //ÎÞ¼ÓÈÈ»ØÂ·µ«Êµ¼Ê¼ì²âµ½ÓÐIN»òOUT
 354   1        {
 355   2          if((WireIn_State > (uint8_t)0)||(WireOut_State > (uint8_t)0)) 
 356   2          {
 357   3            Wire_Mode_Mismatch = (uint8_t)1;//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä±êÖ¾
 358   3          }
 359   2          else
 360   2          {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 7   

 361   3            Wire_Mode_Mismatch = (uint8_t)0;//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä±êÖ¾
 362   3          }
 363   2        }
 364   1        else
 365   1        {
 366   2          //do nothing
 367   2        }
 368   1      }
 369          
 370          void RefreshTempHumidyFunc(uint8_t Refresh_En)//Ë¢ÐÂÏÔÊ¾ÎÂ¶ÈºÍÊª¶È
 371          {
 372   1        static uint8_t     Refresh_WenDu_Cnt = 0; 
 373   1        static uint8_t     Alarm_WenDu_Cnt = 0; 
 374   1      
 375   1        uint16_t Disp=0,color=0;
 376   1        uint16_t Temp_Dis_En = 0;//ÎÂ¶ÈÏÔÊ¾±êÖ¾
 377   1        uint8_t Disp_Err;
 378   1      
 379   1        Refresh_WenDu_Cnt++;
 380   1        if(Refresh_WenDu_Cnt > (uint8_t)5)//1.2S
 381   1        {
 382   2          Refresh_WenDu_Cnt = (uint8_t)0; 
 383   2        }
 384   1        
 385   1        Alarm_WenDu_Cnt++;
 386   1        if(Alarm_WenDu_Cnt > (uint8_t)1)
 387   1        {
 388   2          Alarm_WenDu_Cnt = (uint8_t)0;
 389   2        }
 390   1          
 391   1        
 392   1        Back_Color=WHITE18; 
 393   1        Disp_Err=(uint8_t)0;
 394   1      
 395   1      //  Temp_Dis_En = 0;//ÎÂ¶ÈÏÔÊ¾±êÖ¾
 396   1        if(Refresh_En!=(uint8_t)0)
 397   1        {
 398   2          Temp_Dis_En = (uint16_t)1;//Ç¿ÖÆË¢ÐÂÒ»´Î  
 399   2        }
 400   1      
 401   1        color=BLACK18;
 402   1        if((Bit_is_one(ERR_Kind,Alarm_Const_HiTemp)!=(uint8_t)0)   //»¼Õß¶Ë¸ßÎÂºìÉ«
 403   1          &&(Display_Temp_Kind==DISPLAY_Temperature_Patient))
 404   1        {
 405   2           Temp_Dis_En = (uint16_t)1;//ÎÂ¶ÈÏÔÊ¾±êÖ¾
 406   2           color=RED18; 
 407   2            if(Alarm_WenDu_Cnt == (uint8_t)1)
 408   2            {
 409   3              color=WHITE18;
 410   3            }
 411   2        }
 412   1        else if(((Bit_is_one(ERR_Kind,Alarm_Const_LoTemp)!=(uint8_t)0)&&((u8)Display_Temp_Kind==(u8)0))  //»¼Õß¶Ë
             -µÍÎÂºìÉ«
 413   1               ||((LoTemp_CQK_Count>120)&&(Display_Temp_Kind==(DISPLAY_Temp_Kind)1)))  //³öÆø¿ÚµÍÎÂºìÉ«
 414   1        {
 415   2          Temp_Dis_En = (uint16_t)1;//ÎÂ¶ÈÏÔÊ¾±êÖ¾
 416   2          color=RED18;
 417   2          if(Alarm_WenDu_Cnt == (uint8_t)1)
 418   2          {
 419   3            color=WHITE18;
 420   3          }
 421   2        }
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 8   

 422   1        else
 423   1        {
 424   2          if(Refresh_WenDu_Cnt == (uint8_t)0)
 425   2          {
 426   3            Temp_Dis_En = (uint16_t)1;//ÎÂ¶ÈÏÔÊ¾±êÖ¾
 427   3          }
 428   2        }
 429   1          
 430   1        if(Temp_Dis_En == (uint16_t)1)
 431   1        {     
 432   2          if(Display_Temp_Kind==DISPLAY_Temperature_Chamber)//³öÆø¿ÚÎÂ¶È
 433   2          {
 434   3            Disp=(uint16_t)CQK_Temp;
 435   3            Disp_Err=CQK_Sensor_Err; 
 436   3          }
 437   2          else if(Display_Temp_Kind==DISPLAY_Temperature_Patient) //ÈËÌå¶ËÎÂ¶È
 438   2          {
 439   3            Disp=Diplay_RTtemp;
 440   3            Disp_Err=RTD_Sensor_Err;
 441   3          }
 442   2          else
 443   2          {
 444   3            //do nothing
 445   3          }
 446   2          
 447   2          if(Disp_Err!=(uint8_t)0)
 448   2          {
 449   3             Draw_Rectangle_Real((POS_RT_TEMP_X+4),(POS_RT_TEMP_Y),(POS_RT_TEMP_X+56),(POS_RT_TEMP_Y+103),(WHITE18)
             -);     
 450   3             Draw_Rectangle_Real(POS_RT_TEMP_X,POS_RT_TEMP_Y,POS_RT_TEMP_X+3,POS_RT_TEMP_Y+29,RED18);
 451   3             Draw_Rectangle_Real(POS_RT_TEMP_X,POS_RT_TEMP_Y+34,POS_RT_TEMP_X+3,POS_RT_TEMP_Y+63,RED18);
 452   3             Draw_Rectangle_Real(POS_RT_TEMP_X,POS_RT_TEMP_Y+73,POS_RT_TEMP_X+3,POS_RT_TEMP_Y+102,RED18);
 453   3             //Draw_Rectangle_Real(POS_RT_TEMP_X+1,POS_RT_TEMP_Y+67,POS_RT_TEMP_X+8,POS_RT_TEMP_Y+71,RED18); //»­µã
             -  
 454   3          }
 455   2          else  if(Disp>=(uint16_t)1000)//ÏÔÊ¾ÎÂ¶È
 456   2          {
 457   3            DISP_TEMP_30X56(POS_RT_TEMP_X,POS_RT_TEMP_Y,(Disp/1000)%10,(uint8_t)color);  
 458   3            DISP_TEMP_30X56(POS_RT_TEMP_X,POS_RT_TEMP_Y+34,(uint8_t)((Disp%1000)/100),(uint8_t)color);   
 459   3            DISP_TEMP_30X56(POS_RT_TEMP_X,POS_RT_TEMP_Y+73,(Disp%100)/10,(uint8_t)color);    
 460   3            Draw_Rectangle_Real(POS_RT_TEMP_X+1,POS_RT_TEMP_Y+67,POS_RT_TEMP_X+8,POS_RT_TEMP_Y+71,(uint8_t)WHITE18)
             -; //È¥µôÐ¡Êýµã
 461   3          }
 462   2          else
 463   2          {
 464   3            DISP_TEMP_30X56(POS_RT_TEMP_X,POS_RT_TEMP_Y,(Disp/100)%10,(uint8_t)color);  
 465   3            DISP_TEMP_30X56(POS_RT_TEMP_X,POS_RT_TEMP_Y+34,Disp%100/10,(uint8_t)color);   
 466   3            DISP_TEMP_30X56(POS_RT_TEMP_X,POS_RT_TEMP_Y+(34*2)+5,Disp%10,(uint8_t)color);    
 467   3            Draw_Rectangle_Real(POS_RT_TEMP_X+1,POS_RT_TEMP_Y+67,POS_RT_TEMP_X+8,POS_RT_TEMP_Y+71,(uint8_t)color); 
             -//»­µã
 468   3          }
 469   2         }     
 470   1           
 471   1        //ÏÔÊ¾Êª¶È
 472   1        color=BLACK18;
 473   1        if((Bit_is_one(ERR_Kind,Alarm_Const_LoHumity))!=(uint8_t)0)   //µÍÊª¶È±¨¾¯
 474   1        {
 475   2          Temp_Dis_En = (uint16_t)1;//ÎÂ¶ÈÏÔÊ¾±êÖ¾
 476   2          color=RED18;
 477   2          if(Alarm_WenDu_Cnt == (uint8_t)1)
 478   2          {
 479   3            color=WHITE18;
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 9   

 480   3          }
 481   2        }
 482   1        else
 483   1        {
 484   2          if(Refresh_WenDu_Cnt == (uint8_t)0)
 485   2          {
 486   3            Temp_Dis_En = (uint16_t)1;//ÎÂ¶ÈÏÔÊ¾±êÖ¾  
 487   3          }     
 488   2        }
 489   1            
 490   1        if(Temp_Dis_En == (uint16_t)1)
 491   1        {
 492   2          if(RTD_Sensor_Err!=(uint8_t)0)
 493   2          {     
 494   3            Draw_Rectangle_Real(POS_RT_RH_X+4 , POS_RT_RH_Y,POS_RT_RH_X+39,POS_RT_RH_Y+35,(uint8_t)WHITE18);   
 495   3            Draw_Rectangle_Real(POS_RT_RH_X , POS_RT_RH_Y,POS_RT_RH_X+3,POS_RT_RH_Y+16,(uint8_t)RED18);     
 496   3            Draw_Rectangle_Real(POS_RT_RH_X , POS_RT_RH_Y+19,POS_RT_RH_X+3,POS_RT_RH_Y+35,(uint8_t)RED18);       
 497   3          }
 498   2          else
 499   2          { 
 500   3            DISP_RH_17X40(POS_RT_RH_X,POS_RT_RH_Y,(uint8_t)(RT_SHIDU%1000/100),(uint8_t)color);
 501   3            DISP_RH_17X40(POS_RT_RH_X,POS_RT_RH_Y+19,RT_SHIDU%100/10,(uint8_t)color);
 502   3          }
 503   2        } 
 504   1      }
 505          
 506          //---------Ë¢ÐÂÔËÐÐÊ±¼ä
 507          void RefreshRunTimeFunc(uint8_t Refresh_En)
 508          //Refresh_En 1-Ç¿ÖÆË¢ÐÂÒ»´Î£¬·ñÔòÃ¿·ÖÖÓË¢ÐÂÒ»´Î
 509          { 
 510   1        uint8_t t=0;
 511   1      //  uint8_t refreshEn=Refresh_En;
 512   1        static uint8_t Last_Sec = 60;   
 513   1        
 514   1        RX8010_GetTime(NowTime);  
 515   1        t = ((uint8_t)NowTime[0]&(uint8_t)0xF)%10;
 516   1        
 517   1        if(t != Last_Sec)//Ê±¼äÃëÓÐ±ä»¯
 518   1        {
 519   2          Last_Sec = t;
 520   2          if(Work_Sec<59)
 521   2          {
 522   3            Work_Sec++;
 523   3          }
 524   2          else
 525   2          {
 526   3            Work_Sec = 0;
 527   3            t = 0xff;//Ë¢ÐÂ±êÖ¾   
 528   3            if(Work_Min<59)
 529   3            {
 530   4              Work_Min++;
 531   4            }
 532   3            else
 533   3            {
 534   4              Work_Min=0;
 535   4              if(Work_Hour<23)
 536   4              {
 537   5                Work_Hour++;
 538   5              }else
 539   4              {
 540   5                Work_Hour=0;
 541   5                if(Work_Day<99)
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 10  

 542   5                {
 543   6                  Work_Day++;
 544   6                }           
 545   5              }
 546   4            }
 547   3          }
 548   2        }
 549   1        
 550   1        if((Refresh_En!=(uint8_t)0)||(t == 0xff))
 551   1        {
 552   2      //    Refresh_En = 0;   
 553   2          if(Work_State != UI_STATE_SCREENSAVER_MODE)
 554   2          {
 555   3            Back_Color=WHITE18;
 556   3            DISP_TIME_10X16(POS_ICO_TIME_X-2,POS_DMH_Y-5,Work_Day/10,BLACK18);
 557   3            DISP_TIME_10X16(POS_ICO_TIME_X-2,POS_DMH_Y+6,Work_Day%10,BLACK18);
 558   3            DISP_TIME_10X16(POS_ICO_TIME_X-2,POS_DMH_Y+22,Work_Hour/10,BLACK18);
 559   3            DISP_TIME_10X16(POS_ICO_TIME_X-2,POS_DMH_Y+33,Work_Hour%10,BLACK18);
 560   3            DISP_TIME_10X16(POS_ICO_TIME_X-2,POS_DMH_Y+47,Work_Min/10,BLACK18);
 561   3            DISP_TIME_10X16(POS_ICO_TIME_X-2,POS_DMH_Y+58,Work_Min%10,BLACK18);  
 562   3          }
 563   2        }
 564   1      }
 565          
 566          //---------Ë¢ÐÂRTCÊ±ÖÓ
 567          void RefreshRTCTimeFunc(void)
 568          {
 569   1        static uint8_t Last_Min=0;
 570   1      //  uint8_t color;
 571   1        uint8_t t=0;
 572   1        static uint8_t Last_Sec = 60;
 573   1      
 574   1        
 575   1      //Ê±¼ä×ª»»=================================================
 576   1        RX8010_GetTime(NowTime);  
 577   1        t = (NowTime[0]&(BYTE)0xF)%10;
 578   1        if(t != Last_Sec)//Ê±¼äÃëÓÐ±ä»¯
 579   1        {
 580   2          Last_Sec = t;
 581   2               
 582   2          if(Last_Min!=NowTime[1])
 583   2          {
 584   3            Last_Min=NowTime[1];
 585   3          }
 586   2      //    color=BLACK18;    
 587   2          DisPlayTime(NowTime,2); //ÏÔÊ¾Ê±¼ä
 588   2          DisPlayTime(NowTime,3); //ÏÔÊ¾Ê±¼ä
 589   2          DisPlayTime(NowTime,4); //ÏÔÊ¾Ê±¼ä
 590   2          DisPlayTime(NowTime,5); //ÏÔÊ¾Ê±¼ä
 591   2          DisPlayTime(NowTime,6); //ÏÔÊ¾Ê±¼ä
 592   2          DisPlayTime(NowTime,7); //ÏÔÊ¾Ê±¼ä
 593   2        }
 594   1      }
 595          
 596          void GetTempHumidity_PatientFunc(void)
 597          {
 598   1        static uint8_t Get_time_out = 0;//³¬Ê±£¬Êµ²â64mS£¬×î³¤¸øµ½100mS
 599   1        static BYTE       Read_Order=0; 
 600   1        uint8_t Read_SHT21_Err=0;
 601   1      
 602   1        bit Read_SCL_CONF;
 603   1        UINT32 TempLong;
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 11  

 604   1        uint16_t  Temp2;
 605   1      
 606   1        static uint16_t RT_Temp_Mem_L1 = 0;
 607   1        static uint16_t RT_Temp_Mem_L2 = 0;
 608   1        static uint16_t RT_Temp_Mem_L3 = 0;
 609   1        static uint8_t ReCnt=0;
 610   1        
 611   1        ReCnt++;
 612   1        if(ReCnt > 50)//1S
 613   1        {
 614   2          ReCnt = 0;  
 615   2          RT_Temp_Mem_L3 = RT_Temp_Mem_L2;
 616   2          RT_Temp_Mem_L2 = RT_Temp_Mem_L1;
 617   2          RT_Temp_Mem_L1 = (uint16_t)RT_Temp; 
 618   2          Diplay_RTtemp = (RT_Temp_Mem_L3+RT_Temp_Mem_L2+RT_Temp_Mem_L1) / 3; 
 619   2        }
 620   1        
 621   1        //static int Ix=0;
 622   1      
 623   1        //Ix++;
 624   1        //LCD_ShowxNum(223,30,16,5,Ix,0x80,BLUE18);//   
 625   1      
 626   1      //  LCD_ShowxNum(223,10,16,3,RT_Temp_Not_Updated_10mS ,0x80,BLUE18);//  
 627   1      //  LCD_ShowxNum(223,70,16,3,No_ReadData_Temp_Times,0x80,BLUE18);//   
 628   1      //  LCD_ShowxNum(223,100,16,3,No_ReadData_SHIDU_Times,0x80,BLUE18);// 
 629   1      //  LCD_ShowxNum(223,130,16,3,ERR_RT_Temp_Times,0x80,BLUE18);// 
 630   1        
 631   1      //  EA = 0;
 632   1        if(RT_Temp_Not_Updated_10mS < 4000)
 633   1        {
 634   2          RT_Temp_Not_Updated_10mS++;
 635   2        }
 636   1        
 637   1        {
 638   2          if(Read_Order==0)   //·¢ÎÂ¶ÈÖ¸Áî      
 639   2          {
 640   3            Read_SHT21_Err = SHT21_WriteTemp(); 
 641   3            if(Read_SHT21_Err!=(uint8_t)0)
 642   3            {
 643   4              Read_Order = 0;//½ÓÊÕ´íÎó
 644   4            }
 645   3            else
 646   3            {       
 647   4              Read_Order = 1;
 648   4              Get_time_out = 0;
 649   4            }
 650   3          }
 651   2          else if(Read_Order == 1)  //ÎÂ¶ÈÊý¾Ý½ÓÊÕ
 652   2          {
 653   3            //SCL_INPUT_HIGH(); // set SCL I/O port as input
 654   3            Read_SCL_CONF=SCL_CONF;
 655   3            if(Read_SCL_CONF==1)
 656   3            {
 657   4              Get_time_out = 0;
 658   4              TempLong =  SHT21_ReadData();
 659   4              //RT_Temp_Test = TempLong;
 660   4                //LCD_ShowxNum(223,160,16,5,TempLong,0x80,BLUE18);//  
 661   4                
 662   4              if((TempLong == SHT21_ERROR) || (TempLong & (UINT32)0x8000)!=(UINT32)0) //¶ÁÈ¡³ö´í£¬ºóÃæÎªÊª¶È±êÖ¾Î»
 663   4              {
 664   5                //if(No_ReadData_Temp_Times<250) No_ReadData_Temp_Times++;  
 665   5                Read_Order = 0;   
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 12  

 666   5              }
 667   4              else
 668   4              {         
 669   5                No_ReadData_Temp_Times = 0;
 670   5                Read_Order = 2; 
 671   5                          
 672   5                if(Work_State != UI_STATE_SERVICE_MODE) //×¢Òâ,²âÊÔÄ£Ê½ÏÂÏÔÊ¾ÕæÊµÎÂ¶È
 673   5                {
 674   6                  if(WireIn_State!=0)    //ÓÐ¼ÓÈÈË¿Ïß½øÐÐÎÂ¶ÈÐÞÕý
 675   6                  {
 676   7                    TempLong=(TempLong*101/100)-(4*TempLong/388);
 677   7                  }
 678   6                  else
 679   6                  {
 680   7                    TempLong=TempLong-(4*TempLong/400); 
 681   7                  }
 682   6                     
 683   6      
 684   6                  if(TempLong>=350)   //ÎÂ¶ÈÐÞÕý
 685   6                  {
 686   7                    TempLong=TempLong+(6*(TempLong-350)/45);
 687   7                  }
 688   6                    
 689   6                    
 690   6                  if(TempLong>800) //Èç¹ûÈËÌå¶Ë´ïµ½80ËµÃ÷ÓÐÒì³££¬³ö´í±¨¾¯ //2014-07-07 
 691   6                  {
 692   7                    if(ERR_RT_Temp_Times<100)
 693   7                    {
 694   8                      ERR_RT_Temp_Times++;
 695   8                    }
 696   7                  }
 697   6                  else 
 698   6                  {
 699   7                    ERR_RT_Temp_Times=0;
 700   7                    RT_Temp=(INT)TempLong;
 701   7                    RT_Temp_Not_Updated_10mS = 0;
 702   7                  }            
 703   6                }
 704   5                else
 705   5                {
 706   6                  RT_Temp=(INT)TempLong;
 707   6                  RT_Temp_Not_Updated_10mS = 0;
 708   6                }
 709   5              } 
 710   4            }
 711   3            else
 712   3            {
 713   4              //CONTROL_RT_SHIDU = 0;       
 714   4            }     
 715   3            //LCD_ShowxNum(223,150,16,3,RT_Temp,0x80,BLUE18);// 
 716   3      
 717   3          }
 718   2          else if(Read_Order==2)  //·¢Êª¶ÈÖ¸Áî
 719   2          {                    
 720   3            Read_SHT21_Err = SHT21_WriteRH();
 721   3            if(Read_SHT21_Err!=(uint8_t)0)
 722   3            {
 723   4              Read_Order = 2;//½ÓÊÕ´íÎó
 724   4            }
 725   3            else
 726   3            {       
 727   4              Read_Order = 3;
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 13  

 728   4              Get_time_out = 0;
 729   4            }
 730   3          }     
 731   2          else  if(Read_Order == 3)//Êª¶ÈÊý¾Ý½ÓÊÕ
 732   2          {
 733   3            //SCL_INPUT_HIGH(); // set SCL I/O port as input
 734   3            Read_SCL_CONF=SCL_CONF;
 735   3            if(Read_SCL_CONF==1)
 736   3            { 
 737   4              //Read_Order = 0;
 738   4              Get_time_out = 0;
 739   4              TempLong =  SHT21_ReadData();
 740   4              //LCD_ShowxNum(223,210,16,5,TempLong,0x80,BLUE18);//  
 741   4              if((TempLong == SHT21_ERROR)||((TempLong & (UINT32)0x8000) ==(UINT32)0)) //¶ÁÈ¡³ö´í
 742   4              {
 743   5                if(No_ReadData_SHIDU_Times<(uint8_t)250)
 744   5                {
 745   6                  No_ReadData_SHIDU_Times++;
 746   6                }           
 747   5                CONTROL_RT_SHIDU = 0;
 748   5                Read_Order = 2; 
 749   5      
 750   5              }
 751   4              else
 752   4              {
 753   5                Read_Order = 0; 
 754   5                TempLong &= (UINT32)0x7fff;//×î¸ßÎ»ÊÇ1²ÅÊÇÊª¶È
 755   5                No_ReadData_SHIDU_Times = (uint8_t)0;
 756   5                if(TempLong > 999)
 757   5                {
 758   6                  TempLong = 999;
 759   6                }  
 760   5                RT_SHIDU=TempLong;
 761   5                CONTROL_RT_SHIDU=TempLong;  //¿ØÖÆÊª¶È
 762   5                //75%ÒÔÉÏ½øÐÐÐ£×¼
 763   5                if(Work_State != UI_STATE_SERVICE_MODE) //×¢Òâ,²âÊÔÄ£Ê½ÏÂÏÔÊ¾ÕæÊµÊª¶È
 764   5                {
 765   6                  if(RT_Temp>300)
 766   6                  {                  
 767   7                    if(TempLong>550)
 768   7                    {            
 769   8                      Temp2=(TempLong-550)*80/100; //16-05-06
 770   8                      if(Temp2>249)
 771   8                      {
 772   9                        Temp2=249;
 773   9                      }                     
 774   8                    }
 775   7                    else
 776   7                    {
 777   8                      Temp2 = 0;
 778   8                    }               
 779   7                    RT_SHIDU=TempLong + Temp2;  //2014-07-25
 780   7                  }
 781   6                  else
 782   6                  {                 
 783   7                    RT_SHIDU=TempLong;   //2014-07-18
 784   7                    //RT_SHIDU=TempLong+120;      
 785   7                  } 
 786   6                  
 787   6                  if(RT_Temp>350)
 788   6                  { 
 789   7                     RT_SHIDU=RT_SHIDU+(180*((uint16_t)RT_Temp-350)/100);  //ÏÔÊ¾Êª¶È 16-05-06
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 14  

 790   7                  }
 791   6                }
 792   5                else
 793   5                {
 794   6                  //do nothing
 795   6                } 
 796   5                RT_SHIDU += 5;  //ËÄÉáÎåÈë          
 797   5                if(RT_SHIDU>999)
 798   5                {
 799   6                  RT_SHIDU=999;//;  
 800   6                }            
 801   5              }
 802   4            }
 803   3            else
 804   3            {
 805   4                //do nothing
 806   4            }
 807   3          //LCD_ShowxNum(223,130,16,3,RT_SHIDU,0x80,BLUE18);//
 808   3            
 809   3          }
 810   2          else
 811   2          {
 812   3            //do nothing
 813   3          }
 814   2        
 815   2          if((Read_SHT21_Err!=(uint8_t)0)||(RT_SHIDU == (uint16_t)0))
 816   2          { 
 817   3            if(No_ReadData_SHIDU_Times<(uint8_t)100)
 818   3            {
 819   4              No_ReadData_SHIDU_Times++;
 820   4            }       
 821   3            if(No_ReadData_Temp_Times<100)
 822   3            {
 823   4              No_ReadData_Temp_Times++;
 824   4            }       
 825   3           
 826   3          }
 827   2          else  
 828   2          {
 829   3            No_ReadData_SHIDU_Times=(uint8_t)0;
 830   3            No_ReadData_Temp_Times=0;
 831   3          } 
 832   2      
 833   2          Get_time_out++;
 834   2          if(Get_time_out > 100)//³¬¹ý100mS
 835   2          {
 836   3            Get_time_out = 0;
 837   3            if(Read_Order == 1)
 838   3            {
 839   4              Read_Order = 0;
 840   4            }
 841   3            else if(Read_Order == 3)
 842   3            {
 843   4              Read_Order = 2;
 844   4            }
 845   3            else
 846   3            {
 847   4              Read_Order = 0;
 848   4            }       
 849   3          }        
 850   2        }
 851   1      }
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 15  

 852          
 853          
 854          void GetTemp_HpChamberFunc(void)
 855          {
 856   1      //  bit HeaterSensorExist;
 857   1        bit CQKSensorExist;
 858   1      
 859   1        //  static uint16_t CQK_Temp_Not_Updated_40mS = 0;//Á¬ÐøÎ´²ÉÑùµ½Êý¾ÝµÄÊ±¼äS
 860   1        //  static uint16_t JRP_Temp_Not_Updated_S = 0;//Á¬ÐøÎ´²ÉÑùµ½Êý¾ÝµÄÊ±¼äS
 861   1      
 862   1        uint8_t T18B20_L;
 863   1        uint8_t T18B20_H;
 864   1        uint8_t CQK_T18B20_L;
 865   1        uint8_t CQK_T18B20_H; 
 866   1      
 867   1        uint8_t T18B20_H_GET;
 868   1        uint8_t T18B20_L_GET;
 869   1        uint8_t CQK_T18B20_H_GET;
 870   1        uint8_t CQK_T18B20_L_GET;
 871   1      
 872   1      
 873   1        static uint16_t CQK_Temp_Last=0;
 874   1        uint8_t CRC8_error=0;   //checksum
 875   1        uint8_t checksum=0;   //checksum
 876   1        uint8_t DS18B20_Cdata[8];    //data array for checksum verification 
 877   1      
 878   1        uint16_t temp=0;
 879   1        static uint16_t JRP_Temp_Last=0;
 880   1      
 881   1        static uint8_t Get_Temp_Cnt=0;
 882   1      
 883   1        Get_Temp_Cnt++;
 884   1        if(Get_Temp_Cnt > 3)
 885   1        {
 886   2          Get_Temp_Cnt = 0;
 887   2        }
 888   1        
 889   1        if(No_CQKSensor_Times<2000)
 890   1        {
 891   2          No_CQKSensor_Times++;
 892   2        }
 893   1        if(No_HeatSensor_Times<200)
 894   1        {
 895   2          No_HeatSensor_Times++;
 896   2        }
 897   1        
 898   1        if(Get_Temp_Cnt == 0)  //
 899   1        {
 900   2          HeatingPlateSensor_Port=0;                                //Ö÷»úÀ­ÖÁµÍµçÆ½
 901   2          ChamberOutletSensor_Port=0;
 902   2          delay_us(609);                                //609
 903   2          HeatingPlateSensor_Port=1;                                //ÊÍ·Å×ÜÏßµÈµç×èÀ­¸ß×ÜÏß,²¢±£³Ö15~60us
 904   2          ChamberOutletSensor_Port=1;
 905   2          delay_us(86);                           //ÑÓÊ±70us                     //ÑÓÊ±70us
 906   2      //    HeaterSensorExist=HeatingPlateSensor_Port;                //½ÓÊÕÓ¦´ðÐÅºÅ
 907   2          CQKSensorExist=ChamberOutletSensor_Port;
 908   2          delay_us(488);                                //403
 909   2          DS18B20_WriteByte(0xCC);                      //Ìø¹ýROMÃüÁî
 910   2          DS18B20_WriteByte(0x44);                      //¿ªÊ¼×ª»»ÃüÁî
 911   2        }
 912   1        else if(Get_Temp_Cnt == 2) //
 913   1         //½øÐÐÎÂ¶È×ª»»
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 16  

 914   1        {
 915   2          HeatingPlateSensor_Port=0;                                //Ö÷»úÀ­ÖÁµÍµçÆ½
 916   2          ChamberOutletSensor_Port=0;
 917   2          delay_us(609);                                //503us
 918   2          HeatingPlateSensor_Port=1;                                //ÊÍ·Å×ÜÏßµÈµç×èÀ­¸ß×ÜÏß,²¢±£³Ö15~60us
 919   2          ChamberOutletSensor_Port=1;
 920   2          delay_us(86);                           //ÑÓÊ±70us
 921   2      //    HeaterSensorExist=HeatingPlateSensor_Port;                //½ÓÊÕÓ¦´ðÐÅºÅ
 922   2          CQKSensorExist=ChamberOutletSensor_Port;
 923   2          delay_us(488);
 924   2          DS18B20_WriteByte(0xCC);                      //Ìø¹ýROMÃüÁî
 925   2          DS18B20_WriteByte(0xBE);                      //¶ÁÔÝ´æ´æ´¢Æ÷ÃüÁî
 926   2          delay_us(10);
 927   2          DS18B20_ReadByte();                           //¶ÁÎÂ¶ÈµÍ×Ö½Ú
 928   2          T18B20_L=Read_18B20_Value;
 929   2          CQK_T18B20_L=Read_18B20_Value2;
 930   2          DS18B20_ReadByte();                           //¶ÁÎÂ¶È¸ß×Ö½Ú
 931   2          T18B20_H=Read_18B20_Value;
 932   2          CQK_T18B20_H=Read_18B20_Value2;
 933   2        
 934   2          if((CQKSensorExist==0))//´íÎóÔò²»½øÐÐÐ£Ñé
 935   2          {
 936   3            DS18B20_Cdata[0] = CQK_T18B20_L;
 937   3            DS18B20_Cdata[1] = CQK_T18B20_H;
 938   3            DS18B20_ReadByte();  
 939   3            DS18B20_Cdata[2] = Read_18B20_Value2;
 940   3            DS18B20_ReadByte();  
 941   3            DS18B20_Cdata[3] = Read_18B20_Value2;
 942   3            DS18B20_ReadByte();  
 943   3            DS18B20_Cdata[4] = Read_18B20_Value2;
 944   3            DS18B20_ReadByte();  
 945   3            DS18B20_Cdata[5] = Read_18B20_Value2;
 946   3            DS18B20_ReadByte();  
 947   3            DS18B20_Cdata[6] = Read_18B20_Value2;
 948   3            DS18B20_ReadByte();  
 949   3            DS18B20_Cdata[7] = Read_18B20_Value2;
 950   3            DS18B20_ReadByte();  
 951   3            checksum = Read_18B20_Value2;     
 952   3            //Cdata[7] = 0x11; //test CRC
 953   3      
 954   3            CRC8_error = DS18B20_CheckCrc(DS18B20_Cdata,8,checksum); 
 955   3              
 956   3            if(CRC8_error == CHECKSUM_ERROR)
 957   3            {
 958   4              CQKSensorExist = 1;
 959   4            }          
 960   3             
 961   3            if((CQKSensorExist==0))//
 962   3            {
 963   4              CQK_T18B20_H_GET = CQK_T18B20_H;
 964   4              CQK_T18B20_L_GET = CQK_T18B20_L;
 965   4      
 966   4              CQK_T18B20_H_GET = (uint8_t)((CQK_T18B20_H_GET << 4) | (CQK_T18B20_L_GET >> 4));      //¼ÓÈÈÅÌÎÂ¶ÈÖµºÏ²¢¸
             -ßµÍÎ»´æÈëÕûÊýÎ»
 967   4              if((CQK_T18B20_H_GET&(uint8_t)0x80)!=(uint8_t)0)//ÊÇ¸ºÊý
 968   4              {
 969   5                CQK_T18B20_L_GET =(((~CQK_T18B20_L_GET)&(uint8_t)0x0F)*10)/16;
 970   5                temp=((~CQK_T18B20_H_GET)*10)+CQK_T18B20_L_GET;
 971   5              } 
 972   4              else
 973   4              {
 974   5                CQK_T18B20_L_GET = ((CQK_T18B20_L_GET&(uint8_t)0x0F)*10)/16;
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 17  

 975   5                temp=(CQK_T18B20_H_GET*10)+CQK_T18B20_L_GET;
 976   5              }
 977   4          
 978   4              if((CQK_Temp_Last ==  temp) && (temp == 850))  //´íÎóÊ±Ò»Ö±ÏÔÊ¾85¶È 2014-07-18
 979   4              {
 980   5                CQK_Sensor_Temp_No_Change_Times++;//2014-07-03 ³öÆø¿ÚÎÂ¶È´«¸ÐÆ÷ÎÂ¶ÈÏàÍ¬µÄ´ÎÊý
 981   5                if(CQK_Sensor_Temp_No_Change_Times > 10000)
 982   5                {
 983   6                  CQK_Sensor_Temp_No_Change_Times =10000;
 984   6                }
 985   5              }
 986   4              else
 987   4              {
 988   5                CQK_Sensor_Temp_No_Change_Times = 0;    
 989   5              }
 990   4               
 991   4              if(temp > 800)
 992   4              {
 993   5              //           if(CQKSensor_Hithen800_Times < 2000) CQKSensor_Hithen800_Times++;            
 994   5              }
 995   4              else
 996   4              {
 997   5                CQKSensor_Hithen800_Times = 0;
 998   5              }         
 999   4      
1000   4              if(((CQK_Temp_Last >=  temp) && ((CQK_Temp_Last - temp) < 200))
1001   4              ||((CQK_Temp_Last <=  temp) && ((temp - CQK_Temp_Last)  < 200)))//EFT¶Ô²ß£ºÎÂ¶È²»ÄÜË²±ä,1S±ä»¯²»ÄÜ³¬¹ý
             -20¶È
1002   4              { 
1003   5                if((temp > 0)&&(temp < 850))//²»¶ÁÁã
1004   5                {
1005   6                  CQK_Temp = (LONG)temp;//ÊµÊ±ÏÔÊ¾ÎÂ¶È
1006   6                  if(Work_State != UI_STATE_SERVICE_MODE) //×¢Òâ,²âÊÔÄ£Ê½ÏÂÏÔÊ¾ÕæÊµÎÂ¶È
1007   6                  {
1008   7                    CQK_Temp=CQK_Temp*51/50;  
1009   7                  }
1010   6                }
1011   5              }
1012   4              else
1013   4              {
1014   5                //do nothing
1015   5              } 
1016   4              CQK_Temp_Last =  temp;  
1017   4            }
1018   3          }
1019   2           
1020   2      //    if(CQKSensorExist==1)// || CQK_Temp > 800)
1021   2      //    {
1022   2      //    //        if(No_CQKSensor_Times<2000)No_CQKSensor_Times++;          
1023   2      //    }
1024   2      //    else
1025   2          {
1026   3            No_CQKSensor_Times=0; 
1027   3          }
1028   2      
1029   2          T18B20_H_GET = T18B20_H;
1030   2          T18B20_L_GET = T18B20_L;
1031   2      
1032   2          if(Work_State == UI_STATE_SERVICE_MODE)//ÔÚ²âÊÔÄ£Ê½Ê±ÏÔÊ¾¶ÁÈ¡µÄÊý¾Ý
1033   2          {
1034   3      //      LCD_ShowxNum(10,220,24,3,T18B20_H_GET,0x80,BLACK18); //8±íÊ¾¸ßÎ»Îª0Ò²ÏÔÊ¾,0±íÊ¾·Çµþ¼ÓÏÔÊ¾ ¼ÓÈÈÅÌ
1035   3      //      LCD_ShowxNum(10,268,24,3,T18B20_L_GET,0x80,BLACK18); //8±íÊ¾¸ßÎ»Îª0Ò²ÏÔÊ¾,0±íÊ¾·Çµþ¼ÓÏÔÊ¾
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 18  

1036   3          }    
1037   2      
1038   2      
1039   2          T18B20_H_GET = (uint8_t)((T18B20_H_GET << 4) | (T18B20_L_GET >> 4));      //¼ÓÈÈÅÌÎÂ¶ÈÖµºÏ²¢¸ßµÍÎ»´æÈëÕûÊýÎ
             -»
1040   2          if((T18B20_H_GET&(uint8_t)0x80)!=(uint8_t)0)//ÊÇ¸ºÊý
1041   2          {
1042   3            T18B20_L_GET =(((~T18B20_L_GET)&(uint8_t)0x0F)*10)/16;
1043   3            temp=((~T18B20_H_GET)*10)+T18B20_L_GET;
1044   3          } 
1045   2          else
1046   2          {
1047   3            T18B20_L_GET = ((T18B20_L_GET&(uint8_t)0x0F)*10)/16;
1048   3            temp=(T18B20_H_GET*10)+T18B20_L_GET;
1049   3          }
1050   2            
1051   2             
1052   2          if((JRP_Temp_Last ==  temp))// && (temp == 850))  //´íÎóÊ±Ò»Ö±ÏÔÊ¾85¶È 2014-07-18
1053   2          {
1054   3            JRP_Sensor_Temp_No_Change_Times++;//2014-07-03 ¼ÓÈÈÅÌÎÂ¶È´«¸ÐÆ÷ÎÂ¶ÈÏàÍ¬µÄ´ÎÊý
1055   3            if(JRP_Sensor_Temp_No_Change_Times > 6000)
1056   3            {
1057   4              JRP_Sensor_Temp_No_Change_Times = 6000;
1058   4            }
1059   3          }
1060   2          else
1061   2          {
1062   3            JRP_Sensor_Temp_No_Change_Times = 0;
1063   3          }
1064   2          JRP_Temp_Last =  temp;    
1065   2      
1066   2          JEP_Temp =  (INT)temp;    //ÊµÊ±ÏÔÊ¾ÎÂ¶È
1067   2      
1068   2      //    if(HeaterSensorExist==1 || JEP_Temp>=0x0FFF || JEP_Temp > 1250)
1069   2      //    {
1070   2      ////       if(No_HeatSensor_Times<2000)No_HeatSensor_Times++; 
1071   2      //    }
1072   2      //    else
1073   2          {
1074   3            No_HeatSensor_Times=0;
1075   3          }
1076   2        }
1077   1        else
1078   1        {
1079   2          //do nothing
1080   2        }
1081   1      } 
1082          
1083          static INT  Temp1_Int = 260;
1084          static INT  Temp2_Int = 400;
1085          static uint16_t NoneWire_Heat_Sec=0;
1086          static INT  Set_CQK_Temp_Comp;//³öÆø¿ÚÐ£Õý¹ýºóµÄÄ¿±êÎÂ¶È
1087          void  HeaterPlateWireControlFunc(void)//ÎÂ¶È¿ØÖÆ
1088          {
1089   1        //    uint8_t  Temp3;
1090   1        uint16_t  Val_Calc=0;
1091   1      
1092   1        INT  Humidity_Err=0; //Î´´ïµ½Ä¿±êÊª¶ÈµÄ²îÖµ
1093   1        INT  Humidity_Comp=0;//³¬¹ýÄ¿±êÎÂ¶ÈµÄ²îÖµ 
1094   1        static uint16_t Last_Rem_Humidity=0;  
1095   1        
1096   1        static uint16_t WarmUp_S_Cnt=0; 
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 19  

1097   1        //uint16_t  CQK_Vaul_Err;//²îÖµ
1098   1      
1099   1        if((Work_State != UI_STATE_SCREENSAVER_MODE)&&(Test_Mode_Dis_Jrp_Ctl == 1))
1100   1        { //8±íÊ¾¸ßÎ»Îª0Ò²ÏÔÊ¾,0±íÊ¾·Çµþ¼ÓÏÔÊ¾ ³öÆø¿Ú
1101   2          Back_Color=WHITE18;
1102   2          LCD_ShowxNum(POS_RT_RH_X-50,5,16,2,Micro_Adj_Mode_Test,0x80,BLACK18); //·¢ÈÈÅÌ¼ÓÈÈµÄÄ£Ê½ÏÔÊ¾
1103   2          LCD_ShowxNum(POS_RT_RH_X-50,34,16,4,(u32)JEP_Temp,0x80,BLACK18); //·¢ÈÈÅÌµÄÎÂ¶È
1104   2          LCD_ShowxNum(POS_RT_RH_X-50,73,16,3,(u32)CQK_Temp,0x80,BLACK18); //³öÆø¿ÚµÄÎÂ¶È
1105   2          LCD_ShowxNum(POS_RT_RH_X-50,107,16,3,Set_CQK_Temp,0x80,BLACK18); //³öÆø¿ÚÉè¶¨ÎÂ¶È
1106   2          LCD_ShowxNum(POS_RT_RH_X-50,141,16,3,Micro_Temp_Val,0x80,BLACK18); //·¢ÈÈÅÌµÄ¼ÓÈÈÊ±³¤
1107   2          
1108   2          LCD_ShowxNum(POS_RT_RH_X-50,185,16,3,CONTROL_RT_SHIDU,0x80,BLACK18); //ÕæÊµÏà¶ÔÊª¶È
1109   2          LCD_ShowxNum(POS_RT_RH_X-50,219,16,3,Aim_SHIDU,0x80,BLACK18); //Ä¿±êÊª¶È
1110   2          LCD_ShowxNum(POS_RT_RH_X-50,253,16,3,Micro_Temp_In,0x80,BLACK18); //In¼ÓÈÈÊ±³¤
1111   2          LCD_ShowxNum(POS_RT_RH_X-50,287,16,3,Micro_Temp_Out,0x80,BLACK18); //Exp¼ÓÈÈÊ±³¤
1112   2          
1113   2          LCD_ShowxNum(POS_RT_RH_X-33,2,16,1,(u32)Wire_Mode_Sel,0x80,BLACK18); //¼ÓÈÈË¿Ä£Ê½     
1114   2          LCD_ShowxNum(POS_RT_RH_X-33,10,16,1,WireIn_State,0x80,BLACK18); //IN¼ÓÈÈË¿×´Ì¬
1115   2          LCD_ShowxNum(POS_RT_RH_X-33,18,16,1,WireOut_State,0x80,BLACK18); //EXP¼ÓÈÈË¿×´Ì¬  
1116   2            
1117   2          //LCD_ShowxNum(POS_RT_RH_X-20,185,16,1,SHT21_Heater_State,0x80,BLACK18); //SHT¼ÓÈÈ×´Ì¬
1118   2          LCD_ShowxNum(POS_RT_RH_X-33,253,16,3,Wire_Warm_Up_Sec,0x80,BLACK18); //600S¼ÆÊ± 
1119   2          LCD_ShowxNum(POS_RT_RH_X-33,107,16,3,(u32)Set_CQK_Temp_Comp,0x80,BLACK18); //Ð£Õý¹ýºóµÄ³öÆø¿ÚÄ¿±êÊª¶È
1120   2          //LCD_ShowxNum(POS_RT_RH_X-33,141,16,3,Plate_Warm_Up_Sec,0x80,BLACK18); //600S¼ÆÊ±  
1121   2          LCD_ShowxNum(POS_RT_RH_X-33,185,16,3,Humidity_No_Change_Sec,0x80,BLACK18); //600S¼ÆÊ±     
1122   2          
1123   2          if(WireIn_State!=0) //ÓÐ·¢ÈÈË¿
1124   2          {
1125   3            LCD_ShowxNum(POS_RT_RH_X-33,34,16,4,(u32)JEP_Temp_Aim,0x80,BLACK18); //·¢ÈÈÅÌµÄÄ¿±êÎÂ¶È
1126   3            LCD_ShowxNum(POS_RT_RH_X-16,34,16,3,WarmUp_S_Cnt,0x80,BLACK18); //ÎÞ·¢ÈÈË¿»ØÂ·Ê±¸Ä±äÊ±¼ä  
1127   3      
1128   3            if(Controler_temp3.Sum_error >0)
1129   3            {
1130   4              LCD_ShowxNum(POS_RT_RH_X+41,20,16,1,1,0x80,BLACK18); //
1131   4            }
1132   3            else
1133   3            {
1134   4              LCD_ShowxNum(POS_RT_RH_X+41,20,16,1,0,0x80,BLACK18); //
1135   4            }
1136   3              
1137   3      
1138   3            LCD_ShowxNum(POS_RT_RH_X+41,34,16,4,(u32)(abs(Controler_temp3.Sum_error)),0x80,BLACK18); //
1139   3      
1140   3      
1141   3            if(Controler_temp2.Sum_error >0)
1142   3            {
1143   4              LCD_ShowxNum(POS_RT_RH_X+41,80,16,1,1,0x80,BLACK18); //
1144   4            }
1145   3            else
1146   3            {
1147   4              LCD_ShowxNum(POS_RT_RH_X+41,80,16,1,0,0x80,BLACK18); //
1148   4            }
1149   3              
1150   3      
1151   3            LCD_ShowxNum(POS_RT_RH_X+41,94,16,4,(u32)(abs(Controler_temp2.Sum_error)),0x80,BLACK18); //
1152   3          }
1153   2          else
1154   2          {
1155   3            LCD_ShowxNum(POS_RT_RH_X-33,34,16,4,(u32)Temp2_Int,0x80,BLACK18); //ÎÞ·¢ÈÈË¿»ØÂ·Ê±·¢ÈÈÅÌµÄÄ¿±êÎÂ¶È
1156   3            LCD_ShowxNum(POS_RT_RH_X-16,34,16,3,NoneWire_Heat_Sec,0x80,BLACK18); //ÎÞ·¢ÈÈË¿»ØÂ·Ê±¸Ä±äÊ±¼ä 
1157   3          }
1158   2            
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 20  

1159   2          LCD_ShowxNum(POS_RT_RH_X+40,170,16,3,(u32)Temp1_Int,0x80,BLACK18); //¿ª»ú½¥½øÊ½ÎÂ¶ÈÄ¿±ê
1160   2          LCD_ShowxNum(POS_RT_RH_X+20,170,16,3,(u32)RT_Temp,0x80,BLACK18); //»¼Õß¶ËÎÂ¶È
1161   2          LCD_ShowxNum(POS_RT_RH_X+20,210,16,4,Nochange_Times,0x80,BLACK18); //ÎÂÊª¶ÈÁ¬Ðø²»±ä¼ÆÊý   
1162   2      
1163   2          LCD_ShowxNum(2,2,16,5,Working_Normal,0x80,BLACK18); //Õý³£¹¤×÷Ê±¼ä¼ÆÊ±  
1164   2          LCD_ShowxNum(2,60,16,5,HP_CNT_Int_End_Rem,0x80,BLACK18); //ÏÔÊ¾Ã¿4Ãë¼ÓÈÈÅÌ·½²¨µÄ´ÎÊý      
1165   2        }
1166   1      
1167   1        if(        
1168   1          ((ERR_Kind & (uint8_t)0x01)!=(uint8_t)0)//´«¸ÐÆ÷´íÎó        
1169   1          ||((ERR_Kind & (uint8_t)0x02)!=(uint8_t)0) //¸ßÎÂ
1170   1          ||((ERR_Kind & (uint8_t)0x10)!=(uint8_t)0) //ÎÞË®   
1171   1          || (Wire_Mode_Mismatch == (uint8_t)1)  //·¢ÈÈË¿Î´Ñ¡
1172   1          || (HeaterPlate_State==(uint8_t)0))//Ë®¹ÞÎ´×°ºÃ
1173   1        {
1174   2          Micro_Temp_In=0;
1175   2          Micro_Temp_Out=0;
1176   2          Micro_Temp_Val=0;  //Í£Ö¹¼ÓÈÈ
1177   2          Micro_Adj_Mode_Test = 1;//¼ÓÈÈÄ£Ê½²âÊÔ
1178   2          Wire_Warm_Up_Sec = 0; //µ±<=300Ê±ÏÞÖÆ×î´ó¼ÓÈÈ¹¦ÂÊ  
1179   2          //Plate_Warm_Up_Sec = 0;
1180   2          Humidity_No_Change_Sec = 0;     
1181   2        }
1182   1        else
1183   1        {       
1184   2          //¹ÜÄÚ·¢ÈÈË¿¹¤×÷,¿ØÖÆÎÂ¶Èµ÷½Ú==========================       
1185   2      
1186   2          if(Work_Mode==Noninvasive_Mode) //ÎÞ´´Ä£Ê½Ê±,ÈËÌå¶ËÎÂ¶È¶ÔÄ¿±êÊª¶ÈµÄ¿ØÖÆÂß¼­
1187   2          {       
1188   3            Aim_SHIDU=790;  
1189   3          }else   //ÓÐ´´Ä£Ê½Ê±,ÈËÌå¶ËÎÂ¶È¶ÔÄ¿±êÊª¶ÈµÄÓ°Ïì
1190   2          {
1191   3            Aim_SHIDU=890; //2014-11-21 
1192   3          }
1193   2      
1194   2          Val_Calc = 0;       
1195   2          //if(Boot_Start_RT_Temp_Heating_Timer_Sec > 300) //»¼Õß¶Ë¿ª»ú½¥½øÊ½¼ÓÈÈ½áÊø
1196   2          if(Low_Power_Mode_Flag == 0)//·ÇµÍ¹¦ÂÊÄ£Ê½²Å¿ÉÒÔ¿ØÖÆ
1197   2          {//»ØÂ··¢ÈÈË¿µÄ¿ØÖÆ
1198   3            if(WireIn_State!=0)   //µ±ÓÐ¹ÜÄÚIN·¢ÈÈË¿Ê±£¬¹ÜÄÚ·¢ÈÈË¿µÄ¼ÓÈÈÂß¼­
1199   3            {
1200   4              if(Working_Normal >= 1200)
1201   4              {
1202   5                Temp1_Int = Set_RT_Temp;//20·ÖÖÓÒÔºóÎªÉè¶¨ÎÂ¶È
1203   5              }
1204   4              else
1205   4              {           
1206   5                Temp1_Int = CQK_Temp + 30;//20·ÖÖÓÒÔÇ°¸úËæ³öÆø¿ÚÎÂ¶È
1207   5              }
1208   4              if(Temp1_Int > Set_RT_Temp)
1209   4              {
1210   5                Temp1_Int = Set_RT_Temp;
1211   5              }
1212   4                
1213   4                
1214   4              //Controler_temp.Ek = Set_RT_Temp - RT_Temp;//µ±Ç°µÄÎó²îÁ¿ Éè¶¨ÎÂ¶È-µ±Ç°Êµ¼ÊÎÂ¶È
1215   4              Controler_temp.Ek = Temp1_Int - RT_Temp;//µ±Ç°µÄÎó²îÁ¿ Éè¶¨ÎÂ¶È-µ±Ç°Êµ¼ÊÎÂ¶È
1216   4              Controler_Calc(); 
1217   4              Val_Calc = (uint8_t)Controler_temp.Uk;  //¼ÆËã³ö¼ÓÈÈÊ±¼ä          
1218   4                
1219   4              if(WireIn_State!=0)
1220   4              {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 21  

1221   5                if (RT_Temp<(Set_RT_Temp-20))
1222   5                {
1223   6                  //do nothing
1224   6                }
1225   5                else if (RT_Temp<(Set_RT_Temp-10))
1226   5                {
1227   6                  //do nothing
1228   6                }
1229   5                else if (RT_Temp<=Set_RT_Temp)
1230   5                {
1231   6                  //do nothing
1232   6                }
1233   5                else if (RT_Temp<=(Set_RT_Temp+10))
1234   5                {
1235   6                  //do nothing
1236   6                }
1237   5                else
1238   5                {
1239   6                  Val_Calc=0; 
1240   6                }
1241   5              }
1242   4              else
1243   4              {
1244   5                     Val_Calc=0;
1245   5              }
1246   4            } 
1247   3            else    //µ±ÎÞ¹ÜÄÚ·¢ÈÈË¿Ê±
1248   3            {
1249   4              Val_Calc=0;
1250   4            }
1251   3              
1252   3            if(Working_Normal >= 1200)//Õý³£¹¤×÷20·ÖÖÓÖ®ºó
1253   3            {
1254   4      
1255   4            }
1256   3            else
1257   3            {
1258   4              if(Val_Calc > 160)
1259   4              {
1260   5                Val_Calc = 160;//20·ÖÖÓÄÚÏÞÖÆ¼ÓÈÈ¹¦ÂÊ
1261   5              }
1262   4            }
1263   3              
1264   3              
1265   3            Micro_Temp_In = Val_Calc;
1266   3      
1267   3            Val_Calc=0;
1268   3            if(WireOut_State!=0)    //µ±ÓÐ¹ÜÄÚOUT·¢ÈÈË¿Ê±£¬¹ÜÄÚ·¢ÈÈË¿µÄ¼ÓÈÈÂß¼­
1269   3            {
1270   4              {
1271   5                Val_Calc = Micro_Temp_In *(10+In_Exp_Ratio-1)/10;
1272   5                if(Val_Calc > 195)
1273   5                {
1274   6                  Val_Calc = 195;
1275   6                }
1276   5                if(In_Exp_Ratio > 1)
1277   5                { 
1278   6                  if(Val_Calc==0)
1279   6                  {
1280   7                    Val_Calc=40*(10+In_Exp_Ratio-1)/10;
1281   7                  }
1282   6                }
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 22  

1283   5                if (RT_Temp >= (Set_RT_Temp+10))//´óÓÚ1¶È,Í£Ö¹¼ÓÈÈ,±£»¤´ëÊ©
1284   5                {
1285   6                  Val_Calc=0; 
1286   6                }
1287   5              }          
1288   4            }
1289   3            else
1290   3            { 
1291   4              Val_Calc=0; 
1292   4            }
1293   3            Micro_Temp_Out = Val_Calc;
1294   3          }
1295   2      
1296   2          //ÓÐÎÞ´´Ä£Ê½Ê±·¢ÈÈÅÌµÄ¼ÓÈÈÂß¼­
1297   2      
1298   2          //²»Çø·Ö¼ÓÈÈÏß/////////////////////////////   
1299   2          if(CONTROL_RT_SHIDU<=Aim_SHIDU)//Ö÷ÒªÊÇÕë¶Ô´óÁ÷Á¿Ê±µÄ²¹³¥
1300   2          {
1301   3            Humidity_Err = (INT)(Aim_SHIDU - CONTROL_RT_SHIDU);///2;//Êª¶ÈÎó²î¼ÆËã
1302   3            if(Humidity_Err > 100)
1303   3            {
1304   4              Humidity_Err = 100;//×î´óÏÞ¶¨Îª100
1305   4            }
1306   3          }   
1307   2          else
1308   2          {
1309   3            Humidity_Err = 0; 
1310   3          }     
1311   2                
1312   2          Humidity_Comp = (INT) (CONTROL_RT_SHIDU - Aim_SHIDU); //¿ØÖÆÊª¶ÈÒÔ¼õÉÙÀäÄýË®    
1313   2          if(Humidity_Comp > 100)
1314   2          {
1315   3            Humidity_Comp  = 100;
1316   3          }
1317   2      
1318   2          if(Last_Rem_Humidity != CONTROL_RT_SHIDU)//ÕæÊµÊª¶È¸Ä±äÔòÇåÁã
1319   2          {
1320   3            Humidity_No_Change_Sec = 0;
1321   3          }
1322   2          Last_Rem_Humidity = CONTROL_RT_SHIDU;
1323   2      
1324   2          if(Humidity_No_Change_Sec >= 900)//¿ÉÄÜ½øÈëÀäÄý×´Ì¬
1325   2          {
1326   3            Humidity_No_Change_Sec = 901;
1327   3            Humidity_Err = 0;  //½øÈëÀäÄý×´Ì¬ÔòÊª¶È¿ØÖÆÎÞÐ§
1328   3            Humidity_Comp = 0;
1329   3          }       
1330   2                      
1331   2          if((CQK_Temp>=660) ||(JEP_Temp>=HeatingTemperature_MAX))     //³öÆø¿ÚÎÂ¶È×î¸ß66¶È
1332   2          {
1333   3             Micro_Temp_Val=0;//´óÓÚ65¶È±ØÐëÍ£Ö¹¼ÓÈÈ
1334   3             Micro_Adj_Mode_Test = 2;//¼ÓÈÈÄ£Ê½²âÊÔ          
1335   3          }       
1336   2          //´ø¼ÓÈÈÏßµÄÎÂ¶Èµ÷½Ú===========================
1337   2          else if(WireIn_State!=0)
1338   2          {
1339   3            if(Low_Power_Mode_Flag == 0)//·ÇµÍ¹¦ÂÊÄ£Ê½²Å¿ÉÒÔ¿ØÖÆ
1340   3            {
1341   4              if(JEP_Temp>=HeatingTemperature_MAX)   //105¶È
1342   4              {
1343   5                Val_Calc = 0;
1344   5                Micro_Adj_Mode_Test = 7;//¼ÓÈÈÄ£Ê½²âÊÔ              
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 23  

1345   5              }
1346   4              else
1347   4              { 
1348   5                Set_CQK_Temp_Comp = (INT)Set_CQK_Temp; //³öÆø¿ÚÉè¶¨ÎÂ¶È
1349   5                
1350   5                if(Work_Mode==Invasive_Mode)//
1351   5                { 
1352   6                  if(Humidity_Err >= 50)  //µ±Ä¿±êÊª¶ÈÏà²î5%ÒÔÉÏÇÒÎªÎÞ´´Ê±£¬ÔÊÐí×î¸ß³¬¹ý¶È
1353   6                  {
1354   7                    //Set_CQK_Temp_Comp += Humidity_Err/6;//×î¸ßÔÊÐí³¬¹ý1.6¶È
1355   7                    Set_CQK_Temp_Comp += Humidity_Err/10;//×î¸ßÔÊÐí³¬¹ý1¶È
1356   7                  } 
1357   6                } 
1358   5                else
1359   5                {
1360   6                  if(Humidity_Err >= 50)  //µ±Ä¿±êÊª¶ÈÏà²î5%ÒÔÉÏÇÒÎªÎÞ´´Ê±£¬ÔÊÐí×î¸ß³¬¹ý¶È
1361   6                  {
1362   7                    Set_CQK_Temp_Comp += Humidity_Err/2;//×î¸ßÔÊÐí³¬¹ý5¶È 120L 28»·¾³ÎÂ¶È
1363   7                  }
1364   6                } 
1365   5      
1366   5                if(Humidity_Comp >= 10)
1367   5                {
1368   6                  //Set_CQK_Temp_Comp = Set_CQK_Temp_Comp - Humidity_Comp/5;//Êª¶ÈÃ¿ÉÏ1%Ôò³öÆø¿ÚÎÂ¶ÈÏÂ½µ0.2¶È£¬×î¶à2¶È
1369   6                  Set_CQK_Temp_Comp = Set_CQK_Temp_Comp - (Humidity_Comp/10);//Êª¶ÈÃ¿ÉÏ1%Ôò³öÆø¿ÚÎÂ¶ÈÏÂ½µ0.1¶È£¬×î¶à1¶
             -È
1370   6                }   
1371   5      
1372   5                if(Work_Mode==Invasive_Mode)//
1373   5                { 
1374   6                  //Set_CQK_Temp_Comp -= 5;//ÓÐ´´Ê±½µµÍ0.5¶È  
1375   6                  if(Set_CQK_Temp_Comp < 320)
1376   6                  {
1377   7                    Set_CQK_Temp_Comp = 320;//×î¼«ÏÞµÄÎÂ¶È
1378   7                  }
1379   6                }
1380   5                else
1381   5                { 
1382   6                  if(Set_CQK_Temp_Comp < 300)
1383   6                  {
1384   7                    Set_CQK_Temp_Comp = 300;//×î¼«ÏÞµÄÎÂ¶È
1385   7                  }
1386   6                } 
1387   5      
1388   5                ////if(CQK_Temp < Set_CQK_Temp_Comp - 30) //  
1389   5      
1390   5                //Ëã·¨¿ªÊ¼
1391   5                if(JEP_Temp < (JEP_Temp_Aim - 20))//¼ÓÈÈÅÌÎÂ¶ÈÐ¡ÓÚ¼ÓÈÈÅÌÄ¿±êÎÂ¶È-2    
1392   5                {
1393   6                  WarmUp_S_Cnt = 0;//ÇåÁã£¬µÈ´ý´ïµ½¼ÓÈÈÄ¿±ê
1394   6                } 
1395   5                else
1396   5                {
1397   6                  WarmUp_S_Cnt++;
1398   6                  if(WarmUp_S_Cnt >= 20)//Ã¿Á½·ÖÖÓµ÷ÕûÒ»´Î¼ÓÈÈÅÌÄ¿±êÎÂ¶È
1399   6                  {
1400   7                    WarmUp_S_Cnt = 0;
1401   7                    Controler_temp3.Ek = Set_CQK_Temp_Comp - CQK_Temp;//µ±Ç°µÄÎó²îÁ¿ Éè¶¨ÎÂ¶È-µ±Ç°Êµ¼ÊÎÂ¶È
1402   7                    HeatPlateTemp_Aim_Controler_Calc();                       
1403   7      
1404   7                    JEP_Temp_Aim = JEP_Temp_Aim + Controler_temp3.Uk;//                       
1405   7                    
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 24  

1406   7                    if(Work_Mode==Invasive_Mode)//
1407   7                    {
1408   8                      if(JEP_Temp_Aim < 500)
1409   8                      {
1410   9                        JEP_Temp_Aim = 500;//×îÐ¡50¶È
1411   9                      }
1412   8                    }
1413   7                    else
1414   7                    {
1415   8                      if(JEP_Temp_Aim < 400)
1416   8                      {
1417   9                        JEP_Temp_Aim = 400;//×îÐ¡50¶È
1418   9                      }
1419   8                    } 
1420   7                    
1421   7                    if(Working_Normal >= 1200)
1422   7        //                    if(Work_Min>=20||Work_Day>0 ||Work_Hour>0)//¿ª»ú20·ÖÖÓÖ®ºó
1423   7                    {
1424   8                      if(JEP_Temp_Aim > 1045)
1425   8                      {
1426   9                        JEP_Temp_Aim = 1045;//×î´ó102¶È
1427   9                      }
1428   8                    }
1429   7                    else
1430   7                    {
1431   8                      if(JEP_Temp_Aim > 980)
1432   8                      {
1433   9                        JEP_Temp_Aim = 980;//¿ª»ú20·ÖÖÓÒÔÄÚ×î´ó98¶È
1434   9                      }
1435   8                    }
1436   7                  }
1437   6                }
1438   5                      
1439   5                      
1440   5                Controler_temp2.Ek = JEP_Temp_Aim - JEP_Temp;//µ±Ç°µÄÎó²îÁ¿ Éè¶¨ÎÂ¶È-µ±Ç°Êµ¼ÊÎÂ¶È
1441   5                HeatPlate_Controler_Calc(); 
1442   5                Val_Calc = (uint8_t)Controler_temp2.Uk; //¼ÆËã³ö¼ÓÈÈÊ±¼ä
1443   5      
1444   5                if((CQK_Temp - Set_CQK_Temp_Comp) > 20)//³öÆø¿ÚÎÂ¶È±ÈÄ¿±êÎÂ¶È¸ß
1445   5                {
1446   6                  if(Val_Calc > 20)
1447   6                  {
1448   7                    Val_Calc = 20;  
1449   7                  }
1450   6                  JEP_Temp_Aim = JEP_Temp;//¸ü¸Ä¼ÓÈÈÅÌÄ¿±êÎÂ¶È
1451   6                } 
1452   5                else if((CQK_Temp - Set_CQK_Temp_Comp) > 10)//³öÆø¿ÚÎÂ¶È±ÈÄ¿±êÎÂ¶È¸ß
1453   5                {
1454   6                  //do nothing
1455   6                }
1456   5                else
1457   5                {
1458   6                  //do nothing
1459   6                }
1460   5              }
1461   4            }          
1462   3                
1463   3                
1464   3            if(Val_Calc > 195)
1465   3            {
1466   4              Val_Calc = 195; 
1467   4            }       
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 25  

1468   3            if(Low_Power_Mode_Flag == 0)//·ÇµÍ¹¦ÂÊÄ£Ê½²Å¿ÉÒÔ¿ØÖÆ
1469   3            {
1470   4              Micro_Temp_Val = (uint8_t)Val_Calc;//±ãÓÚ¼ÆËã£¬ÒÔÃâ³¬¹ý190½øÈëÖÐ¶Ï  
1471   4            }
1472   3                
1473   3            }
1474   2          else if(Low_Power_Mode_Flag == 0)//·ÇµÍ¹¦ÂÊÄ£Ê½²Å¿ÉÒÔ¿ØÖÆ
1475   2          { 
1476   3            PatientTemp_NoneHeatWire_Adj();
1477   3            //²»´ø¼ÓÈÈÏßµÄÎÂ¶Èµ÷½Ú==============================================================
1478   3          }
1479   2          else
1480   2          {
1481   3            //do nothing
1482   3          }
1483   2      
1484   2        }
1485   1      } 
1486          
1487          
1488          static void   Store_Data(void)   //´æ·ÅÊý¾ÝµØÖ·´Ó1¿ªÊ¼
1489          {
1490   1        uint16_t i;
1491   1        uint8_t N,j;
1492   1        if (Run_Count<1)
1493   1        {
1494   2          return;
1495   2        }   
1496   1        i=((Run_Count-1)/8)+1;     //¼ÆËãµØÖ·
1497   1        N=Run_Count%8;       //¼ÆËãÎ»
1498   1        if ((Run_Count!=0) && (N==0)) 
1499   1        {
1500   2          N=8;
1501   2        }
1502   1        j=(uint8_t)((uint8_t)0xFF<<N);
1503   1        SPI_Write_nBytes(i,1,&j);
1504   1      
1505   1            //delay_us(100);
1506   1      }
1507          
1508          static void  Get_RunCount(void)   //µÃµ½´æ·ÅÊý¾ÝµÄÌõÊý
1509          {
1510   1        uint16_t Start1,Start2,StartAdr;
1511   1        uint8_t N,K,j;
1512   1        Start1=0x1;
1513   1        Start2=0x2000;
1514   1        for(j=0;j<14;j++) //²éÕÒ¼ÆÊýÎ»
1515   1        {
1516   2          StartAdr=(Start1+Start2)/2;
1517   2          SPI_Read_nBytes(StartAdr,1,&N);
1518   2          delay_us(100);
1519   2          if(N==0xFF)
1520   2          {
1521   3            Start2=StartAdr;
1522   3          }else
1523   2          {
1524   3            Start1=StartAdr;
1525   3            Start2=Start1+((uint16_t)2<<(12-(uint16_t)j));
1526   3            SPI_Read_nBytes(StartAdr+1,1,&K);
1527   3            if(K==0xFF)
1528   3            {  break;  }
1529   3            else
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 26  

1530   3            {
1531   4              StartAdr=StartAdr+1;
1532   4              N=K;
1533   4            }
1534   3          }
1535   2        }
1536   1        Run_Count=(StartAdr-1)*8;//¼ÆËãÊ±1¸ö×Ö½Ú±í8
1537   1        for(j=0;j<8;j++)
1538   1        {
1539   2          if((((uint8_t)0x01<<j) & N)!=0)
1540   2          {
1541   3            break;
1542   3          }     
1543   2        }
1544   1        Run_Count=Run_Count+j;      //×î¶à¿É¼ÇÊý44896Ìõ,256ÌõÎª»º³å
1545   1      
1546   1         //Run_Count = 2000;//²âÊÔÊ¹ÓÃ 2014-12-26
1547   1         //SPI_Read_nBytes(8000,1,&N);
1548   1         // DS1302_GetTime(NowTime);
1549   1         // if(NowTime[0]&0x80)         //·¢ÏÖµôµçÔòÖØÐÂ³õÊ¼»¯Ê±¼ä£¬ÊÇ·ñÒªÑ¯ÎÊ
1550   1         //    DS1302_SetTime(initTime);    //³õÊ¼»¯Ê±¼ä
1551   1      //    if(N==1)                    //Ê±¼ä±ØÐë×ÔÐÐÉè¶¨
1552   1      //   {
1553   1      //      DS1302_SetTime(NowTime);
1554   1      //      j=2;
1555   1      //      SPI_Write_nBytes(8000,1,&j);
1556   1      //      delay_ms(10);
1557   1      //   }else if(N==2)
1558   1      //   {
1559   1      
1560   1      //   }
1561   1      
1562   1         
1563   1         /* 
1564   1         DISP_TIME_10X16(POS_RT_RH_X-20,10,Run_Count/10000,BLACK18);
1565   1         DISP_TIME_10X16(POS_RT_RH_X-20,18,Run_Count%10000/1000,BLACK18);
1566   1         DISP_TIME_10X16(POS_RT_RH_X-20,26,Run_Count%1000/100,BLACK18);
1567   1         DISP_TIME_10X16(POS_RT_RH_X-20,34,Run_Count%100/10,BLACK18);
1568   1         DISP_TIME_10X16(POS_RT_RH_X-20,42,Run_Count%10,BLACK18);
1569   1         */
1570   1         //DISP_TIME_10X16(POS_RT_RH_X-20,POS_RT_RH_Y+150-90,Enable_Save_Data,BLACK18);
1571   1      }
1572          
1573          static uint8_t  Wire_Mode_Sel_Rem = 0xff;//¼ÇÒä×´Ì¬
1574          static uint8_t  Disp_ERR_VHB80_Code = 0xff;
1575          
1576          void Err_Base_HeaterWire_DISP_Enable(void)//ÆÁ±£Ê±ÖÃÏà¹Ø±êÖ¾,ÒÔ±ãÁÁÆÁÊ±ÏÔÊ¾Ö÷»úºÍÏßµÄÍ¼ÐÎ
1577          {
1578   1        Disp_ERR_VHB80_Code = 0xff;
1579   1        Wire_Mode_Sel_Rem = 0xff;//¼ÇÒä×´Ì¬
1580   1      }
1581          
1582          
1583          void AlarmErrorFunc(void)    //´íÎóÊÂ¼þ
1584          {
1585   1        uint8_t color=0;
1586   1        static uint8_t     Err_Event_Cnt=0;  //¼õÐ¡¹¤×÷´ÎÊý
1587   1        uint8_t     Err_Event_1=0;
1588   1        uint8_t     Err_Event_2=0;
1589   1          
1590   1        static uint8_t AlarmInfoRem = 0;//±¨¾¯×´Ì¬¼ÇÒä
1591   1        {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 27  

1592   2          Err_Event_Cnt++;//ÉÁË¸¼ÆÊý¼°¼õÉÙ³ÌÐòÔËÐÐÊ±¼ä
1593   2          if(Err_Event_Cnt > 1)
1594   2          { 
1595   3            Err_Event_Cnt = 0;//ºì  
1596   3          }
1597   2          Err_Event_1 = 0;
1598   2          Err_Event_2 = 1;      
1599   2        
1600   2          //LCD_ShowxNum(POS_RT_RH_X-40,5,16,4,RT_Temp,0x80,BLACK18); //8±íÊ¾¸ßÎ»Îª0Ò²ÏÔÊ¾,0±íÊ¾·Çµþ¼ÓÏÔÊ¾
1601   2          //LCD_ShowxNum(POS_RT_RH_X-40,60,16,4,ERR_RT_Temp_Times,0x80,BLACK18); //
1602   2        
1603   2          if(((No_CQKSensor_Times>1000) || (CQK_Sensor_Temp_No_Change_Times > 6000)) //³öÆø¿ÚÎÂ¶È´«¸ÐÆ÷´íÎó¼ì²â
1604   2            ||(CQKSensor_Hithen800_Times > 250)//Á¬Ðø10S > 80¶È
1605   2            ||(No_ReadData_Temp_Times>20)//¼ÓËÙÏÔÊ¾
1606   2            )
1607   2          {
1608   3            CQK_Sensor_Err=(uint8_t)1;
1609   3            CQK_Temp = 0; 
1610   3            LoTemp_CQK_Count  = 0;//´«¸ÐÆ÷´íÎó,²»¿É¼ì²âµÍÎÂ±¨¾¯
1611   3            Working_Normal = 0;//Õý³£¹¤×÷Ê±¼äÇåÁã 
1612   3            Set_bit(&ERR_Kind,Alarm_Const_CQK_Sensor);        
1613   3          }
1614   2          else
1615   2          {
1616   3            CQK_Sensor_Err=(uint8_t)0;
1617   3            Clear_bit(&ERR_Kind,Alarm_Const_CQK_Sensor);        
1618   3          }
1619   2            
1620   2          if((Nochange_Times>900) || (No_ReadData_SHIDU_Times>20) || (RT_Temp_Not_Updated_10mS > 3000))//ÈËÌå¶ËÊª¶
             -È´«¸ÐÆ÷´íÎó¼ì²â
1621   2          {
1622   3            SHIDU_Sensor_Err=(uint8_t)1;
1623   3            RTD_Sensor_Err=(uint8_t)1;
1624   3            RT_SHIDU = 0; 
1625   3            HiTemp_Count = 0;//´«¸ÐÆ÷´íÎó,²»¿É¼ì²â¸ßÎÂ±¨¾¯
1626   3            LoTemp_Count = 0;//´«¸ÐÆ÷´íÎó,²»¿É¼ì²âµÍÎÂ±¨¾¯
1627   3            LoHumity_Count = 0;//´«¸ÐÆ÷´íÎó,²»¿É¼ì²âµÍÊª±¨¾¯
1628   3            Working_Normal = 0;//Õý³£¹¤×÷Ê±¼äÇåÁã   
1629   3            Set_bit(&ERR_Kind,Alarm_Const_RTD_Sensor); 
1630   3          }   
1631   2          else
1632   2          {
1633   3            SHIDU_Sensor_Err=(uint8_t)0;
1634   3            Clear_bit(&ERR_Kind,Alarm_Const_RTD_Sensor); 
1635   3          }
1636   2            
1637   2          if((Nochange_Times>900) ||  (No_ReadData_Temp_Times>20) 
1638   2          || (ERR_RT_Temp_Times>20) || (RT_Temp_Not_Updated_10mS > 3000))//ÈËÌå¶ËÎÂ¶È´«¸ÐÆ÷´íÎó¼ì²â 2014-07-03
1639   2          {
1640   3            RTD_Sensor_Err=(uint8_t)1;
1641   3            if(ERR_RT_Temp_Times<10)//¸ßÎÂÒì³£±¨¾¯Ê±ÎÂ¶È²»ÇåÁã
1642   3            {
1643   4              RT_Temp = 0;    
1644   4              Diplay_RTtemp = 0;
1645   4            }
1646   3            HiTemp_Count = 0;//´«¸ÐÆ÷´íÎó,²»¿É¼ì²â¸ßÎÂ±¨¾¯
1647   3            LoTemp_Count = 0;//´«¸ÐÆ÷´íÎó,²»¿É¼ì²âµÍÎÂ±¨¾¯
1648   3            LoHumity_Count = 0;//´«¸ÐÆ÷´íÎó,²»¿É¼ì²âµÍÊª±¨¾¯
1649   3            Working_Normal = 0;//Õý³£¹¤×÷Ê±¼äÇåÁã   
1650   3          }
1651   2          else
1652   2          {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 28  

1653   3            RTD_Sensor_Err=(uint8_t)0;
1654   3          }
1655   2            
1656   2          
1657   2          if( (No_HeatSensor_Times>150) || (JRP_Sensor_Temp_No_Change_Times > 600))//¼ÓÈÈÅÌ´«¸ÐÆ÷´íÎó¼ì²â  
1658   2          {     
1659   3            JRP_Sensor_Err=(uint8_t)1;
1660   3            Set_bit(&ERR_Kind,Alarm_Const_JRP_Sensor); 
1661   3          }
1662   2          else
1663   2          {
1664   3            JRP_Sensor_Err=(uint8_t)0;
1665   3            Clear_bit(&ERR_Kind,Alarm_Const_JRP_Sensor); 
1666   3          }
1667   2          if(HiTemp_Count>2)  //¸ßÎÂ´íÎó¼ì²â
1668   2          {
1669   3            Set_bit(&ERR_Kind,Alarm_Const_HiTemp);
1670   3          }
1671   2          else
1672   2          {
1673   3            Clear_bit(&ERR_Kind,Alarm_Const_HiTemp);
1674   3          }
1675   2            
1676   2          
1677   2          if(LoTemp_Count>120)  //µÍÎÂ´íÎó¼ì²â
1678   2          {
1679   3            Set_bit(&ERR_Kind,Alarm_Const_LoTemp);
1680   3          } 
1681   2          else
1682   2          {
1683   3            Clear_bit(&ERR_Kind,Alarm_Const_LoTemp);
1684   3          }
1685   2            
1686   2      
1687   2          if(LoHumity_Count>120) //µÍÊª¶È´íÎó¼ì²â
1688   2          {
1689   3            Set_bit(&ERR_Kind,Alarm_Const_LoHumity);//ÉèÖÃµÍÊª¶È±¨¾¯±êÖ¾
1690   3          }
1691   2          else
1692   2          {
1693   3            if (Bit_is_one(ERR_Kind,Alarm_Const_LoHumity)!=(uint8_t)0)
1694   3            {
1695   4              Clear_bit(&ERR_Kind,Alarm_Const_LoHumity);//Çå³ýµÍÊª¶È±¨¾¯±êÖ¾
1696   4            }
1697   3          }
1698   2      
1699   2        //É«¿é±¨¾¯  VHB15A_FUNCTION_ALARM_COLOR_DISPLAY
1700   2        /*ÈËÌåÌ½Í·³ö´í    ---ºì
1701   2         ³öÆø¿ÚÌ½Í·³ö´í   ---ÂÌ
1702   2         ¼ÓÈÈÅÌÌ½Í·³ö´í   ---À¶
1703   2         ¸ßÎÂ±¨¾¯       ---ºÚ
1704   2         µÍÎÂ±¨¾¯       ---»Ò
1705   2         µÍÊª¶È±¨¾¯     ---»Æ
1706   2         Ë®¹ÞÎ´°²×°ºÃ±¨¾¯   ---Çà
1707   2         ·¢ÈÈÏßÎ´°²×°»ò¿ªÂ· ---×Ï
1708   2         ÎÞË®/¸ÉÉÕ        ---ºÚ
1709   2        */
1710   2        
1711   2          if(Work_State != UI_STATE_SCREENSAVER_MODE)//ÆÁ±£Ê±²»ÏÔÊ¾
1712   2          {
1713   3            if((SHIDU_Sensor_Err==(uint8_t)1)||(RTD_Sensor_Err!=(uint8_t)0))  //ÈËÌå¶ËÌ½Í·
1714   3            {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 29  

1715   4              Draw_Rectangle_Real(POS_ALARM_COL_X,POS_ALARM_COL_Y,POS_ALARM_COL_X+10,POS_ALARM_COL_Y+5,RED18);
1716   4            }
1717   3            if(CQK_Sensor_Err==(uint8_t)1)//³öÆø¿ÚÌ½Í·
1718   3            {
1719   4              Draw_Rectangle_Real(POS_ALARM_COL_X,POS_ALARM_COL_Y+5,POS_ALARM_COL_X+10,POS_ALARM_COL_Y+10,GREEN18);
1720   4            }
1721   3            if(JRP_Sensor_Err==(uint8_t)1)//¼ÓÈÈÅÌÌ½Í·
1722   3            {
1723   4              Draw_Rectangle_Real(POS_ALARM_COL_X,POS_ALARM_COL_Y+10,POS_ALARM_COL_X+10,POS_ALARM_COL_Y+15,BLUE18);
1724   4            }
1725   3            if(HiTemp_Count>2)//¸ßÎÂ
1726   3            {
1727   4              Draw_Rectangle_Real(POS_ALARM_COL_X,POS_ALARM_COL_Y+15,POS_ALARM_COL_X+10,POS_ALARM_COL_Y+20,BLACK18);
1728   4            }
1729   3            if(LoTemp_Count>120)//µÍÎÂ
1730   3            {
1731   4              Draw_Rectangle_Real(POS_ALARM_COL_X,POS_ALARM_COL_Y+20,POS_ALARM_COL_X+10,POS_ALARM_COL_Y+25,GRAY18);
1732   4            }
1733   3            if(LoHumity_Count>120)//µÍÊª¶È
1734   3            {
1735   4              Draw_Rectangle_Real(POS_ALARM_COL_X,POS_ALARM_COL_Y+25,POS_ALARM_COL_X+10,POS_ALARM_COL_Y+30,YELLOW18)
             -;
1736   4            }
1737   3            if(HeaterPlate_State==0)//Ë®¹ÞÎ´×°ºÃ»ò·¢ÈÈÅÌ¿ªÂ·
1738   3            {
1739   4              Draw_Rectangle_Real(POS_ALARM_COL_X,POS_ALARM_COL_Y+30,POS_ALARM_COL_X+10,POS_ALARM_COL_Y+35,BRIGHT_BL
             -UE18);
1740   4            }
1741   3            if(Wire_Mode_Mismatch == (uint8_t)1)//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä  
1742   3            {
1743   4              Draw_Rectangle_Real(POS_ALARM_COL_X,POS_ALARM_COL_Y+35,POS_ALARM_COL_X+10,POS_ALARM_COL_Y+40,PURPLE18)
             -;
1744   4            }
1745   3            if(Bit_is_one(ERR_Kind,Alarm_Const_NoWater)!=(uint8_t)0) //ÎÞË®(¸ÉÉÕ)±¨¾¯
1746   3            {
1747   4              Draw_Rectangle_Real(POS_ALARM_COL_X,POS_ALARM_COL_Y+40,POS_ALARM_COL_X+10,POS_ALARM_COL_Y+45,BLACK18);
1748   4            } 
1749   3          }
1750   2      
1751   2      
1752   2          if(HeaterPlate_State==(uint8_t)0)  //Ã»ÓÐ·ÅÈë¹Þ×Ó
1753   2          {
1754   3            AlarmInfoIndex = (uint8_t)1;
1755   3          }
1756   2          else if(Bit_is_one(ERR_Kind,Alarm_Const_NoWater)!=(uint8_t)0) //ÎÞË®´íÎó
1757   2          {
1758   3            AlarmInfoIndex = (uint8_t)2;
1759   3          }
1760   2          else if(CQK_Sensor_Err!=(uint8_t)0 || RTD_Sensor_Err!=(uint8_t)0 || SHIDU_Sensor_Err!=(uint8_t)0)
1761   2          {
1762   3            AlarmInfoIndex = (uint8_t)3;
1763   3          } 
1764   2          else if(Bit_is_one(ERR_Kind,Alarm_Const_HiTemp)!=(uint8_t)0) //¸ßÎÂ´íÎó
1765   2          {
1766   3            AlarmInfoIndex = (uint8_t)4;
1767   3          }
1768   2          else if(Bit_is_one(ERR_Kind,Alarm_Const_LoTemp)!=(uint8_t)0) //»¼Õß¶Ë³ÖÐøµÍÎÂ
1769   2          {
1770   3            AlarmInfoIndex = (uint8_t)5;
1771   3          }
1772   2          else if(LoTemp_CQK_Count>(uint8_t)120)//³öÆø¿Ú³ÖÐøµÍÎÂ
1773   2          {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 30  

1774   3            AlarmInfoIndex = (uint8_t)6;
1775   3          } 
1776   2          else if(Bit_is_one(ERR_Kind,Alarm_Const_LoHumity)!=(uint8_t)0)//³ÖÐøµÍÊª¶È´íÎó
1777   2          {
1778   3            AlarmInfoIndex = (uint8_t)7;
1779   3          }
1780   2          else if(Wire_Mode_Mismatch == (uint8_t)1)//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä 
1781   2          {
1782   3            AlarmInfoIndex = (uint8_t)8;
1783   3          } 
1784   2          else
1785   2          {
1786   3            AlarmInfoIndex = (uint8_t)0;
1787   3            AlarmSoundPauseStatus = (uint8_t)0;//ÎÞ±¨¾¯£¬²»¿ÉÉùÒôÔÝÍ£
1788   3          }
1789   2      
1790   2          if(AlarmInfoIndex !=  AlarmInfoRem)//±¨¾¯×´Ì¬¸Ä±ä
1791   2          {
1792   3            AlarmSoundPauseStatus = 0;//ÉùÒôÔÝÍ£È¡Ïû
1793   3            Sound_Alarm_Pause_Disable();  
1794   3          } 
1795   2                
1796   2          AlarmInfoRem = AlarmInfoIndex;
1797   2          
1798   2        
1799   2          //´«¸ÐÆ÷´íÎó==============================================================
1800   2          ERR_Kind&=(uint8_t)0xFE;  ////Çå³ýµÚÒ»Î»ÊÇ´«¸ÐÆ÷´íÎó
1801   2          if(CQK_Sensor_Err!=(uint8_t)0 || RTD_Sensor_Err!=(uint8_t)0 || JRP_Sensor_Err!=(uint8_t)0 || SHIDU_Senso
             -r_Err!=(uint8_t)0)
1802   2          {
1803   3            ERR_Kind|=(uint8_t)0x01;//µÚÒ»Î»ÊÇ´«¸ÐÆ÷´íÎó
1804   3          } 
1805   2      
1806   2          if(Work_State != UI_STATE_SCREENSAVER_MODE)//·ÇÆÁ±£Ä£Ê½£¬·ñÔòÒªÏÈÍË³öÆÁ±£Ä£Ê½
1807   2          { 
1808   3            if(HeaterPlate_State==0)    //ÎÞ¼ÓÈÈÅÌ£¬ÏÔÊ¾ËùÓÐµÄÍ¼Æ¬   Plate_State==0
1809   3            {
1810   4              Working_Normal = 0;//Õý³£¹¤×÷Ê±¼äÇåÁã
1811   4      
1812   4              if(Work_State != UI_STATE_SCREENSAVER_MODE)
1813   4              {
1814   5                if(Disp_ERR_VHB80_Code!=1)
1815   5                {
1816   6                  Disp_ERR_VHB80_Code=1;
1817   6                  DISP_VHB80_PIC(BLUE18); 
1818   6      
1819   6                  if(Wire_Mode_Sel_Rem != (uint8_t)Wire_Mode_Sel)
1820   6                  {
1821   7                    if(Wire_Mode_Sel == Wire_Sel_None)
1822   7                    { 
1823   8                      if(Err_Event_Cnt == Err_Event_1) //ÎÞ¼ÓÈÈ
1824   8                      { 
1825   9                        Draw_Rectangle_Real(POS_XQGS_X1,POS_XQGS_Y1,POS_XQGS_X2,POS_XQGS_Y2,GRAY18);  //»­ÎüÆø¹ÜÉÏ²¿£¬ÏÂ²
             -¿
1826   9                        Draw_Rectangle_Real(POS_XQGX_X1,POS_XQGX_Y1,POS_XQGX_X2,POS_XQGX_Y2,GRAY18); 
1827   9                      }
1828   8                    } 
1829   7      
1830   7                    if((Wire_Mode_Sel==Wire_Sel_In_Only) || (Wire_Mode_Sel== Wire_Sel_None))
1831   7                    {
1832   8                      if(Err_Event_Cnt == Err_Event_1)
1833   8                      {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 31  

1834   9                        Draw_Rectangle_Real(POS_CQGS_X1,POS_CQGS_Y1,POS_CQGS_X2,POS_CQGS_Y2,GRAY18);  //»­³öÆø¹ÜÉÏ²¿£¬ÏÂ²
             -¿
1835   9                        Draw_Rectangle_Real(POS_CQGX_X1,POS_CQGX_Y1,POS_CQGX_X2,POS_CQGX_Y2,GRAY18);   //»­³öÆø¹ÜÉÏ²¿£¬ÏÂ
             -²¿
1836   9                        Draw_Rectangle_Real(POS_CQGX_X1,POS_CQGX_Y1,POS_CQGS_X2,POS_CQGX_Y1+1,GRAY18);  //»­·â¿Ú         
             -      
1837   9                      }
1838   8                    }
1839   7                  }
1840   6                  Wire_Mode_Sel_Rem = (uint8_t)Wire_Mode_Sel;                
1841   6                }
1842   5                if(Err_Event_Cnt == Err_Event_1)     
1843   5                {
1844   6                  color=RED18;//¸ÄÑÕÉ«
1845   6                }
1846   5                else if(Err_Event_Cnt == Err_Event_2)
1847   5                {
1848   6                  color=GRAY18;
1849   6                }
1850   5                else 
1851   5                {
1852   6                  //do nothing
1853   6                }
1854   5      
1855   5                //         if((Err_Event_Cnt == Err_Event_1)||(Err_Event_Cnt == Err_Event_2))
1856   5                DISP_HEAT_36X24(POS_HEAT_X,POS_HEAT_Y,color); 
1857   5              }
1858   4              else
1859   4              {
1860   5                Disp_ERR_VHB80_Code = 0;        
1861   5              }     
1862   4            }
1863   3            else  if(Bit_is_one(ERR_Kind,Alarm_Const_NoWater)!=(uint8_t)0) //ÎÞË®(¸ÉÉÕ)±¨¾¯
1864   3            // if(0)
1865   3            {
1866   4              //ÏÔÊ¾ÎÞË®´íÎó================================
1867   4              if(Disp_ERR_VHB80_Code!=2)
1868   4              {
1869   5                Disp_ERR_VHB80_Code=2; 
1870   5                DISP_VHB80_PIC(BLUE18);
1871   5              }
1872   4              if(Err_Event_Cnt == Err_Event_1)
1873   4              {
1874   5                color=RED18;          //ÎÞË®´íÎó¸ÄÎªºìÉ«
1875   5              }
1876   4              else if(Err_Event_Cnt == Err_Event_2)
1877   4              {
1878   5                color=WHITE18;
1879   5              }
1880   4              else 
1881   4              {
1882   5                //do nothing
1883   5              }
1884   4              Draw_Rectangle_Real(POS_HEAT_X,POS_HEAT_Y+2,POS_HEAT_X+8,POS_HEAT_Y+33,color);
1885   4                    
1886   4            }
1887   3            else if(CQK_Sensor_Err!=(uint8_t)0 || RTD_Sensor_Err!=(uint8_t)0 || SHIDU_Sensor_Err!=(uint8_t)0  
1888   3              ||(HiTemp_Count>2) || (LoTemp_Count>120) ||(LoTemp_CQK_Count>120)) //Ì½Í·´íÎó»ò¸ßµÍÎÂ±¨¾¯
1889   3            //   || Heat_ERR
1890   3            //else if(0)
1891   3            {
1892   4              //ÏÔÊ¾Í¼ÐÎ£¬ÉÁË¸´íÎó²¿·Ö==========================================
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 32  

1893   4              if(Disp_ERR_VHB80_Code!=3)
1894   4              {
1895   5                Disp_ERR_VHB80_Code=3; 
1896   5                DISP_VHB80_PIC(GRAY18);
1897   5              }     
1898   4      
1899   4              if(Err_Event_Cnt == Err_Event_1)
1900   4              {
1901   5                color=RED18;  //ºì
1902   5              }
1903   4              else if(Err_Event_Cnt == Err_Event_2)
1904   4              {
1905   5                color=GRAY18; //»Ò
1906   5              }
1907   4              else
1908   4              {
1909   5                //do nothing
1910   5              }
1911   4      
1912   4      
1913   4              {
1914   5      
1915   5                if(CQK_Sensor_Err!=(uint8_t)0||(LoTemp_CQK_Count>(uint8_t)120))//ÏÔÊ¾³öÆø¿Ú´íÎó///
1916   5                {
1917   6                  DISP_CQK25X24(POS_CQK_X,POS_CQK_Y,color);
1918   6                }else
1919   5                {
1920   6                  DISP_CQK25X24(POS_CQK_X,POS_CQK_Y,GRAY18);
1921   6                } 
1922   5                if(RTD_Sensor_Err!=(uint8_t)0||(HiTemp_Count>(uint8_t)2) || (LoTemp_Count>(uint8_t)120))  //ÈËÌå¶ËÌ½Í
             -·´íÎó
1923   5                { 
1924   6                  DISP_RTD28X24(POS_RTD_X,POS_RTD_Y,color);
1925   6                }else
1926   5                {
1927   6                  DISP_RTD28X24(POS_RTD_X,POS_RTD_Y,GRAY18);
1928   6                } 
1929   5                if(JRP_Sensor_Err!=(uint8_t)0) //¼ÓÈÈÅÌÌ½Í·
1930   5                {
1931   6                  //DISP_HEAT_36X24(POS_HEAT_X,POS_HEAT_Y,color);  
1932   6                  DISP_HEAT_36X24(POS_HEAT_X,POS_HEAT_Y,GRAY18);
1933   6                  //DISP_HEAT_36X24(POS_HEAT_X,POS_HEAT_Y,RED18); 
1934   6                }else
1935   5                {
1936   6                  DISP_HEAT_36X24(POS_HEAT_X,POS_HEAT_Y,GRAY18); 
1937   6                  //DISP_HEAT_36X24(POS_HEAT_X,POS_HEAT_Y,RED18);          
1938   6                } 
1939   5              }
1940   4            }
1941   3            else if(Wire_Mode_Mismatch == (uint8_t)1)//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä 
1942   3              //else if(0)
1943   3            {
1944   4              Working_Normal = (uint16_t)0;//Õý³£¹¤×÷Ê±¼äÇåÁã 
1945   4      
1946   4              {
1947   5                if(Disp_ERR_VHB80_Code!=4)
1948   5                {
1949   6                  Disp_ERR_VHB80_Code=4; 
1950   6                  DISP_VHB80_PIC(BLUE18);
1951   6                }
1952   5      
1953   5                //»­In¼ÓÈÈÏß¶Î
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 33  

1954   5                if(WireIn_State > 0)//ÓÐIn»ØÂ··¢ÈÈË¿£¬ÏÔÊ¾À¶É«
1955   5                {
1956   6                  color=BLUE18;
1957   6                }
1958   5                else
1959   5                {
1960   6                  color=GRAY18;//ÎÞIn»ØÂ··¢ÈÈË¿£¬ÏÔÊ¾»ÒÉ«
1961   6                }
1962   5                if(Err_Event_Cnt <= Err_Event_1)//ÏÔÊ¾µ±Ç°×´Ì¬£¬ÓÐ»òÕßÎÞ£¬À¶É«»ò»ÒÉ«
1963   5                {//°´ÉÏÃæµÄÑÕÉ«ÏÔÊ¾
1964   6                }               
1965   5                else if(Err_Event_Cnt <= Err_Event_2)//¸ù¾ÝÄ£Ê½È·¶¨ÏÔÊ¾ºìÉ«±¨¾¯»¹ÊÇµ±Ç°×´Ì¬ÑÕÉ«
1966   5                {
1967   6                  if(((WireIn_State == 0)&&(Wire_Mode_Sel == Wire_Sel_None))//ÎÞIn»ØÂ··¢ÈÈË¿ÇÒÊÇNoneÄ£Ê½²»ÐèÒª±¨¾¯
1968   6                    ||((WireIn_State == 1)&&(Wire_Mode_Sel == Wire_Sel_Double))//ÓÐIn»ØÂ··¢ÈÈË¿ÇÒÊÇË«Ö§Ä£Ê½²»ÐèÒª±¨¾¯
1969   6                    ||((WireIn_State == 1)&&(Wire_Mode_Sel == Wire_Sel_In_Only)))//ÓÐIn»ØÂ··¢ÈÈË¿ÇÒÊÇµ¥Ö§Ä£Ê½²»ÐèÒª±¨¾¯
1970   6                  
1971   6                  {
1972   7                  }
1973   6                  else//³ýÒÔÉÏÇé¿ö¾ùÐèÒª±¨¾¯:ÈçÎÞInÊ±µ¥/Ë«Ö§/Un,ÓÐInÊ±None/Un
1974   6                  {
1975   7                    color=RED18;
1976   7                  }
1977   6                }
1978   5                else 
1979   5                {
1980   6                  //do nothing
1981   6                }
1982   5                
1983   5                Draw_Rectangle_Real(POS_XQGS_X1,POS_XQGS_Y1,POS_XQGS_X2,POS_XQGS_Y2,color);  //»­ÎüÆø¹ÜÉÏ²¿£¬ÏÂ²¿
1984   5                Draw_Rectangle_Real(POS_XQGX_X1,POS_XQGX_Y1,POS_XQGX_X2,POS_XQGX_Y2,color);       
1985   5            
1986   5                  
1987   5                 //»­Exp¼ÓÈÈÏß¶Î
1988   5                if(WireOut_State > 0)//ÓÐOut»ØÂ··¢ÈÈË¿£¬ÏÔÊ¾À¶É«
1989   5                {
1990   6                  color=BLUE18;
1991   6                }
1992   5                else
1993   5                {
1994   6                  color=GRAY18;//ÎÞOut»ØÂ··¢ÈÈË¿£¬ÏÔÊ¾»ÒÉ«
1995   6                }
1996   5                if(Err_Event_Cnt <= Err_Event_1)//ÏÔÊ¾µ±Ç°×´Ì¬£¬ÓÐ»òÕßÎÞ£¬À¶É«»ò»ÒÉ«
1997   5                {//°´ÉÏÃæµÄÑÕÉ«ÏÔÊ¾
1998   6                }               
1999   5                else if(Err_Event_Cnt <= Err_Event_2)//¸ù¾ÝÄ£Ê½È·¶¨ÏÔÊ¾ºìÉ«±¨¾¯»¹ÊÇµ±Ç°×´Ì¬ÑÕÉ«
2000   5                {
2001   6                  if(((WireOut_State == 0)&&(Wire_Mode_Sel == Wire_Sel_None))//ÎÞOut»ØÂ··¢ÈÈË¿ÇÒÊÇNoneÄ£Ê½²»ÐèÒª±¨¾¯
2002   6                    ||((WireOut_State == 0)&&(Wire_Mode_Sel == Wire_Sel_In_Only))//ÎÞOut»ØÂ··¢ÈÈË¿ÇÒÊÇµ¥Ö§Ä£Ê½²»ÐèÒª±¨¾
             -¯
2003   6                    ||((WireOut_State == 1)&&(Wire_Mode_Sel == Wire_Sel_Double)))//ÓÐIn»ØÂ··¢ÈÈË¿ÇÒÊÇË«Ö§Ä£Ê½²»ÐèÒª±¨¾¯
             -              
2004   6                  
2005   6                  {
2006   7                  }
2007   6                  else//³ýÒÔÉÏÇé¿ö¾ùÐèÒª±¨¾¯:ÈçÎÞOutÊ±Ë«Ö§/Un,ÓÐOutÊ±µ¥/None/Un
2008   6                  {
2009   7                    color=RED18;
2010   7                  }
2011   6                }
2012   5                else
2013   5                {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 34  

2014   6                  //do nothing
2015   6                }
2016   5                  
2017   5                Draw_Rectangle_Real(POS_CQGS_X1,POS_CQGS_Y1,POS_CQGS_X2,POS_CQGS_Y2,color);  //»­³öÆø¹ÜÉÏ²¿£¬ÏÂ²¿
2018   5                Draw_Rectangle_Real(POS_CQGX_X1,POS_CQGX_Y1,POS_CQGX_X2,POS_CQGX_Y2,color);   //»­³öÆø¹ÜÉÏ²¿£¬ÏÂ²¿
2019   5                Draw_Rectangle_Real(POS_CQGX_X1,POS_CQGX_Y1,POS_CQGS_X2,POS_CQGX_Y1+1,color);  //»­·â¿Ú 
2020   5              }        
2021   4            }
2022   3            else if(JRP_Sensor_Err!=(uint8_t)0)//¼ÓÈÈÅÌÌ½Í·´íÎó
2023   3            {
2024   4              Working_Normal = 0;//Õý³£¹¤×÷Ê±¼äÇåÁã   
2025   4              //ÏÔÊ¾Í¼ÐÎ£¬ÉÁË¸´íÎó²¿·Ö==========================================
2026   4              if(Disp_ERR_VHB80_Code!=5)
2027   4              {
2028   5                Disp_ERR_VHB80_Code=5; 
2029   5                DISP_VHB80_PIC(GRAY18);
2030   5              } 
2031   4              if(Err_Event_Cnt == Err_Event_1)
2032   4              {
2033   5                  //color=RED18;  //ºì
2034   5                color=BLUE18; //»Ò
2035   5              }
2036   4              //else
2037   4              else if(Err_Event_Cnt == Err_Event_2)
2038   4              {
2039   5                color=GRAY18; //»Ò
2040   5              }
2041   4              else
2042   4              {
2043   5                //do nothing
2044   5              }
2045   4              DISP_HEAT_36X24(POS_HEAT_X,POS_HEAT_Y,color);   
2046   4           
2047   4            }
2048   3            else if((Wire_Mode_Sel==Wire_Sel_In_Only) || (Wire_Mode_Sel== Wire_Sel_None))//¾­¹ýÈ·ÈÏºóµÄµ¥Ö§¼ÓÈÈ»òÎÞ
             -¼ÓÈÈ»ØÂ·  
2049   3            { 
2050   4      
2051   4              if(Work_State != UI_STATE_SCREENSAVER_MODE)  //Ã»ÓÐÆÁÄ»±£»¤Ê±²ÅÄÜÏÔÊ¾¼ÓÈÈÄ£Ê½
2052   4              {
2053   5                if(Disp_ERR_VHB80_Code!=6)
2054   5                {
2055   6                  Disp_ERR_VHB80_Code=6; 
2056   6                  DISP_VHB80_PIC(BLUE18);
2057   6                }
2058   5      
2059   5                //»­¼ÓÈÈÏß 
2060   5                if(Err_Event_Cnt == Err_Event_1) //   
2061   5                { 
2062   6                  if(Wire_Mode_Sel_Rem != (uint8_t)Wire_Mode_Sel)
2063   6                  {        
2064   7                    if(Wire_Mode_Sel == Wire_Sel_None)//ÎÞ¼ÓÈÈË¿
2065   7                    { 
2066   8                      Draw_Rectangle_Real(POS_XQGS_X1,POS_XQGS_Y1,POS_XQGS_X2,POS_XQGS_Y2,GRAY18);  //»­ÎüÆø¹ÜÉÏ²¿£¬ÏÂ²¿
2067   8                      Draw_Rectangle_Real(POS_XQGX_X1,POS_XQGX_Y1,POS_XQGX_X2,POS_XQGX_Y2,GRAY18); 
2068   8                    
2069   8                      Draw_Rectangle_Real(POS_CQGS_X1,POS_CQGS_Y1,POS_CQGS_X2,POS_CQGS_Y2,GRAY18);  //»­³öÆø¹ÜÉÏ²¿£¬ÏÂ²¿
2070   8                      Draw_Rectangle_Real(POS_CQGX_X1,POS_CQGX_Y1,POS_CQGX_X2,POS_CQGX_Y2,GRAY18);   //»­³öÆø¹ÜÉÏ²¿£¬ÏÂ²
             -¿
2071   8                      Draw_Rectangle_Real(POS_CQGX_X1,POS_CQGX_Y1,POS_CQGS_X2,POS_CQGX_Y1+1,GRAY18);  //»­·â¿Ú        
2072   8                    } 
2073   7                    else if(Wire_Mode_Sel==Wire_Sel_In_Only)
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 35  

2074   7                    {
2075   8                      Draw_Rectangle_Real(POS_XQGS_X1,POS_XQGS_Y1,POS_XQGS_X2,POS_XQGS_Y2,BLUE18);  //»­ÎüÆø¹ÜÉÏ²¿£¬ÏÂ²¿
2076   8                      Draw_Rectangle_Real(POS_XQGX_X1,POS_XQGX_Y1,POS_XQGX_X2,POS_XQGX_Y2,BLUE18); 
2077   8                      
2078   8                      Draw_Rectangle_Real(POS_CQGS_X1,POS_CQGS_Y1,POS_CQGS_X2,POS_CQGS_Y2,GRAY18);  //»­³öÆø¹ÜÉÏ²¿£¬ÏÂ²¿
2079   8                      Draw_Rectangle_Real(POS_CQGX_X1,POS_CQGX_Y1,POS_CQGX_X2,POS_CQGX_Y2,GRAY18);   //»­³öÆø¹ÜÉÏ²¿£¬ÏÂ²
             -¿
2080   8                      Draw_Rectangle_Real(POS_CQGX_X1,POS_CQGX_Y1,POS_CQGS_X2,POS_CQGX_Y1+1,GRAY18);  //»­·â¿Ú 
2081   8                    }
2082   7                    else
2083   7                    {
2084   8                      //do nothing
2085   8                    }
2086   7                  }
2087   6                  Wire_Mode_Sel_Rem = (uint8_t)Wire_Mode_Sel;
2088   6                } 
2089   5              }     
2090   4            }
2091   3            else   //Ïû³ýËùÓÐ´íÎóÏÔÊ¾
2092   3            {
2093   4              if(Disp_ERR_VHB80_Code!=0)
2094   4              {
2095   5                Disp_ERR_VHB80_Code=0;
2096   5                DISP_VHB80_PIC(WHITE18);        
2097   5              }     
2098   4            }
2099   3          }
2100   2         //DISP_TIME_10X16(POS_RT_RH_X,POS_RT_RH_Y+145,Disp_ERR_VHB80_Code,BLACK18);
2101   2        }
2102   1      }   
2103          
2104          //void Event_1s(void)       //1ÃëÖÓÊÂ¼þ ÄÚ²¿¶¨Ê±ÖÐ¶ÏÖÃ±êÖ¾
2105          void LowTempDet1SFunc(void)
2106          {
2107   1        uint16_t a=0,b=0,c=0;//³öÆø¿ÚÎÂ¶È´ïµ½Éè¶¨ÎÂ¶È-1
2108   1        static uint8_t     No_Water_Times=0;  
2109   1        static uint8_t RT_SHIDU_More_then_90_Cnt = 0;//Á¬Ðø³¬¹ý90%´ïµ½10´Î(1Ãë1´Î)  
2110   1        static uint16_t     Last1s_RThumity=0;
2111   1        static uint16_t     Last1s_RTtemp=0;
2112   1      
2113   1        if(Working_Normal < 65000)
2114   1        {
2115   2          Working_Normal++;
2116   2        }
2117   1      
2118   1      
2119   1        if((Work_State != UI_STATE_SCREENSAVER_MODE)&&(Test_Mode_Dis_Jrp_Ctl == 1))
2120   1        {
2121   2          LCD_ShowxNum(105,180,16,3,RT_Temp_Reach_Set_Cnt,0x80,BLACK18); //
2122   2          LCD_ShowxNum(105,215,16,3,LoTemp_Count,0x80,BLACK18); //  
2123   2        }
2124   1      
2125   1      
2126   1        if(Wire_Warm_Up_Sec < 900)
2127   1        {
2128   2          Wire_Warm_Up_Sec++;
2129   2        }
2130   1      
2131   1        if(Plate_Warm_Up_Sec < 900)
2132   1        {
2133   2          Plate_Warm_Up_Sec++;
2134   2        }
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 36  

2135   1        Humidity_No_Change_Sec++;//Êª¶È²»¸Ä±äµÄ¼ÆÊý£¬µ±´óÓÚ600Ê±¿ÉÄÜÌ½Í·Ê§Ð§£¬Êª¶È¿ØÖÆÊ§Ð§
2136   1        
2137   1        if(HeaterPlate_State!=(uint8_t)0)  //
2138   1        { 
2139   2          if((Last1s_RThumity==CONTROL_RT_SHIDU) && (Last1s_RTtemp==(uint16_t)RT_Temp)) //ÈËÌå¶ËÎÂ¶ÈºÍÊª¶ÈÍ¬Ê±²»¸Ä
             -±ä
2140   2          {
2141   3            if(Nochange_Times<1000)
2142   3            {
2143   4              Nochange_Times++;
2144   4            }       
2145   3          }
2146   2          else
2147   2          { 
2148   3            Nochange_Times=0;
2149   3          } 
2150   2          
2151   2      
2152   2          //Last1s_RThumity=RT_SHIDU;
2153   2          Last1s_RThumity=CONTROL_RT_SHIDU;
2154   2          Last1s_RTtemp=(uint16_t)RT_Temp;
2155   2        }
2156   1        else
2157   1        {
2158   2          Nochange_Times=0;
2159   2        }
2160   1       
2161   1        //ÎÞË®±¨¾¯,Ó¦Í¨¹ý¼ÓÈÈÅÌµÄ¼ÓÈÈÉÏÉýËÙ¶ÈÅÐ¶ÏË®Á¿======================================
2162   1        //´ÓÓÐË®µ½ÎÞË®£¬ÈËÌå¶ËÎÂ¶ÈÓ¦¸Ã»á½µµÍ,½µµÍµÄ·ù¶È¹À¼ÆÔÚ3¶ÈÒÔÉÏ
2163   1        //ÓÐ¼ÓÈÈË¿µÄÎÞË®ÅÐ¶Ï£¬³öÆø¿ÚÎÂ¶È¸ßÓÚÈËÌå¶ËÎÂ¶È£¬¼ÓÈÈÅÌÎÂ¶ÈÔÚ100¶ÈÒÔÉÏ£¬ÈËÌå¶ËÊª¶ÈµÍÓÚ80%£¬»òÕßÓÐ20%×óÓÒµÄ
             -ÏÂ½µ
2164   1        //ÎÞ¼ÓÈÈË¿µÄÅÐ¶Ï£¬Èç¹ûË®·Ö²»¹»£¬¹À¼ÆÊÇÈËÌå¶ËÎÂ¶È½ÏµÍ£¬¼ÓÈÈÅÌÎÂ¶ÈÔÚ100¶ÈÒÔÉÏ
2165   1        if(HeaterPlate_State!=(uint8_t)0)
2166   1        {
2167   2          //do nothing
2168   2        }
2169   1        else
2170   1        {     
2171   2          Clear_bit(&ERR_Kind,Alarm_Const_NoWater);     
2172   2        } 
2173   1         
2174   1        if(RT_SHIDU >= 900) //±ãÓÚ¿ìËÙ¼ì²â£¬Ö»ÒªÊª¶È´ïµ½90%³ÖÐø10S£¬È»ºóÁ¬Ðø2·ÖÖÓÐ¡ÓÚ60%Ôò±¨¾¯
2175   1        {    
2176   2          RT_SHIDU_More_then_90_Cnt++;
2177   2          if(RT_SHIDU_More_then_90_Cnt >= 10)//Á¬Ðø10Ãë³¬¹ý90%
2178   2          {
2179   3            RT_SHIDU_More_then_90_Cnt = 10;
2180   3          }
2181   2        }
2182   1        else
2183   1        {
2184   2          if(RT_SHIDU_More_then_90_Cnt < 10)//Ð¡ÓÚ90%ÇÒÔÚ10´ÎÒÔÄÚÔòÇåÁã,10´ÎÒÔÉÏÔò²»ÇåÁã
2185   2          {
2186   3            RT_SHIDU_More_then_90_Cnt = 0;
2187   3          }
2188   2        }    
2189   1      
2190   1        //¸ÉÉÕ±¨¾¯  <60% 
2191   1        //if(Work_Min>=20||Work_Day>0 ||Work_Hour>0) //|| RT_SHIDU_More_then_90_Cnt >= 10)
2192   1        if(Working_Normal >= 1200)
2193   1        {
2194   2          if(RT_SHIDU<600) //Á¬Ðø2·ÖÖÓÉÙÓÚ60%±¨¾¯  ÈÏÎªÊÇ¸ÉÉÕ£¬±ØÐëÖØÆô»úÆ÷
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 37  

2195   2          {           
2196   3            if(No_Water_Times<240) 
2197   3            {
2198   4              No_Water_Times++;
2199   4            }       
2200   3            if(RTD_Sensor_Err!=(uint8_t)0 || SHIDU_Sensor_Err!=(uint8_t)0) //´«¸ÐÆ÷´íÎó²»¿ÉÒÀÊª¶ÈÀ´¼ì²âÎÞË®±¨¾¯
2201   3            {
2202   4              No_Water_Times = 0;
2203   4            }
2204   3          }
2205   2          else
2206   2          {
2207   3            No_Water_Times=0;
2208   3          }
2209   2          if( No_Water_Times>=120)
2210   2          {
2211   3            Set_bit(&ERR_Kind,Alarm_Const_NoWater);
2212   3          } 
2213   2        }
2214   1         
2215   1        if(RT_SHIDU>650)//ÎÂ¶È´óÓÚ65%£¬È¡ÏûÎÞË®±¨¾¯
2216   1        {
2217   2         No_Water_Times=0;
2218   2         Clear_bit(&ERR_Kind,Alarm_Const_NoWater);
2219   2        }
2220   1      
2221   1        //============================================================
2222   1        //ÈËÌå¶ËÎÂ¶È´ïµ½Ê¶±ð180S 
2223   1        //if(Work_Mode==Invasive_Mode) //ÓÐ´´Ä£Ê½
2224   1        //if(1) //
2225   1        {
2226   2          if(RT_Temp >= (Set_RT_Temp - 15)) //±ãÓÚ¿ìËÙ¼ì²â£¬Ö»Òª´ïµ½Éè¶¨ÎÂ¶È-1.5¶È10S£¬È»ºóÁ¬Ðø2·ÖÖÓÐ¡ÓÚ60%Ôò±¨¾¯
2227   2          {    
2228   3            RT_Temp_Reach_Set_Cnt++;
2229   3            if(RT_Temp_Reach_Set_Cnt >= 180)//Á¬Ðø180Ãë³¬¹ýÉè¶¨-1
2230   3            {
2231   4              RT_Temp_Reach_Set_Cnt = 180;
2232   4            }
2233   3          }
2234   2          else
2235   2          {
2236   3            if(RT_Temp_Reach_Set_Cnt < 180)//Ð¡ÓÚÉè¶¨ÇÒÔÚ10´ÎÒÔÄÚÔòÇåÁã,10´ÎÒÔÉÏÔò²»ÇåÁã
2237   3            {
2238   4              RT_Temp_Reach_Set_Cnt = 0;
2239   4            }
2240   3          }
2241   2        } 
2242   1          
2243   1        if(Work_Mode==Noninvasive_Mode)//ÎÞ´´Ä£Ê½
2244   1        {
2245   2          a = Const_NoninvasPatientTemp_Max+10;//¸ßÎÂ±¨¾¯ÏÞÖµ
2246   2          if(WireIn_State!=0)//ÓÐ¼ÓÈÈË¿µ¥Ö§»òË«Ö§
2247   2          {
2248   3            b = Const_NoninvasPatientTemp_Min-10;//ÎÞ´´µÍÎÂ±¨¾¯ÏÞÖµ 29¶È
2249   3          }
2250   2          else 
2251   2          {
2252   3            b = 260;//ÎÞ»ØÂ·¼ÓÈÈË¿Ê±ÎÞ´´µÍÎÂ±¨¾¯Îª26¶È
2253   3          }
2254   2          //c = 700;//µÍÊª±¨¾¯ÏÞÖµ V2.0
2255   2          c = 300;//µÍÊª±¨¾¯ÏÞÖµ V2.02 ÎÞ´´Ä£Ê½È¡ÏûµÍÊª¶È±¨¾¯
2256   2        }
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 38  

2257   1        else if(Work_Mode==Invasive_Mode) //ÓÐ´´Ä£Ê½
2258   1        {
2259   2          a = Const_InvasPatientTemp_Max+10;
2260   2          if(WireIn_State!=0)//ÓÐ¼ÓÈÈË¿µ¥Ö§»òË«Ö§
2261   2          {
2262   3            b = Const_InvasPatientTemp_Min-10;//ÓÐ´´µÍÎÂ±¨¾¯ÏÞÖµ 34¶È
2263   3          }
2264   2          else
2265   2          {
2266   3            b = 290;//ÎÞ»ØÂ·¼ÓÈÈË¿Ê±ÓÐ´´±¨¾¯Îª29¶È
2267   3          }
2268   2      
2269   2          c = 800;//µÍÊª±¨¾¯ÏÞÖµ
2270   2        }
2271   1        else
2272   1        {
2273   2          //do nothing
2274   2        }
2275   1      
2276   1        if(Diplay_RTtemp>a)
2277   1        {
2278   2          if(HiTemp_Count<240)
2279   2          {
2280   3            HiTemp_Count++;
2281   3          }     
2282   2        }else
2283   1        {
2284   2          HiTemp_Count=0;
2285   2        } 
2286   1          
2287   1      /*    
2288   1          ÎªÓ¦¶ÔÈÈ±ÈìÊ£¬Ôö¼ÓÐÂµÄµÍÎÂ±¨¾¯Âß¼­£¬ÐèÒªÍ¬Ê±Âú×ãÒÔÏÂÌõ¼þ´¥·¢µÍÎÂ±¨¾¯
2289   1            1£¬ÓÐ´´Ä£Ê½
2290   1            2£¬µ¥Ö§»òË«Ö§¼ÓÈÈ»ØÂ·Ä£Ê½
2291   1            3£¬»¼Õß¶Ë´ïµ½Éè¶¨ÎÂ¶È-1¶È Á¬Ðø180S£¬·ÀÖ¹Îó¶¯×÷
2292   1            4£¬»¼Õß¶ËµÍÓÚÉè¶¨ÎÂ¶È-2¶ÈÇÒ»ØÂ·¼ÓÈÈ¹¦ÂÊÎªÈ«¹¦ÂÊ(190)Á¬Ðø10S*/
2293   1      
2294   1      //ÈËÌå¶ËµÍÎÂ±¨¾¯    
2295   1        //if(Work_Min>=20||Work_Day>0 ||Work_Hour>0)// || RT_Temp_Reach_Set_Cnt >= 180)  //ÈËÌåµÍÎÂ±¨¾¯
2296   1        if(Working_Normal >= 1200)//20·ÖÖÓ
2297   1        {
2298   2          if((RT_Temp_Reach_Set_Cnt >= 180)//´ïµ½ÎÂ¶ÈÁ¬Ðø180S
2299   2          //&&(WireIn_State!=0)//ÓÐ¼ÓÈÈË¿µ¥Ö§»òË«Ö§
2300   2          &&(Diplay_RTtemp <= ((uint16_t)Set_RT_Temp - 30)))//ÎÂ¶ÈµÍÓÚÉè¶¨ÎÂ¶È3¶È //ÆøÔ´ÖÐ¶Ï»òÌ½Í·ÍÑÂä      
2301   2          {
2302   3            if(((WireIn_State!=0) && (Micro_Temp_In >= 190)))//ÓÐ¼ÓÈÈË¿µ¥Ö§»òË«Ö§
2303   3             //||(WireIn_State==0))//ÎÞ·¢ÈÈË¿²»Ò»¶¨ÊÇÈ«¹¦ÂÊ¼ÓÈÈ ÎÞ·¢ÈÈË¿²»Ê¹ÓÃ 
2304   3      
2305   3            {
2306   4              if(LoTemp_Count<240)
2307   4              {
2308   5                LoTemp_Count+= 12;  //µ±ÎÂ¶È´ïµ½Éè¶¨ÎÂ¶Èºó£¬Á¬Ðø10SÏÂ½µµ½Éè¶¨ÎÂ¶È-2.5¶È£¬µÍÎÂ±¨¾¯ 
2309   5              }         
2310   4            }
2311   3            else 
2312   3            {
2313   4             //if(LoTemp_Count<240) LoTemp_Count++; //µ±ÎÂ¶È´ïµ½Éè¶¨ÎÂ¶Èºó£¬Á¬Ðø10SÏÂ½µµ½Éè¶¨ÎÂ¶È-2.5¶È£¬µÍÎÂ±¨¾¯ 
2314   4            }
2315   3          }
2316   2          else if(Diplay_RTtemp<b)//55·ÖÖÓ¿ªÊ¼¼ì²âÎÂ¶È¹ýµÍ±¨¾¯
2317   2          {
2318   3            if(Working_Normal >= 3300)
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 39  

2319   3            {
2320   4              if(LoTemp_Count<240) 
2321   4              {
2322   5                LoTemp_Count++;
2323   5              }
2324   4            }
2325   3          }
2326   2          else
2327   2          {
2328   3            LoTemp_Count=0;
2329   3          }
2330   2        }
2331   1        else
2332   1        {
2333   2          LoTemp_Count=0;
2334   2        }
2335   1      
2336   1      //ÈËÌå¶ËµÍÊª±¨¾¯      
2337   1        //if(Work_Min>=20||Work_Day>0 ||Work_Hour>0)// || RT_SHIDU_More_then_90_Cnt >= 10)   //ÈËÌåµÍÊª±¨¾¯
2338   1        if(Working_Normal >= 1200)
2339   1        {
2340   2          if(RT_SHIDU<c)    //2014-07-23    µÍÊª¶È±¨¾¯
2341   2          {
2342   3            if(LoHumity_Count<250) 
2343   3            {
2344   4              LoHumity_Count++;
2345   4            }       
2346   3          }
2347   2          else
2348   2          {
2349   3            LoHumity_Count=0;
2350   3          }
2351   2        }
2352   1        else
2353   1        {
2354   2           LoHumity_Count=0;
2355   2        }  
2356   1       
2357   1      //³öÆø¿ÚµÍÎÂ±¨¾¯
2358   1        //if(CQK_Temp >= Set_CQK_Temp - 10) //±ãÓÚ¿ìËÙ¼ì²â£¬Ö»Òª´ïµ½Éè¶¨ÎÂ¶È10S£¬È»ºóÁ¬Ðø2·ÖÖÓÐ¡ÓÚ60%Ôò±¨¾¯
2359   1        if(CQK_Temp >= 300) //±ãÓÚ¿ìËÙ¼ì²â£¬Ö»Òª´ïµ½Éè¶¨ÎÂ¶È10S£¬È»ºóÁ¬Ðø2·ÖÖÓÐ¡ÓÚ60%Ôò±¨¾¯
2360   1        {    
2361   2          CQK_Temp_Reach_Set_Cnt++;
2362   2          if(CQK_Temp_Reach_Set_Cnt >= 10)//Á¬Ðø10Ãë´ïµ½
2363   2          {
2364   3            CQK_Temp_Reach_Set_Cnt = 10;
2365   3          }
2366   2        }
2367   1        else
2368   1        {
2369   2          if(CQK_Temp_Reach_Set_Cnt < 10)//10´ÎÒÔÄÚÔòÇåÁã,10´ÎÒÔÉÏÔò²»ÇåÁã
2370   2          {
2371   3            CQK_Temp_Reach_Set_Cnt = 0;
2372   3          }
2373   2        } 
2374   1      
2375   1        if(Working_Normal >= 1200)
2376   1        {
2377   2          if((CQK_Temp < (Const_NoninvasChamberTemp_Min - 10))
2378   2           &&(Work_Mode==Invasive_Mode))//ÓÐ´´Ä£Ê½²ÅÓÐ³öÆø¿ÚµÍÎÂ±¨¾¯
2379   2          {
2380   3            if(LoTemp_CQK_Count<240)
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 40  

2381   3            {
2382   4              if(CQK_Temp_Reach_Set_Cnt>= 10)//Èô´ïµ½¹ýÎÂ¶ÈÔò¼Ó¿ìËÙ¶È
2383   4              {
2384   5                //LoTemp_CQK_Count += 12;
2385   5                LoTemp_CQK_Count++;
2386   5              }
2387   4              else
2388   4              {
2389   5                LoTemp_CQK_Count++;
2390   5              }
2391   4            }
2392   3          }
2393   2          else
2394   2          {
2395   3            LoTemp_CQK_Count=0;
2396   3          }     
2397   2        }
2398   1        else
2399   1        {
2400   2          LoTemp_CQK_Count=0;
2401   2        }
2402   1      }
2403          
2404          void SaveDateToFlashFunc(void)
2405          {
2406   1        static uint8_t     Enable_Save_Data=0;  //±£´æÊý¾Ý¼ÆÊý
2407   1        uint16_t a,b,c;//
2408   1        UINT32 Adress;  
2409   1        if(Enable_Save_Data>=1)
2410   1        {
2411   2          Enable_Save_Data++;
2412   2          if(Enable_Save_Data>=10)
2413   2          {
2414   3            Enable_Save_Data=0;
2415   3          }     
2416   2        }
2417   1        if(Enable_Save_Data==2)
2418   1        {
2419   2          if(((Run_Count-1)%256)==0)//Ò»¸öÉÈÇøÎª4K£¬Ã¿´Î´æ´¢µÄÊý¾ÝÎª16×Ö½Ú£¬¼´256×éÊý¾Ý¼´Îª4K 256*16=4096;
2420   2          {
2421   3            //Çå³ýÏÂÃæ256µÄÊý¾Ý
2422   3            Adress=Run_Count-1;  //¼ÙÉèÎª257-1=256
2423   3            Adress=(Adress<<4);  //  256*16= 4096
2424   3            Adress=Adress+0x2000;//ÆðÊ¼µØÖ·Îª0X2000£¬¼´8192Îª±£Áô×Ö½Ú
2425   3            SPI_Erase_Sector(Adress);
2426   3          }
2427   2        }
2428   1        else  if(Enable_Save_Data==3)//´æ·ÅÊý¾Ý
2429   1        {
2430   2          Adress=Run_Count-1;
2431   2          Adress=(Adress<<4);
2432   2          Adress=Adress+0x2000; 
2433   2           
2434   2          {
2435   3            RX8010_GetTime(SaveData);
2436   3      
2437   3            //LCD_ShowxNum(POS_RT_RH_X-40,5,16,3,SaveData[2],0x80,BLACK18); //
2438   3      
2439   3            a = ((SaveData[2]&(uint8_t)0x0F)%10) + (((SaveData[2]>>(uint8_t)4)& (uint8_t)0x03)*10);
2440   3            SaveData[2] = (uint8_t)a;//×ª»»Îª24Ð¡Ê±ÖÆÐ¡Ê±
2441   3      
2442   3            //LCD_ShowxNum(POS_RT_RH_X-40,45,16,3,SaveData[2],0x80,BLACK18); //
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 41  

2443   3            
2444   3            if(SaveData[2] >= 12)
2445   3            {
2446   4              a = (uint16_t)((u8)0x80 | (u8)0x20);//PM
2447   4              SaveData[2] -= 12;
2448   4            }
2449   3            else
2450   3            {
2451   4              a = 0x80;//AM
2452   4            }
2453   3            b = SaveData[2]/10;
2454   3            c = SaveData[2]%10;
2455   3            SaveData[2] = (uint8_t)(((b << 4) + c) | a);//Ê±¼ä×ª»»ÎªDS1302¸ñÊ½
2456   3             
2457   3             //LCD_ShowxNum(POS_RT_RH_X-40,95,16,3,SaveData[2],0x80,BLACK18); //
2458   3          }
2459   2              
2460   2          SaveData[7]=ERR_Kind;
2461   2          if(RTD_Sensor_Err!=(uint8_t)0) 
2462   2          {
2463   3            SaveData[7]|=(uint8_t)0x20;
2464   3          }
2465   2          if(CQK_Sensor_Err!=(uint8_t)0)
2466   2          {
2467   3            SaveData[7]|=(uint8_t)0x40;
2468   3          }     
2469   2          if(JRP_Sensor_Err!=(uint8_t)0)
2470   2          {
2471   3            SaveData[7]|=(uint8_t)0x80;
2472   3          }             
2473   2          SaveData[8]=(uint8_t)(RT_Temp/256);
2474   2          SaveData[9]=(uint8_t)(RT_Temp%256);
2475   2          SaveData[10]=(uint8_t)(RT_SHIDU/256);
2476   2          SaveData[11]=RT_SHIDU%256; 
2477   2          //SaveData[10]=CONTROL_RT_SHIDU/256;  //2015-06-04 ´æ´¢ÕæÊµµÄÊª¶È
2478   2          //SaveData[11]=CONTROL_RT_SHIDU%256; 
2479   2      
2480   2          SaveData[12]=(uint8_t)(CQK_Temp/256);     
2481   2          SaveData[13]=(uint8_t)(CQK_Temp%256);
2482   2          SaveData[14]=(uint8_t)(JEP_Temp/256);
2483   2          SaveData[15]=(uint8_t)(JEP_Temp%256);
2484   2          SPI_Write_nBytes(Adress,16,&SaveData[0]);
2485   2      
2486   2        }
2487   1        else if(Enable_Save_Data==4)  //´æ·ÅÊý¾ÝµØÖ·
2488   1        {
2489   2          Store_Data();      
2490   2        }
2491   1        else if(Enable_Save_Data==5)  //²Áµ÷Êý¾Ý
2492   1        {
2493   2          //Çå³ýËùÓÐÊý¾Ý,ÖØÐÂ¼ÆÊý
2494   2          if(Run_Count>=44896) 
2495   2          {
2496   3            SPI_Erase_Sector(0x000);
2497   3          }
2498   2        }
2499   1        else if(Enable_Save_Data==6)  //²Áµ÷Êý¾Ý
2500   1        {
2501   2          //Çå³ýËùÓÐÊý¾Ý,ÖØÐÂ¼ÆÊý
2502   2          if(Run_Count>=44896) 
2503   2          { 
2504   3            SPI_Erase_Sector(0x1000);        
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 42  

2505   3            Run_Count=0;
2506   3          }  
2507   2        } 
2508   1        else if(Enable_Save_Data==9)  //²ÁÊý¾Ý
2509   1        {
2510   2          //do nothing
2511   2        } 
2512   1        else
2513   1        {
2514   2          //do nothing
2515   2        }
2516   1      }
2517          
2518          
2519          void  Init_port(void) //³õÊ¼»¯¶Ë¿Ú×´Ì¬--------------------------------
2520          {
2521   1        uint16_t j=0;
2522   1      
2523   1        P1M1=0x08;  //P13Îª¸ß×èÊäÈë Wire_out_FB
2524   1        P1M0=0x0;
2525   1        P2M1=0x70;//P24-P26È«Éè¶¨³É¿ªÂ©Êä³ö
2526   1        P2M0=0xF0;
2527   1        P3M1=0x18;  //P34,P33Îª¸ß×èÊäÈë Wire_In_FB  Plant_FB 
2528   1        P3M0=0x64;  //P35,P36,P32ÎªÇ¿Êä³ö  Heat_Plant_Out  Heat_Wire_In  Heat_JRP_EN_OUT  
2529   1        P4M1=0x00;  //IO Port initialization
2530   1        P4M0=0x09;  //P40,P43ÎªÇ¿Êä³ö
2531   1        P4SW=0x70;  
2532   1      
2533   1        WDT_CONTR = 0x3F; //WDT Enable(4.55S)   
2534   1        LCD_LIGHT_CLOSE;  
2535   1        Rec_Count=0;
2536   1        Buzzer_Port=0;
2537   1        Heat_JRP_Port=0;
2538   1        Heat_WireIn_Port=0;
2539   1        Heat_WireOut_Port=0;
2540   1        Heat_WIRE_EN_OUT = 1;
2541   1        EX1=1;
2542   1        IT1=1;   
2543   1        LCD_1DIR_L;     
2544   1        JEP_Temp=0;
2545   1        EA=1;  //
2546   1         
2547   1        EUSART_Initialize();//Uart initialization
2548   1        SPI_init();//SPI Flash initialization
2549   1        LCD_Initial();//TFT LCD initialization  
2550   1         
2551   1        //Holding down these two keys for three seconds at boot time will enter service mode. 
2552   1        if((KEY_LEFT_UP_IN==0)&&(KEY_LEFT_DOWN_IN==0))
2553   1        {
2554   2          Work_State = UI_STATE_SERVICE_MODE;
2555   2        }
2556   1        else
2557   1        {
2558   2          Work_State = UI_STATE_POST_MODE;
2559   2        }
2560   1        
2561   1      //Holding down these two keys for three seconds at boot time will enter Data Reading Interface. 
2562   1        if((KEY_LEFT_DOWN_IN==0) &&(KEY_RIGHT_DOWN_IN==0))
2563   1        {
2564   2          Work_State = UI_STATE_DATAREADER_MODE;//Êý¾Ý´«Êä½çÃæ
2565   2          ET0=0;
2566   2          TR0=0;
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 43  

2567   2          Back_Color=WHITE18; 
2568   2      
2569   2          Draw_Rectangle_Real(0,0,239,319,WHITE18);
2570   2      //Display Data Reading Interface=============== DATA OUTPUT...
2571   2          for(j=4;j<8;j++)
2572   2          {
2573   3              DISP_FNT10X24(115,100+((j-4)*12),(uint8_t)j,BLUE18);
2574   3          }
2575   2          for(j=j;j<14;j++)
2576   2          {
2577   3              DISP_FNT10X24(115,100+((j-3)*12),(uint8_t)j,BLUE18);
2578   3          }   
2579   2          DISP_FNT10X24(115,100+(11*12),14,BLUE18);
2580   2          DISP_FNT10X24(115,100+(12*12),14,BLUE18);
2581   2          DISP_FNT10X24(115,100+(13*12),14,BLUE18); 
2582   2      
2583   2      //Display soft version
2584   2          LCD_Show_Verion();  
2585   2          LCD_LIGHT_OPEN;
2586   2        }
2587   1        
2588   1        Test_Mode_Dis_Jrp_Ctl = DISPLAY_TEST_DATA_EN_DIS_DEF; //LCD Displays Working Data at Runningtime
2589   1      }
2590          
2591          void  Main_Init(void) //Ö÷³ÌÐò³õÊ¼»¯
2592          {
2593   1        Get_RunCount();  //µÃµ½´æ·ÅÊý¾ÝµÄÌõÊý  
2594   1      
2595   1        Diplay_RTtemp = (uint16_t)RT_Temp;
2596   1        
2597   1        CQK_Sensor_Err=(uint8_t)0;
2598   1        RTD_Sensor_Err=(uint8_t)0;
2599   1        JRP_Sensor_Err=(uint8_t)0;
2600   1        SHIDU_Sensor_Err=(uint8_t)0;
2601   1      
2602   1        Back_Color=BRIGHT_BLUE18 ;
2603   1      
2604   1        WireOut_State=0;
2605   1        WireIn_State=0;   
2606   1      
2607   1        Wire_Mode_Sel = Wire_Sel_Double;//Ä¬ÈÏÎªË«Ö§¼ÓÈÈ»ØÂ·
2608   1        Wire_Mode_Mismatch = (uint8_t)0;//»ØÂ··¢ÈÈË¿Ä£Ê½ºÍÊµ¼Ê²»Æ¥Åä±êÖ¾
2609   1      
2610   1        Wire_Warm_Up_Sec = 0; //µ±<=300Ê±ÏÞÖÆ×î´ó¼ÓÈÈ¹¦ÂÊ
2611   1        Plate_Warm_Up_Sec = 0;
2612   1      
2613   1        Set_CQK_Temp_Comp = 360;//³õÊ¼»¯
2614   1        Humidity_No_Change_Sec = 0;//Êª¶È²»¸Ä±äµÄ¼ÆÊý 
2615   1        
2616   1        JEP_Temp_Aim = (INT)(Set_CQK_Temp + 100);     //¼ÓÈÈÅÌÄ¿±êÎÂ¶È 400 - 530
2617   1        Controler_temp3.Sum_error = 0;
2618   1        Controler_temp3.Ek = 0;
2619   1        Controler_temp3.Ek1 = 0;
2620   1        Controler_temp3.Ek2 = 0;
2621   1      }
2622          
2623          
2624          
2625          //²âÊÔÄ£Ê½Ê±ÏÔÊ¾ÎÂ¶È
2626          //ºÍÕý³£¹¤×÷Ê±µÄÇø±ðÔÚÓÚÊµÊ±ÐÔ
2627          void ServiceMode_TempHumidy_Disp(void)
2628          {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 44  

2629   1        uint16_t Disp,color;
2630   1      //  bit Disp_Err;
2631   1        Back_Color=WHITE18; 
2632   1      //  Disp_Err=0;   
2633   1      
2634   1        if((CQK_Temp>=0x0FFF) || (No_CQKSensor_Times>20) ) //³öÆø¿ÚÎÂ¶È´«¸ÐÆ÷´íÎó¼ì²â
2635   1        {
2636   2          CQK_Sensor_Err=(uint8_t)1;
2637   2          CQK_Temp = 0;
2638   2        }
2639   1        else
2640   1        {
2641   2          CQK_Sensor_Err=(uint8_t)0;
2642   2        }
2643   1          
2644   1        if(No_ReadData_SHIDU_Times>(uint8_t)10)//ÈËÌå¶ËÊª¶È´«¸ÐÆ÷´íÎó¼ì²â
2645   1        {
2646   2          SHIDU_Sensor_Err=(uint8_t)1;
2647   2          RT_SHIDU = 0; 
2648   2        }   
2649   1        else
2650   1        {
2651   2          SHIDU_Sensor_Err=(uint8_t)0;
2652   2        }
2653   1      
2654   1        if((No_ReadData_Temp_Times>20) || (ERR_RT_Temp_Times>10))//ÈËÌå¶ËÎÂ¶È´«¸ÐÆ÷´íÎó¼ì²â 2014-07-03
2655   1        {    
2656   2          RTD_Sensor_Err=(uint8_t)1;
2657   2          RT_Temp = 0;    
2658   2          Diplay_RTtemp = 0;
2659   2        }
2660   1        else
2661   1        {
2662   2          RTD_Sensor_Err=(uint8_t)0;
2663   2        }
2664   1          
2665   1            
2666   1        if( No_HeatSensor_Times>20)//¼ÓÈÈÅÌ´«¸ÐÆ÷´íÎó¼ì²â
2667   1        {
2668   2          JRP_Sensor_Err=(uint8_t)1;
2669   2          JEP_Temp = 0;
2670   2        }
2671   1        else
2672   1        {
2673   2          JRP_Sensor_Err=(uint8_t)0;
2674   2        }
2675   1          
2676   1      
2677   1        //ÈËÌå¶ËÎÂ¶È
2678   1        {
2679   2          Disp=(uint16_t)RT_Temp;
2680   2      //    Disp_Err=RTD_Sensor_Err;      
2681   2        }
2682   1        color=BLACK18;   
2683   1      
2684   1        if(Disp>=1000)
2685   1        {
2686   2          DISP_TEMP_30X56((POS_RT_TEMP_X-8),POS_RT_TEMP_Y,(Disp/1000)%10,(uint8_t)color);  
2687   2          DISP_TEMP_30X56(POS_RT_TEMP_X-8,POS_RT_TEMP_Y+34,(uint8_t)((Disp%1000)/100),(uint8_t)color);   
2688   2          DISP_TEMP_30X56(POS_RT_TEMP_X-8,POS_RT_TEMP_Y+73,(Disp%100)/10,(uint8_t)color);    
2689   2          Draw_Rectangle_Real(POS_RT_TEMP_X+1-8,POS_RT_TEMP_Y+67,POS_RT_TEMP_X+8-8,POS_RT_TEMP_Y+71,WHITE18); //È¥
             -µôÐ¡Êýµã
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 45  

2690   2        }
2691   1        else
2692   1        {
2693   2          DISP_TEMP_30X56(POS_RT_TEMP_X-8,POS_RT_TEMP_Y,(Disp/100)%10,(uint8_t)color);  
2694   2          DISP_TEMP_30X56(POS_RT_TEMP_X-8,POS_RT_TEMP_Y+34,Disp%100/10,(uint8_t)color);   
2695   2          DISP_TEMP_30X56(POS_RT_TEMP_X-8,POS_RT_TEMP_Y+(34*2)+5,Disp%10,(uint8_t)color);    
2696   2          Draw_Rectangle_Real(POS_RT_TEMP_X+1-8,POS_RT_TEMP_Y+67,POS_RT_TEMP_X+8-8,POS_RT_TEMP_Y+71,(uint8_t)color
             -); //»­µã
2697   2        }     
2698   1      
2699   1        //³öÆø¿ÚÎÂ¶È
2700   1        Disp=(uint16_t)CQK_Temp; 
2701   1        if(Disp>=1000)
2702   1        {
2703   2          DISP_RH_17X40(55,POS_RT_TEMP_Y,(Disp/1000)%10,(uint8_t)color);  
2704   2          DISP_RH_17X40(55,POS_RT_TEMP_Y+20,(uint8_t)((Disp%1000)/100),(uint8_t)color);   
2705   2          DISP_RH_17X40(55,POS_RT_TEMP_Y+(20*2)+5,(Disp%100)/10,(uint8_t)color);    
2706   2          Draw_Rectangle_Real(56,POS_RT_TEMP_Y+40,61,POS_RT_TEMP_Y+43,WHITE18); //È¥µôÐ¡Êýµã
2707   2        }
2708   1        else
2709   1        {
2710   2          DISP_RH_17X40(55,POS_RT_TEMP_Y,(Disp/100)%10,(uint8_t)color);  
2711   2          DISP_RH_17X40(55,POS_RT_TEMP_Y+20,Disp%100/10,(uint8_t)color);   
2712   2          DISP_RH_17X40(55,POS_RT_TEMP_Y+(20*2)+5,Disp%10,(uint8_t)color);    
2713   2          Draw_Rectangle_Real(56,POS_RT_TEMP_Y+40,61,POS_RT_TEMP_Y+43,(uint8_t)color); //»­µã
2714   2        }
2715   1         
2716   1        //¼ÓÈÈÅÌÎÂ¶È
2717   1        Disp=(uint16_t)JEP_Temp;
2718   1        if(Disp>=1000)
2719   1        {
2720   2          DISP_RH_17X40(5,POS_RT_TEMP_Y,(Disp/1000)%10,(uint8_t)color);  
2721   2          DISP_RH_17X40(5,POS_RT_TEMP_Y+20,(uint8_t)((Disp%1000)/100),(uint8_t)color);   
2722   2          DISP_RH_17X40(5,POS_RT_TEMP_Y+(20*2)+5,(Disp%100)/10,(uint8_t)color);    
2723   2          Draw_Rectangle_Real(51,POS_RT_TEMP_Y+40,56,POS_RT_TEMP_Y+43,WHITE18); //È¥µôÐ¡Êýµã
2724   2        }
2725   1        else
2726   1        {
2727   2          DISP_RH_17X40(5,POS_RT_TEMP_Y,(Disp/100)%10,(uint8_t)color);  
2728   2          DISP_RH_17X40(5,POS_RT_TEMP_Y+20,Disp%100/10,(uint8_t)color);   
2729   2          DISP_RH_17X40(5,POS_RT_TEMP_Y+(20*2)+5,Disp%10,(uint8_t)color);    
2730   2          Draw_Rectangle_Real(6,POS_RT_TEMP_Y+40,11,POS_RT_TEMP_Y+43,(uint8_t)color); //»­µã
2731   2        } 
2732   1      
2733   1        //ÏÔÊ¾Êª¶È
2734   1        { 
2735   2          DISP_RH_17X40(POS_RT_RH_X+2,POS_RT_RH_Y,(uint8_t)(RT_SHIDU%1000/100),(uint8_t)color);
2736   2          DISP_RH_17X40(POS_RT_RH_X+2,POS_RT_RH_Y+19,RT_SHIDU%100/10,(uint8_t)color);
2737   2        }   
2738   1      }
2739          
2740          //½«Éè¶¨µÄ²ÎÊýÐ´Èëµ½STC EEPROM
2741          //×¢Òâ£º¿ª»úÊ±±ØÐë°ÑFLASHµÄÊý¾Ý¶ÁÈëµ½RAMÄÚ
2742          void Setting_write_to_flash(void)
2743          { 
2744   1        STC_IAP_Sector_Erase(DATA_FLASH_ADDRESS_Set_RT_YCTemp);           //²Á³ýÕû¸öÉÈÇø
2745   1        STC_IAP_Byte_Program(DATA_FLASH_ADDRESS_First, data_flash.First);//½« DEBUG_DATA Ð´Èë EEPROM
2746   1        STC_IAP_Byte_Program(DATA_FLASH_ADDRESS_Work_Mode, data_flash.Work_Mode);//
2747   1        STC_IAP_Byte_Program(DATA_FLASH_ADDRESS_Set_RT_WCTemp, data_flash.Set_RT_WCTemp);//
2748   1        STC_IAP_Byte_Program(DATA_FLASH_ADDRESS_Set_RT_YCTemp, data_flash.Set_RT_YCTemp);//
2749   1        STC_IAP_Byte_Program(DATA_FLASH_ADDRESS_In_Exp_Ratio, data_flash.In_Exp_Ratio);//
2750   1        STC_IAP_Byte_Program(DATA_FLASH_ADDRESS_Set_CQK_WCTemp, data_flash.Set_CQK_WCTemp);//
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 46  

2751   1        STC_IAP_Byte_Program(DATA_FLASH_ADDRESS_Set_CQK_YCTemp, data_flash.Set_CQK_YCTemp);//
2752   1        STC_IAP_Byte_Program(DATA_FLASH_ADDRESS_Language, data_flash.Language);//
2753   1      }
2754          
2755          //½«Ä¬ÈÏµÄ²ÎÊýÐ´Èëµ½STC EEPROM
2756          static void Write_Default_Setting_to_flash(void) //°ÑÄ¬ÈÏ³ö³§Éè¶¨Ð´ÈëFLASH
2757          {
2758   1        data_flash.First = 'Z';
2759   1        data_flash.Work_Mode = Invasive_Mode;//ÓÐ´´
2760   1        data_flash.Set_RT_WCTemp = (340/5);//
2761   1        data_flash.Set_RT_YCTemp = (390/5);//
2762   1        data_flash.In_Exp_Ratio = 4;//1:1.3
2763   1        data_flash.Set_CQK_WCTemp = (310/5);//
2764   1        data_flash.Set_CQK_YCTemp = (360/5);//
2765   1        //data_flash.Language = Lan_English;
2766   1      
2767   1        Setting_write_to_flash();//Ð´Èëµ½FLASH
2768   1      }
2769          
2770          
2771          void Mem_Flash_Recall(void) //¶ÁÈ¡ÉÏ´ÎµÄ¼ÇÒä²¢ÑéÖ¤Êý¾Ý
2772          {
2773   1        data_flash.First = STC_IAP_Byte_Read(DATA_FLASH_ADDRESS_First);    //¶ÁEEPROMµÄÖµ
2774   1        data_flash.Work_Mode = STC_IAP_Byte_Read(DATA_FLASH_ADDRESS_Work_Mode);    
2775   1        data_flash.Set_RT_WCTemp = STC_IAP_Byte_Read(DATA_FLASH_ADDRESS_Set_RT_WCTemp);    
2776   1        data_flash.Set_RT_YCTemp = STC_IAP_Byte_Read(DATA_FLASH_ADDRESS_Set_RT_YCTemp);    
2777   1        data_flash.In_Exp_Ratio = STC_IAP_Byte_Read(DATA_FLASH_ADDRESS_In_Exp_Ratio);  
2778   1        data_flash.Set_CQK_WCTemp = STC_IAP_Byte_Read(DATA_FLASH_ADDRESS_Set_CQK_WCTemp);    
2779   1        data_flash.Set_CQK_YCTemp = STC_IAP_Byte_Read(DATA_FLASH_ADDRESS_Set_CQK_YCTemp); 
2780   1        data_flash.Language = STC_IAP_Byte_Read(DATA_FLASH_ADDRESS_Language); 
2781   1        
2782   1        if( //Ð£ÑéÊý¾ÝÊÇ·ñÕýÈ·
2783   1            (data_flash.First != 'Z')
2784   1            ||(data_flash.Work_Mode > 1) 
2785   1            ||(data_flash.Set_RT_WCTemp > (Const_NoninvasPatientTemp_Max/5)) //370/5 = 74;  
2786   1            ||(data_flash.Set_RT_WCTemp < (Const_NoninvasPatientTemp_Min/5)) //300/5 = 60;  
2787   1            ||(data_flash.Set_RT_YCTemp > (Const_InvasPatientTemp_Max/5)) //400/5 = 80; 
2788   1            ||(data_flash.Set_RT_YCTemp < (Const_InvasPatientTemp_Min/5)) //350/5 = 70;
2789   1            ||(data_flash.In_Exp_Ratio > 6)
2790   1            ||(data_flash.In_Exp_Ratio < 1)
2791   1            ||(data_flash.Set_CQK_WCTemp > (Const_NoninvasChamberTemp_Max/5)) //360/5 = 74;  
2792   1            ||(data_flash.Set_CQK_WCTemp < (Const_NoninvasChamberTemp_Min/5)) //310/5 = 60;  
2793   1            ||(data_flash.Set_CQK_YCTemp > (Const_InvasChamberTemp_Max/5))  //400/5 = 80; 
2794   1            ||(data_flash.Set_CQK_YCTemp < (Const_InvasChamberTemp_Min/5))  //350/5 = 70;
2795   1            ||(data_flash.Language > Lan_French)//×î¶à4ÖÖÓïÑÔ
2796   1          )
2797   1        {
2798   2          data_flash.Language = Lan_English;
2799   2          Write_Default_Setting_to_flash();//°ÑÄ¬ÈÏ³ö³§Éè¶¨Ð´ÈëFLASH
2800   2        }
2801   1      }
2802          
2803          
2804          
2805          void Load_Settings_Before_Choice(void)//ÔÚÑ¡Ôñ·½¿ò³öÏÖÖ®Ç°£¬Òª´¦ÀíµÄÊý¾Ý£¬ÒÔÍ¬Ê±¼æÈÝÓÐÎÞÑ¡Ôñ¼ÇÒä½çÃæ³ÌÐò
2806          {
2807   1        if(defalut_mode == Load_Fac_MODE)  //ÈôÊÇ¹¤³§Ä¬ÈÏÉè¶¨  
2808   1        {
2809   2          Write_Default_Setting_to_flash();//°ÑÄ¬ÈÏ³ö³§Éè¶¨Ð´ÈëFLASH
2810   2        }
2811   1      
2812   1        Work_Mode = data_flash.Work_Mode;  //¹¤×÷Ä£Ê½
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 47  

2813   1        Set_RT_WCTemp = data_flash.Set_RT_WCTemp * 5;//
2814   1        Set_RT_YCTemp = data_flash.Set_RT_YCTemp * 5;//
2815   1        Set_CQK_WCTemp = data_flash.Set_CQK_WCTemp * 5;//
2816   1        Set_CQK_YCTemp = data_flash.Set_CQK_YCTemp * 5;//
2817   1        In_Exp_Ratio = data_flash.In_Exp_Ratio;  //
2818   1      
2819   1        if(Work_Mode==0)  
2820   1        {     
2821   2          Set_RT_Temp=(INT)Set_RT_WCTemp;
2822   2          Set_CQK_Temp=Set_CQK_WCTemp;
2823   2        }
2824   1        else
2825   1        {
2826   2          Set_RT_Temp=(INT)Set_RT_YCTemp; 
2827   2          Set_CQK_Temp=Set_CQK_YCTemp; 
2828   2        }
2829   1      }
2830          
2831          /*µÍ¹¦ÂÊÄ£Ê½
2832          ¹¦ÄÜ---½øÈë´ý»úÄ£Ê½Ê±£¬a,¼ÓÈÈÅÌ¼ÓÈÈÊ±³¤±»ÏÞ¶¨ÔÚ50ÇÒÎÂ¶È²»³¬¹ý50¶È
2833                                 b,»ØÂ··¢ÈÈË¿¼ÓÈÈÊ±³¤±»ÏÞ¶¨ÔÚ40
2834          Ä¿µÄ---µ±³öÏÖÈËÌå¶Ë»ò³öÆø¿ÚµÍÎÂ±¨¾¯Ê±£¬³ýÁËÆøÔ´£¬»ØÂ·±»¶ÂµÈÔ­ÒòÍâ£¬»¹ÓÐ¿ÉÄÜÊÇÌ½Í·ÍÑÂä£¬
2835                  ÈôÍêÈ«²»¼ÓÈÈ£¬ÔòÔÚÓÃ»§Î´¸ÉÔ¤Ê±ÍêÈ«²»¼ÓÈÈÖÁÀäÈ´µ½ÊÒÎÂ£¬ÓÃ»§¿ÉÄÜ»áÈÏÎª»úÆ÷ÓÐÑÏÖØ¹ÊÕÏ
2836                  Èô°´Õý³£Ä£Ê½¼ÓÈÈ£¬Ôò¿ÉÄÜ»áÓÉÓÚÌ½Í·ÍÑÂäµ¼ÖÂ´ó¹¦ÂÊ¼ÓÈÈ£¬ÒýÆð³¬ÎÂ¶ø²úÉú·çÏÕ¡£
2837          ½øÈë´ý»úÄ£Ê½Ìõ¼þ---ÈËÌå¶Ë»ò³öÆø¿Ú³öÏÖµÍÎÂ±¨¾¯£¬ÇÒÓÐ±¨¾¯ÒôÊ±
2838          ÍË³ö´ý»úÄ£Ê½Ìõ¼þ---µÍÎÂ±¨¾¯½â³ý£¬»ò°´ÏûÒô¼ü¿ÉÔÝÊ±ÍË³ö90S
2839          */
2840          void LowPowerModeFunc(void)  
2841          { 
2842   1        if(((LoTemp_Count > (uint8_t)120) || (LoTemp_CQK_Count > (uint8_t)120))||(Bit_is_one(ERR_Kind,Alarm_Const
             -_NoWater)!=(uint8_t)0)) //ÎÞË®(¸ÉÉÕ)±¨¾¯
2843   1        {
2844   2          if(   
2845   2               ((ERR_Kind & (uint8_t)0x01)!=0)//´«¸ÐÆ÷´íÎó
2846   2            || ((ERR_Kind & (uint8_t)0x02)!=0)//¸ßÎÂ
2847   2            || (Wire_Mode_Mismatch == (uint8_t)1)  //·¢ÈÈË¿Î´Ñ¡
2848   2            || (HeaterPlate_State==(uint8_t)0))//Ë®¹ÞÎ´×°ºÃ
2849   2          { 
2850   3          }
2851   2          else  
2852   2          {     
2853   3            if(AlarmSoundPauseStatus == (uint8_t)0)//Î´°´ÏÂ¾²Òô¼ü
2854   3            {
2855   4              Low_Power_Mode_Flag = 1;//µÍ¹¦ÂÊÄ£Ê½±êÖ¾
2856   4              if(JEP_Temp<=450)
2857   4              {       
2858   5                Micro_Temp_Val=50;  //Í£Ö¹¼ÓÈÈ
2859   5              }
2860   4              else
2861   4              {
2862   5                Micro_Temp_Val=0;  //Í£Ö¹¼ÓÈÈ
2863   5              }
2864   4              Micro_Temp_In=40;
2865   4              Micro_Temp_Out=Micro_Temp_In;     
2866   4              Micro_Adj_Mode_Test = 4;//¼ÓÈÈÄ£Ê½²âÊÔ
2867   4            }
2868   3            else
2869   3            {
2870   4              Low_Power_Mode_Flag = 0;
2871   4            }
2872   3          }
2873   2        }
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 48  

2874   1        else
2875   1        {
2876   2          Low_Power_Mode_Flag = 0;
2877   2        }
2878   1          
2879   1      }
2880          
2881          
2882          //ÔöÁ¿ControlerËã·¨
2883          //¦¤U = U(k)-U(k-1) = Kp*[e(k)-e(k-1)]+Ki*e(k)+Kd*[e(k)-2*e(k-1)+e(k-2)]
2884          //* ÆäÖÐ£ºKp¡¢Ki¡¢Kd·Ö±ðÎª±ÈÀý¡¢»ý·ÖºÍÎ¢·Ö·Å´óÏµÊý£¬u(k)±íÊ¾µÚk¸ö²ÉÑùÊ±¿Ì
2885          //µÄ¿ØÖÆÁ¿,e(k)±íÊ¾µÚk¸ö²ÉÑùÊ±¿ÌµÄº½ÏòÊäÈëÆ«²î.
2886          //PIE_UK = Kp*(Ek-Ek1)+Ki*EK+Kd*(Ek+Ek2-EK1)
2887          
2888          //struct Controler
2889          //    {
2890          //      int Uk; //×ÜµÄ¿ØÖÆÁ¿
2891          //      int Uk1;//ÉÏ´ÎµÄ×Ü¿ØÖÆÁ¿
2892          //      int Sum_error;//Îó²î×ÜÁ¿
2893          //      int Ek;//µ±Ç°µÄ×ÜÎó²îÁ¿
2894          //      int Ek1;//Ç°Ò»´ÎµÄÎó²îÁ¿
2895          //      int Ek2;//Ç°¶þ´ÎµÄÎó²îÁ¿       
2896          //       }Controler_temp;//
2897          
2898          //ÓÐ·¢ÈÈË¿Ê±µÄ»¼Õß¶ËÎÂ¶È¿ØÖÆControlerËã·¨---¸ù¾Ý»¼Õß¶ËÄ¿±êÎÂ¶ÈºÍÊµ¼ÊÎÂ¶È£¬¼ÆËã³ö¼ÓÈÈ»ØÂ·Çý¶¯Öµ  Ã¿1Ãë¹¤×÷Ò
             -»´Î
2899          static void Controler_Calc(void) //Éè¶¨ÎÂ¶È×î¸ß400,×îµÍ000,Êµ¼Ê0-800,  
2900          {
2901   1      
2902   1        INT Vlaue1,tmp;
2903   1        static const INT Controler_Kp = 40;//±ÈÀýÏµÊý 5¶ÈÎª1500;1¶ÈÎª300;0.1¶ÈÎª30
2904   1        static const INT Controler_Ki = 8;//»ý·ÖÏµÊý
2905   1        static const INT Controler_Kd = 20;//Î¢·ÖÏµÊý   
2906   1      
2907   1        if(Controler_temp.Ek > 100)//10¶ÈÎª¼«ÏÞ 
2908   1        {
2909   2          Controler_temp.Ek = 100;
2910   2        }
2911   1        if(Controler_temp.Ek < -100)
2912   1        {
2913   2          Controler_temp.Ek = -100;
2914   2        }
2915   1        
2916   1        Controler_temp.Sum_error += Controler_temp.Ek;//Îó²î×ÜÁ¿
2917   1        if(Controler_temp.Sum_error > 3500) //0.1¶ÈÄÚ×î¶àÊÇ250Ò»ÖÜÆÚ
2918   1        {
2919   2          Controler_temp.Sum_error = 3500;
2920   2        }
2921   1        if(Controler_temp.Sum_error < -3500)
2922   1        {
2923   2          
2924   2        }
2925   1        Vlaue1 = Controler_Kp * Controler_temp.Ek;//±ÈÀý ×î´ó100*30=3000;  Îó²î*±ÈÀýÏµÊý(¼Ù¶¨Ïà²î5¶È¼´50*25=1250)
2926   1        
2927   1        tmp = Controler_temp.Sum_error * Controler_Ki / 50; //»ý·Ö ×î´ó3000*2/100=60,Ò»¸ö¼ÓÈÈÖÜÆÚÊÇ250´Î  250*5/1
             -5*3=250;
2928   1        Vlaue1 += tmp;
2929   1        tmp = (Controler_temp.Ek - (2 * Controler_temp.Ek1) + Controler_temp.Ek2) * Controler_Kd;//Î¢·Ö 
2930   1        Controler_temp.Sum_error = Controler_temp.Sum_error + tmp;//2015-06-16 °ÑÎ¢·Ö¼ÆÈë»ý·ÖºÍ
2931   1        Vlaue1 += tmp;
2932   1        Controler_temp.Uk = Vlaue1;// Controler_temp.Uk1 + Vlaue1;       // ½á¹û /100×î´óÎª250´Î
2933   1        if(Controler_temp.Uk > 780) 
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 49  

2934   1        {
2935   2          Controler_temp.Uk = 780;
2936   2        }
2937   1        else if(Controler_temp.Uk < 0)
2938   1        {
2939   2          Controler_temp.Uk = 0;//²»ÄÜÎª¸ºÊý
2940   2        }
2941   1        else
2942   1        {
2943   2          //do nothing
2944   2        }
2945   1      
2946   1        Controler_temp.Uk /= 4;//×î¸ß190;   
2947   1          
2948   1        Controler_temp.Ek2 = Controler_temp.Ek1;        // ±£´æÐÂµÄK-1´ÎÊäÈëÖµ
2949   1        Controler_temp.Ek1 = Controler_temp.Ek;
2950   1      }
2951          
2952          
2953          //¼ÓÈÈÅÌÇý¶¯µÄControlerËã·¨--- ¸ù¾Ý¼ÓÈÈÅÌµÄÄ¿±êÎÂ¶ÈºÍÊµ¼ÊÎÂ¶È£¬¼ÆËã³ö¼ÓÈÈ»ØÂ·Çý¶¯Öµ  Ã¿1Ãë¹¤×÷Ò»´Î
2954          static void HeatPlate_Controler_Calc(void) //Éè¶¨ÎÂ¶È×î¸ß400,×îµÍ000,Êµ¼Ê0-800,  
2955          {
2956   1      
2957   1        INT Vlaue1,tmp;
2958   1      //  uint16_t  Val_Calc;
2959   1        static const INT Controler_Kp2 = 38;//±ÈÀýÏµÊý //±ÈÀýÏµÊý 10¶ÈÎª4000/20=200;1¶ÈÎª400/20=20;0.1¶ÈÎª2
2960   1        static const INT Controler_Ki2 = 8;//»ý·ÖÏµÊý
2961   1        static const INT Controler_Kd2 = 20;//Î¢·ÖÏµÊý  
2962   1      
2963   1        if(Controler_temp2.Ek > 100)//10¶ÈÎª¼«ÏÞ 
2964   1        {
2965   2          Controler_temp2.Ek = 100;
2966   2        }
2967   1        if(Controler_temp2.Ek < -100)
2968   1        {
2969   2          Controler_temp2.Ek = -100;
2970   2        }
2971   1        
2972   1        Controler_temp2.Sum_error += Controler_temp2.Ek;//Îó²î×ÜÁ¿
2973   1        if(Controler_temp2.Sum_error > 3500) //0.1¶ÈÄÚ×î¶àÊÇ250Ò»ÖÜÆÚ
2974   1        {
2975   2          Controler_temp2.Sum_error = 3500;
2976   2        }
2977   1        if(Controler_temp2.Sum_error < -3500)
2978   1        {
2979   2          Controler_temp2.Sum_error = -3500;
2980   2        }   
2981   1      
2982   1        Vlaue1 = Controler_Kp2 * Controler_temp2.Ek;//±ÈÀý ×î´ó100*30=3000;  Îó²î*±ÈÀýÏµÊý(¼Ù¶¨Ïà²î5¶È¼´50*25=125
             -0)
2983   1        
2984   1        tmp = Controler_temp2.Sum_error * Controler_Ki2/50; //»ý·Ö ×î´ó3000*2/100=60,Ò»¸ö¼ÓÈÈÖÜÆÚÊÇ250´Î  250*5/1
             -5*3=250;
2985   1        Vlaue1 += tmp;
2986   1        tmp = (Controler_temp2.Ek - (2 * Controler_temp2.Ek1) + Controler_temp2.Ek2) * Controler_Kd2;//Î¢·Ö 
2987   1        Controler_temp2.Sum_error = Controler_temp2.Sum_error + tmp;//2015-06-16 °ÑÎ¢·Ö¼ÆÈë»ý·ÖºÍ
2988   1        Vlaue1 += tmp;
2989   1        Controler_temp2.Uk = Vlaue1;//;       // ½á¹û /100×î´óÎª250´Î
2990   1        if(Controler_temp2.Uk > 780) 
2991   1        {
2992   2          Controler_temp2.Uk = 780;
2993   2        }
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 50  

2994   1        else if(Controler_temp2.Uk < 0)
2995   1        {
2996   2          Controler_temp2.Uk = 0;//²»ÄÜÎª¸ºÊý
2997   2        }
2998   1        else 
2999   1        {
3000   2          //do nothing
3001   2        }
3002   1      
3003   1        Controler_temp2.Uk /= 4;//×î¸ß195;    
3004   1      
3005   1        Controler_temp2.Ek2 = Controler_temp2.Ek1;        // ±£´æÐÂµÄK-1´ÎÊäÈëÖµ
3006   1        Controler_temp2.Ek1 = Controler_temp2.Ek;
3007   1      }
3008          
3009          
3010          //¼ÓÈÈÅÌÄ¿±êÎÂ¶ÈµÄControlerËã·¨--- ¸ù¾Ý³öÆø¿ÚµÄÄ¿±êÎÂ¶ÈºÍÊµ¼ÊÎÂ¶È£¬¼ÆËã³ö¼ÓÈÈÅÌÄ¿±êÎÂ¶ÈµÄÆ«²î, Ã¿20Ãë¹¤×÷Ò
             -»´Î
3011          static void HeatPlateTemp_Aim_Controler_Calc(void) // 
3012          {
3013   1        INT Vlaue1,tmp;
3014   1      //  uint16_t  Val_Calc;
3015   1        static const INT Controler_Kp3 = 40;//±ÈÀýÏµÊý 10¶ÈÎª4000/100=40;1¶ÈÎª400/100=4;0.1¶ÈÎª0.4
3016   1        static const INT Controler_Ki3 = 1;//»ý·ÖÏµÊý
3017   1        static const INT Controler_Kd3 = 80;//Î¢·ÖÏµÊý  
3018   1      
3019   1        if(Controler_temp3.Ek > 100)//10¶ÈÎª¼«ÏÞ 
3020   1        {
3021   2          Controler_temp3.Ek = 100;
3022   2        }
3023   1        if(Controler_temp3.Ek < -100)
3024   1        {
3025   2          Controler_temp3.Ek = -100;
3026   2        }
3027   1        
3028   1        Controler_temp3.Sum_error += Controler_temp3.Ek;//Îó²î×ÜÁ¿
3029   1        if(Controler_temp3.Sum_error > 1000) //0.1¶ÈÄÚ×î¶àÊÇ250Ò»ÖÜÆÚ
3030   1        {
3031   2          Controler_temp3.Sum_error = 1000;
3032   2        }
3033   1        if(Controler_temp3.Sum_error < -1000)
3034   1        {
3035   2          Controler_temp3.Sum_error = -1000;
3036   2        }   
3037   1      
3038   1        Vlaue1 = Controler_Kp3 * Controler_temp3.Ek;//±ÈÀý ×î´ó100*40=4000;  Îó²î*±ÈÀýÏµÊý(¼Ù¶¨Ïà²î5¶È¼´50*25=125
             -0)
3039   1      
3040   1        
3041   1        tmp = Controler_temp3.Sum_error * Controler_Ki3; //»ý·Ö ×î´ó3500*8/100=280
3042   1        Vlaue1 += tmp;
3043   1        //tmp = (Controler_temp3.Ek - (2 * Controler_temp3.Ek1) + Controler_temp3.Ek2) * Controler_Kd3;//Î¢·Ö 
3044   1        tmp = ((2 * Controler_temp3.Ek) - Controler_temp3.Ek1 - Controler_temp3.Ek2) * Controler_Kd3;//Î¢·Ö 
3045   1        Controler_temp3.Sum_error = Controler_temp3.Sum_error + tmp;//°ÑÎ¢·Ö¼ÆÈë»ý·ÖºÍ
3046   1        Vlaue1 += tmp;
3047   1        Controler_temp3.Uk = Vlaue1;// Controler_temp.Uk1 + Vlaue1;       // ½á¹û /100×î´óÎª250´Î
3048   1        if(Controler_temp3.Uk > 5000) 
3049   1        {
3050   2          Controler_temp3.Uk = 5000;
3051   2        }
3052   1        else if(Controler_temp3.Uk < -5000)
3053   1        {
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 51  

3054   2          Controler_temp3.Uk = -5000;//¸ºÊý
3055   2        }
3056   1        else 
3057   1        {
3058   2          //do nothing
3059   2        }
3060   1      
3061   1        Controler_temp3.Uk /= 100;//×î¸ß50;     
3062   1      
3063   1        Controler_temp3.Ek2 = Controler_temp3.Ek1;        // ±£´æÐÂµÄK-1´ÎÊäÈëÖµ
3064   1        Controler_temp3.Ek1 = Controler_temp3.Ek;
3065   1      }
3066          
3067          
3068          //ÎÞ»ØÂ··¢ÈÈË¿Ê±µÄ»¼Õß¶ËÎÂ¶Èµ÷½Ú
3069          static uint16_t NoneWire_Warm_Up_Sec=0;
3070          static void PatientTemp_NoneHeatWire_Adj(void)
3071          {
3072   1        static INT err_sum=0;
3073   1        static INT RT_Temp_Mem = 0;
3074   1        //  static uint16_t WarmUpstate=0;
3075   1        INT Calc_int=0;
3076   1        uint16_t Val_Calc;      
3077   1      
3078   1        {
3079   2          if(CQK_Temp < 330)//Èô³öÆø¿ÚÎÂ¶ÈµÍÓÚ33¶ÈÔòÈ«¹¦ÂÊ¼ÓÈÈ
3080   2          {
3081   3            //Micro_Temp_Val = 190;
3082   3            //ÒÔÏÂÎª·¢ÈÈÅÌÎÂ¶ÈµÄControler¿ØÖÆ
3083   3            
3084   3            Controler_temp2.Ek = 980 - JEP_Temp;//µ±Ç°µÄÎó²îÁ¿ Éè¶¨ÎÂ¶È-µ±Ç°Êµ¼ÊÎÂ¶È
3085   3            HeatPlate_Controler_Calc(); 
3086   3            Val_Calc = (uint8_t)Controler_temp2.Uk; //¼ÆËã³ö¼ÓÈÈÊ±¼ä
3087   3            Micro_Temp_Val = (uint8_t)Val_Calc;//±ãÓÚ¼ÆËã£¬ÒÔÃâ³¬¹ý190½øÈëÖÐ¶Ï  
3088   3            
3089   3            Temp2_Int = JEP_Temp;
3090   3            
3091   3          }
3092   2          else
3093   2          { 
3094   3            NoneWire_Warm_Up_Sec++;
3095   3            if(NoneWire_Warm_Up_Sec > 2000)
3096   3            {
3097   4              NoneWire_Warm_Up_Sec = 2000;
3098   4            }
3099   3            if(NoneWire_Warm_Up_Sec < 3)//00)//10·ÖÖÓÄÚÉè¶¨
3100   3            {
3101   4              //Temp2_Int = 500 + Set_RT_Temp - 300;//·¢ÈÈÅÌÎÂ¶ÈÉè¶¨ÔÚ50¶È-60¶È
3102   4              if(Temp2_Int < (550 + ((Set_RT_Temp - 300)*2)))//·¢ÈÈÅÌÎÂ¶ÈÉè¶¨ÔÚ50¶È-60¶È
3103   4              {
3104   5                Temp2_Int = 550 + ((Set_RT_Temp - 300)*2);
3105   5              } 
3106   4              RT_Temp_Mem = RT_Temp;
3107   4            }
3108   3            else
3109   3            { 
3110   4              err_sum = err_sum + Set_RT_Temp - RT_Temp;//»ý·Ö
3111   4              if(err_sum > 180)
3112   4              {
3113   5                err_sum=180;
3114   5              }
3115   4              else if(err_sum < -180)
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 52  

3116   4              {
3117   5                err_sum=-180;//Ã¿Ãë10¶È(100)£¬30000/100=300,¼´Îª5·ÖÖÓÊý¾Ý
3118   5              }
3119   4              else 
3120   4              {
3121   5                //do nothing
3122   5              }
3123   4              //if((RT_Temp - Set_RT_Temp) >= 1){if(err_sum > 0)err_sum = 0;}//´ïµ½Éè¶¨ÎÂ¶È£¬Îó²î²»ÄÜÎªÕý
3124   4              //else if((Set_RT_Temp - RT_Temp) >= 1){if(err_sum < 0)err_sum = 0;}//Î´´ïµ½Éè¶¨ÎÂ¶È£¬Îó²î²»ÄÜÎª¸º
3125   4              
3126   4              if((Work_State != UI_STATE_SCREENSAVER_MODE)&&(Test_Mode_Dis_Jrp_Ctl == 1))
3127   4              { //8±íÊ¾¸ßÎ»Îª0Ò²ÏÔÊ¾,0±íÊ¾·Çµþ¼ÓÏÔÊ¾ ³öÆø¿Ú
3128   5                Back_Color=WHITE18;
3129   5                if(err_sum >=0)
3130   5                {
3131   6                  LCD_ShowxNum(220,10,16,1,1,0x80,BLACK18); //1-±íÊ¾ÎªÕýÊý
3132   6                }
3133   5                else
3134   5                {
3135   6                  LCD_ShowxNum(220,10,16,1,0,0x80,BLACK18); //0-±íÊ¾Îª¸ºÊý
3136   6                }           
3137   5                LCD_ShowxNum(220,20,16,5,(u32)(abs(err_sum)),0x80,BLACK18); //·¢ÈÈÅÌ¼ÓÈÈµÄÄ£Ê½ÏÔÊ¾
3138   5              }           
3139   4      
3140   4              NoneWire_Heat_Sec++;
3141   4              if(NoneWire_Heat_Sec >= 180)//3·ÖÖÓµ÷ÕûÒ»´ÎÎÂ¶È
3142   4              {
3143   5                NoneWire_Heat_Sec = 0;//-Temp2_Int
3144   5                
3145   5                Calc_int = err_sum;
3146   5                //if(Calc_int > 6000)Calc_int=6000;
3147   5                //else if(Calc_int< -6000)Calc_int=-6000;//Ã¿Ãë5¶È(50)£¬2·ÖÖÓÊý¾ÝÎª6000
3148   5                
3149   5                Temp2_Int = Temp2_Int + ((Set_RT_Temp - RT_Temp)/6) + ((RT_Temp_Mem-RT_Temp)/2) + (Calc_int/40);//(40
             -0-300)/10
3150   5                //if(Temp2_Int > 1050)Temp2_Int = 1050;
3151   5                if(Temp2_Int > 980)
3152   5                {
3153   6                  Temp2_Int = 980;
3154   6                }
3155   5      
3156   5                RT_Temp_Mem = RT_Temp;
3157   5              }
3158   4            }           
3159   3      
3160   3            //ÒÔÏÂÎª·¢ÈÈÅÌÎÂ¶ÈµÄControler¿ØÖÆ
3161   3            Controler_temp2.Ek = Temp2_Int - JEP_Temp;//µ±Ç°µÄÎó²îÁ¿ Éè¶¨ÎÂ¶È-µ±Ç°Êµ¼ÊÎÂ¶È
3162   3            HeatPlate_Controler_Calc(); 
3163   3            Val_Calc = (uint8_t)Controler_temp2.Uk; //¼ÆËã³ö¼ÓÈÈÊ±¼ä
3164   3            if(RT_Temp > (Set_RT_Temp + 10))
3165   3            {
3166   4              Micro_Temp_Val = 0;//³¬¹ý1¶È 
3167   4              
3168   4            }
3169   3            else  
3170   3            {
3171   4              Micro_Temp_Val = (uint8_t)Val_Calc;//±ãÓÚ¼ÆËã£¬ÒÔÃâ³¬¹ý190½øÈëÖÐ¶Ï  
3172   4            }
3173   3          }       
3174   2        }
3175   1      }
3176          
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 53  

3177          //Õý³£ÔËÐÐ½çÃæ,°´ÏÂÈ·ÈÏ¼üÈ·¶¨»ØÂ·µÄÄ£Ê½
3178          void WireInOut_State_Confirm(void)
3179          {
3180   1        if((WireIn_State > 0) && (WireOut_State > 0)) //Ë«¹Ü¼ÓÈÈÄ£Ê½
3181   1        {
3182   2          Wire_Mode_Sel = Wire_Sel_Double;  
3183   2        } 
3184   1        else if((WireIn_State > 0) && (WireOut_State == 0)) //µ¥¹Ü¼ÓÈÈÄ£Ê½
3185   1        {
3186   2          Wire_Mode_Sel = Wire_Sel_In_Only; 
3187   2        }
3188   1        else if((WireIn_State == 0) && (WireOut_State == 0)) //ÎÞ¼ÓÈÈË¿Ä£Ê½
3189   1        {
3190   2          Wire_Mode_Sel = Wire_Sel_None;  
3191   2        } 
3192   1        else 
3193   1        {
3194   2          //do nothing
3195   2        }
3196   1      }
3197          
3198          void HeaterPlateWireDriveFbTask(void)//16
3199          {
3200   1        static uint8_t Micro_Temp_CLK = 0;
3201   1        static uint8_t    Check_WireInTimes = 0;
3202   1        static uint8_t    Check_WireOutTimes =0 ;
3203   1        static uint8_t WireIn_FB_Count = 0;     //¼ì²â¼ÓÈÈÏßIn·´À¡ÐÅºÅ
3204   1        static uint8_t WireOut_FB_Count = 0;     //¼ì²â¼ÓÈÈÏßOut·´À¡ÐÅºÅ
3205   1        static uint8_t NoHpCheck_Times = 0;//ÎÞ¼ÓÈÈÅÌµÄ´ÎÊý.
3206   1        
3207   1        Micro_Temp_CLK++;
3208   1        if(Micro_Temp_CLK > 200)//Ê±»ù
3209   1        {   
3210   2          Micro_Temp_CLK = 0;
3211   2      
3212   2          //Ã¿¸öÖÜÆÚ¼ì²â¼ÓÈÈÅÌÊÇ·ñ´æÔÚ
3213   2           HP_CNT_Int_End_Rem = HP_CNT_Int;
3214   2          if(HP_CNT_Int < 1)//Î´¼ì²âµ½
3215   2          {
3216   3            NoHpCheck_Times++;
3217   3            if(NoHpCheck_Times >=2)
3218   3            {
3219   4              NoHpCheck_Times = 2;
3220   4              HeaterPlate_State=0; //Î´¼ì²âµ½¼ÓÈÈÅÌ
3221   4            }
3222   3          }
3223   2          else
3224   2          {
3225   3            NoHpCheck_Times = 0;
3226   3            HeaterPlate_State=1; //¼ì²â¼ÓÈÈÅÌ´æÔÚ         
3227   3          }
3228   2          HP_CNT_Int = 0;//ÇåÁã
3229   2        }
3230   1         
3231   1      //¼ÓÈÈÅÌÇý¶¯  
3232   1        if (Micro_Temp_Val>Micro_Temp_CLK)
3233   1        {
3234   2          Heat_JRP_Port=1;
3235   2        }  
3236   1        else
3237   1        {
3238   2          Heat_JRP_Port=0;
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 54  

3239   2        }
3240   1        
3241   1      //INSP½øÖ§Æø¼ÓÈÈÇý¶¯ºÍ¼ì²â
3242   1        if (Micro_Temp_In>Micro_Temp_CLK)
3243   1        {
3244   2          Heat_WireIn_Port=1;
3245   2          Heat_WIRE_EN_OUT=0;//·ÀÖ¹µ¥Ò»¹ÊÕÏ 
3246   2        }
3247   1        else  //²»¼ÓÈÈÊ±µÄ¼ì²â
3248   1        {     
3249   2          if(Heat_WireIn_Port!=0)
3250   2          {
3251   3            Heat_WireIn_Port=0;
3252   3            Heat_WIRE_EN_OUT=1;//·ÀÖ¹µ¥Ò»¹ÊÕÏ     
3253   3            Check_WireInTimes=0;
3254   3            WireIn_FB_Count=0;
3255   3          }
3256   2          else
3257   2          {
3258   3            Check_WireInTimes++;
3259   3            if(WireIn_Exist_Port==0)
3260   3            {
3261   4              WireIn_FB_Count++;
3262   4            }       
3263   3            if(Check_WireInTimes>4)
3264   3            {
3265   4              if(WireIn_FB_Count<3)   //Á¬Ðø¼ì²âµ½Îå´Î²»¼ÓÈÈ±¨´í
3266   4              {
3267   5                WireIn_State=0; //Î´¼ì²âµ½·¢ÈÈË¿             
3268   5              }
3269   4              else
3270   4              {            
3271   5                WireIn_State=1; //Ã»¼ÓÈÈ£¬´ú±í¼ì²âµ½·¢ÈÈË¿
3272   5              }
3273   4              Check_WireInTimes=0;
3274   4              WireIn_FB_Count=0;
3275   4            }
3276   3          }
3277   2        }     
3278   1        
3279   1      //EXP³öÖ§Æø¼ÓÈÈÇý¶¯ºÍ¼ì²â
3280   1        if (Micro_Temp_Out>Micro_Temp_CLK)
3281   1        {
3282   2          Heat_WireOut_Port=1;
3283   2          Heat_WIRE_EN_OUT = 0;//·ÀÖ¹µ¥Ò»¹ÊÕÏ   
3284   2        }
3285   1        else
3286   1        {
3287   2          if(Heat_WireOut_Port!=0)
3288   2          {
3289   3            Heat_WireOut_Port=0;
3290   3            Heat_WIRE_EN_OUT = 1;//·ÀÖ¹µ¥Ò»¹ÊÕÏ   
3291   3            Check_WireOutTimes=0;
3292   3            WireOut_FB_Count=0;
3293   3          }
3294   2          else
3295   2          {
3296   3            Check_WireOutTimes++;
3297   3            if(WireOut_Exist_Port==0)
3298   3            {
3299   4              WireOut_FB_Count++;
3300   4            }       
C51 COMPILER V9.52.0.0   ACTIVITYFUNCTIONS                                                 04/08/2019 16:41:44 PAGE 55  

3301   3            if(Check_WireOutTimes>4  )
3302   3            {
3303   4              if(WireOut_FB_Count<3)   //Á¬Ðø¼ì²âµ½Îå´Î²»¼ÓÈÈ±¨´í
3304   4              {
3305   5                WireOut_State=0; //Ã»¼ÓÈÈ£¬´ú±í¼ì²âµ½·¢ÈÈË¿
3306   5              }
3307   4              else
3308   4              {
3309   5                WireOut_State=1;
3310   5              }
3311   4              Check_WireOutTimes=0;
3312   4              WireOut_FB_Count=0;
3313   4            }
3314   3          }
3315   2        }  
3316   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  16708    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    275      75
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
